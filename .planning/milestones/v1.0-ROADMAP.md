# Milestone v1.0: Audit Cleanup & Modernization

**Status:** âœ… SHIPPED 2026-02-01
**Phases:** 1-7
**Total Plans:** 22

## Overview

This roadmap transformed the Z-Library MCP server from a C+ graded codebase into a clean, current, maintainable foundation. Seven phases followed a strict dependency chain: establish integration safety net, upgrade dependencies (low-risk then high-risk), decompose the Python monolith, port unmerged features, document the stable result, and migrate to EAPI JSON endpoints.

## Phases

### Phase 1: Integration Test Harness

**Goal**: Developers can verify the Node.js-to-Python bridge works end-to-end before and after every change
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: Integration tests for all 11 tools (recorded + live modes) and BRK-001 investigation
- [x] 01-02: Docker E2E test with MCP SDK Client

### Phase 2: Low-Risk Dependency Upgrades

**Goal**: All non-SDK dependencies are current, security vulnerabilities are resolved, and the codebase is ready for the MCP SDK upgrade
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: Upgrade Zod to 3.25.x bridge + npm/pip security audit fixes
- [x] 02-02: Fix bare except handler + specify lxml parser in all BS4 calls

### Phase 3: MCP SDK Upgrade

**Goal**: The MCP server runs on the latest SDK with protocol compatibility verified against a real MCP client
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01: Upgrade SDK to 1.25.x+ and rewrite src/index.ts to McpServer
- [x] 03-02: Update test mocks for McpServer + manual client verification

### Phase 4: Python Monolith Decomposition

**Goal**: rag_processing.py is decomposed into domain modules while all existing imports and tests continue working unchanged
**Depends on**: Phase 3
**Plans**: 5 plans

Plans:
- [x] 04-01: Extract utils, detection, and leaf OCR modules into lib/rag/
- [x] 04-02: Extract quality, processors, orchestrator; finalize facade
- [x] 04-03: Clean BUG-X FIX comments, convert DEBUG to logging, update Dockerfile
- [x] 04-04: Gap closure: decompose oversized footnotes.py and pipeline.py into submodules
- [x] 04-05: Gap closure: extract process_pdf from orchestrator.py

### Phase 5: Feature Porting & Branch Cleanup

**Goal**: Valuable unmerged features from get_metadata branch are available on master, and all stale branches are cleaned up
**Depends on**: Phase 4
**Plans**: 3 plans

Plans:
- [x] 05-01: Enhance metadata tool (tiered response + include param) and filename disambiguation
- [x] 05-02: Enrich search results with explicit title/author fields
- [x] 05-03: Delete all 7 stale remote branches

### Phase 6: Documentation & Quality Gates

**Goal**: All documentation reflects the current codebase state, and quality gates prevent future drift
**Depends on**: Phase 5
**Plans**: 2 plans

Plans:
- [x] 06-01: Update all stale docs, triage ISSUES.md, backfill 3 ADRs, add Last Verified timestamps
- [x] 06-02: Install Husky + lint-staged hooks, create GitHub Actions CI, Python version check

### Phase 7: EAPI Migration

**Goal**: All Z-Library operations use EAPI JSON endpoints instead of HTML scraping, restoring full MCP server functionality
**Depends on**: Phase 5
**Priority**: ðŸ”´ URGENT â€” Cloudflare blocking all HTML requests
**Plans**: 6 plans

Plans:
- [x] 07-01: Create EAPIClient class + response normalization (foundation)
- [x] 07-02: Rewrite vendored fork (libasync, abs, profile, booklists) to use EAPI
- [x] 07-03: Migrate lib/ tools (term, author, booklist, metadata) to use EAPI
- [x] 07-04: Wire python_bridge, update test mocks, add health check, verify E2E
- [x] 07-05: Gap closure: migrate integration tests from HTML to EAPI imports
- [x] 07-06: Gap closure: add Cloudflare detection to health check

---

## Milestone Summary

**Key Decisions:**
- Zod 3.25.x bridge (not full Zod 4) â€” minimize disruption
- McpServer class with server.tool() registration pattern
- Facade-aware dependency access (_get_facade()) for zero-breakage decomposition
- Manual port over rebase for get_metadata (75-commit drift)
- Filter metadata in TypeScript, not Python
- Keep AsyncZlib for downloads (EAPI download needs legacy client)
- Lazy httpx client with recreation on re-auth

**Issues Resolved:**
- ISSUE-API-001: Cloudflare blocking â€” resolved via EAPI migration
- BRK-001: Download+RAG combined workflow â€” investigated, code path exists
- 15 npm/pip security vulnerabilities fixed
- Pre-commit hook permissions fixed

**Issues Deferred:**
- env-paths v4 (requires Node 20+, project on Node 18)
- Full Zod 4 migration (breaking changes too extensive for cleanup scope)
- Docker numpy/Alpine compilation issue (pre-existing)

**Technical Debt Incurred:**
- EAPI has no booklist or full-text search endpoints (graceful degradation)
- Terms, booklists, IPFS CIDs return empty defaults via EAPI
- 1 pre-existing test failure (paths.test.js)

---

_For current project status, see .planning/PROJECT.md_
