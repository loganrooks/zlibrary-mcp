---
phase: 09-margin-detection
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - __tests__/python/test_margin_integration.py
autonomous: true

must_haves:
  truths:
    - "A PDF with margin content produces markdown where body text is clean (no leaked margin artifacts)"
    - "Stephanus references appear as {{stephanus: NNNx}} annotations in output"
    - "Bekker references appear as {{bekker: NNNNxN}} annotations in output"
    - "Line numbers appear as {{line_number: N}} annotations in output"
    - "Generic margin notes appear as {{margin: text}} annotations in output"
    - "PDFs without margin content produce identical output to before (no regression)"
  artifacts:
    - path: "__tests__/python/test_margin_integration.py"
      provides: "Integration tests using mock PDFs to verify end-to-end margin detection pipeline"
  key_links:
    - from: "__tests__/python/test_margin_integration.py"
      to: "lib/rag/orchestrator_pdf.py"
      via: "process_pdf call with mock PDF containing margin blocks"
      pattern: "process_pdf|_format_pdf_markdown"
---

<objective>
Create integration tests that verify the full margin detection pipeline works end-to-end: PDF in, clean markdown with annotations out.

Purpose: Validate that Plans 01 and 02 compose correctly and satisfy all MARG requirements. Tests exercise the full path from orchestrator through detection to formatted output.

Output: Integration test file proving the pipeline works. This is the final verification that Phase 9 success criteria are met.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-margin-detection/09-01-SUMMARY.md
@.planning/phases/09-margin-detection/09-02-SUMMARY.md

@lib/rag/orchestrator_pdf.py
@lib/rag/processors/pdf.py
@lib/rag/detection/margins.py
@lib/rag/detection/margin_patterns.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration tests for margin detection pipeline</name>
  <files>__tests__/python/test_margin_integration.py</files>
  <action>
Create integration tests that construct mock PyMuPDF page objects with known block layouts and verify the full pipeline produces correct markdown output.

**Test scenarios:**

1. **Scholarly PDF with Stephanus margins**: Mock page with body blocks at x=72-540 and margin blocks at x=10-60 containing "231a", "231b". Verify output contains `{{stephanus: 231a}}` and `{{stephanus: 231b}}` adjacent to correct body paragraphs. Verify body text has NO "231a" or "231b" leaked.

2. **Scholarly PDF with Bekker margins**: Mock page with margin blocks containing "1094a1", "1094a15". Verify `{{bekker: 1094a1}}` appears in output.

3. **Poetry with line numbers**: Mock page with left-margin blocks containing "5", "10", "15", "20". Verify `{{line_number: 5}}` etc. in output. Body text is clean poetry lines.

4. **Generic marginal notes**: Mock page with right-margin block containing "cf. Republic 514a". Verify `{{margin: cf. Republic 514a}}` in output.

5. **Two-column layout**: Mock page with two text columns (blocks at x=72-290 and x=310-540). Verify NO false margin detection — both columns treated as body text.

6. **PDF without margins**: Mock page with all blocks in body zone. Verify output has no `{{` annotations. This tests backward compatibility.

7. **Scan artifact filtering**: Mock page with margin-zone blocks that are single characters or very narrow (<10pt). Verify they are NOT included as annotations.

**Implementation approach:**
- Use `unittest.mock.MagicMock` for PyMuPDF page objects
- Set `page.rect` to standard A4 (595x842)
- Construct block dicts matching PyMuPDF structure (see research: type, bbox, lines, spans)
- Call `_format_pdf_markdown` directly with pre-computed `margin_blocks` from `detect_margin_content`
- Assert on output markdown string content

Run: `uv run pytest __tests__/python/test_margin_integration.py -v`
  </action>
  <verify>
```bash
# Integration tests pass
uv run pytest __tests__/python/test_margin_integration.py -v

# ALL tests pass (full regression check)
uv run pytest __tests__/python/ -v --timeout=120
```
  </verify>
  <done>Integration tests prove: (1) margin content appears as typed annotations, (2) body text is clean, (3) two-column layouts are not misclassified, (4) PDFs without margins are unaffected, (5) scan artifacts are filtered.</done>
</task>

<task type="auto">
  <name>Task 2: Verify phase success criteria and fix any issues</name>
  <files>lib/rag/detection/margins.py, lib/rag/processors/pdf.py</files>
  <action>
Run the full test suite. If any integration test fails, diagnose and fix the issue in the detection or formatting code. This task is a buffer for fixing integration bugs found by Task 1.

Check each success criterion from the roadmap:
1. "PDFs with margin content produce markdown where body text contains no leaked margin artifacts" — verified by integration test scenarios 1-4
2. "Stephanus references and Bekker references appear as structured annotations" — verified by scenarios 1-2
3. "Line numbers from poetry, legal texts, and critical editions are detected and separated" — verified by scenario 3
4. "Margin zone widths adapt per document without manual configuration" — verified by statistical inference (no hardcoded widths), tested in Plan 01
5. "Marginal notes and cross-references are preserved in output" — verified by scenario 4

If all tests pass on first run, this task is a no-op (mark done immediately).
  </action>
  <verify>
```bash
# Full test suite green
uv run pytest __tests__/python/ -v --timeout=120

# Spot check: no hardcoded margin pixel values in margins.py
grep -n "margin.*=.*[0-9][0-9]" lib/rag/detection/margins.py | grep -v "BIN_SIZE\|fallback\|tolerance\|pct\|zone\|env" || echo "No hardcoded margins found"
```
  </verify>
  <done>All 5 phase success criteria verified by passing integration tests. No hardcoded margin thresholds in detection code.</done>
</task>

</tasks>

<verification>
```bash
# Complete test suite passes
uv run pytest __tests__/python/ -v --timeout=120

# TypeScript build passes
cd /home/rookslog/workspace/projects/zlibrary-mcp && npm run build

# Verify annotation format in integration test output
uv run pytest __tests__/python/test_margin_integration.py -v -s 2>&1 | grep -E "\{\{(stephanus|bekker|line_number|margin):" || echo "Check test output manually"
```
</verification>

<success_criteria>
- All integration tests pass proving end-to-end margin detection
- All unit tests from Plan 01 still pass (no regressions)
- All pre-existing tests pass (no pipeline regressions)
- Each of the 5 roadmap success criteria is covered by at least one test
- TypeScript build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-margin-detection/09-03-SUMMARY.md`
</output>
