# MCP Server Implementation Comparison Report

**Date:** 2025-04-14

**Objective:** Compare the setup of `zlibrary-mcp` with other working MCP server implementations (e.g., `fetcher-mcp`, `brave-search-mcp`) to identify potential reasons for tool listing failures and client-side errors (INT-001) in `zlibrary-mcp`.

## Comparison Points

| Feature                     | `zlibrary-mcp` (`index.js`, `package.json`)                                                                 | `mcp-server-sqlite-npx` (`src/index.ts`)        | `zcaceres/fetch-mcp` (`src/index.ts`, `package.json`) | `@mcp/server-brave-search` (`index.ts`, `package.json`) | `@mcp/server-puppeteer` (`index.ts`, `package.json`) | `@mcp/server-filesystem` (`index.ts`, `package.json`) | Key Differences & Notes                                                                                                                                                                                                                                                                                             |
| :-------------------------- | :---------------------------------------------------------------------------------------------------------- | :---------------------------------------------- | :---------------------------------------------------- | :------------------------------------------------------ | :--------------------------------------------------- | :---------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. SDK Version**          | `@mcp/sdk`: `1.8.0`                                                                                         | `@mcp/sdk`: (Assumed >=1.8.0)                   | `@mcp/sdk`: `^1.0.4`                                  | `@mcp/sdk`: `1.0.1`                                     | `@mcp/sdk`: `1.0.1`                                  | `@mcp/sdk`: `0.5.0`                                   | `zlibrary-mcp` uses v1.8.0. `sqlite-npx` likely >=1.8.0. Official examples (`fetch`, `brave`, `puppeteer`) use older v1.0.x. `filesystem` uses very old v0.5.0.                                                                                             |
| **2. Module Type**          | `commonjs`                                                                                                  | `module` (ESM)                                  | `module` (ESM)                                        | `module` (ESM)                                          | `module` (ESM)                                       | `module` (ESM)                                        | **Key Difference:** `zlibrary-mcp` is CJS, all others analyzed are ESM.                                                                                                                                                           |
| **3. SDK Component Import** | `Server`: `require('@mcp/sdk/server/index.js')`<br>`StdioTransport`: `require('@mcp/sdk/server/stdio.js')`<br>`Types`: `require('@mcp/sdk/types.js')` | `import { Server } from '@mcp/sdk/server/index.js'`<br>`import { Stdio... } from '@mcp/sdk/server/stdio.js'`<br>`import { ... } from '@mcp/sdk/types.js'` | `import { Server } from '@mcp/sdk/server/index.js'`<br>`import { Stdio... } from '@mcp/sdk/server/stdio.js'`<br>`import { ... } from '@mcp/sdk/types.js'` | `import { Server } from '@mcp/sdk/server/index.js'`<br>`import { Stdio... } from '@mcp/sdk/server/stdio.js'`<br>`import { ... } from '@mcp/sdk/types.js'` | `import { Server } from '@mcp/sdk/server/index.js'`<br>`import { Stdio... } from '@mcp/sdk/server/stdio.js'`<br>`import { ... } from '@mcp/sdk/types.js'` | `import { Server } from '@mcp/sdk/server/index.js'`<br>`import { Stdio... } from '@mcp/sdk/server/stdio.js'`<br>`import { ... } from '@mcp/sdk/types.js'` | Import paths consistent across CJS/ESM for SDK structure. Instantiation (`new Server`, `new Stdio...`, `server.connect`) similar across versions/types.                                                                           |
| **4. Tool Registration**    | `server.registerCapabilities({ tools: {} })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | `new Server(..., { capabilities: { tools: {} } })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | `new Server(..., { capabilities: { ..., tools: {} } })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | `new Server(..., { capabilities: { tools: {} } })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | `new Server(..., { capabilities: { ..., tools: {} } })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | `new Server(..., { capabilities: { tools: {} } })`<br>`server.setRequestHandler(ListToolsRequestSchema, ...)`<br>`server.setRequestHandler(CallToolRequestSchema, ...)` | All use `setRequestHandler`. Minor differences in capability definition location (constructor vs. method). Functionally equivalent.                                                                                           |
| **5. Schema Provision**     | Zod schemas defined.<br>**Current:** `ListTools` handler returns hardcoded dummy JSON schema.<br>**Intended:** Use `zod-to-json-schema`. | Zod schemas defined.<br>**Uses `zodToJsonSchema(ZodSchema) as ToolInput`** in `ListTools` handler. | **No Zod for inputSchema.**<br>Defines `inputSchema` as **plain object literal** (JSON Schema structure) in `ListTools` handler. | **No Zod for inputSchema.**<br>Defines `inputSchema` as **plain object literal** (JSON Schema structure) in constants, returned by `ListTools` handler. | **No Zod for inputSchema.**<br>Defines `inputSchema` as **plain object literal** (JSON Schema structure) in constants, returned by `ListTools` handler. | Zod schemas defined.<br>**Uses `zodToJsonSchema(ZodSchema) as ToolInput`** in `ListTools` handler (even with SDK 0.5.0). | **Key Differences:** `sqlite-npx` & `filesystem` use `zodToJsonSchema`. Official examples with older SDKs (1.0.x) use manual JSON schema objects. `zlibrary-mcp` uses dummy objects (incorrectly). `zodToJsonSchema` seems the correct approach for Zod projects, confirmed functional even with older SDKs. |
| **6. Result Handling**      | `CallTool` handler validates with Zod `safeParse`.<br>Returns direct result on success.<br>Returns `{ error: { message: '...' } }` on validation/handler error. | Validates with Zod `safeParse`.<br>**Success:** Returns `{ content: [{ type: 'text', text: ... }] }`<br>**Error:** Returns `{ content: [{ type: 'text', text: ... }], isError: true }` | Validates with Zod `parse`.<br>Returns direct result from helper.<br>Throws error on validation/handler error.                                      | Uses type guards (no Zod).<br>**Success:** Returns `{ content: [{ type: 'text', text: ... }], isError: false }`<br>**Error:** Returns `{ content: [{ type: 'text', text: ... }], isError: true }` | Manual validation (no Zod).<br>**Success:** Returns `{ content: [...], isError: false }`<br>**Error:** Returns `{ content: [...], isError: true }` | Validates with Zod `safeParse`.<br>**Success:** Returns `{ content: [{ type: 'text', text: ... }] }`<br>**Error:** Returns `{ content: [{ type: 'text', text: ... }], isError: true }` | **Key Differences:** Return structures vary. `zlibrary-mcp` uses `{ error: ... }`. Most others use `{ content: ..., isError: ... }`. `fetch-mcp` throws errors. Validation methods also differ (Zod vs manual/guards).                                                              |

## Analysis of `zlibrary-mcp` Issues

Based *only* on the `zlibrary-mcp` code and Memory Bank context:

1.  **Tool Listing Failure / INT-001:**
    *   The `ListToolsRequest` handler in `zlibrary-mcp` (lines 240-254) is currently **bypassing `zod-to-json-schema`** and sending a hardcoded, minimal dummy JSON schema (`{ type: "object", properties: {}, description: "..." }`) for *all* tools.
    *   Memory Bank entry `[2025-04-14 17:34:36] - Debug` confirms the server sends a *valid* `ListToolsResponse` structure, but the client still fails (INT-001), suggesting a client-side parsing issue potentially triggered by the *content* of the schema (even if structurally valid JSON).
    *   **Hypothesis:** The client likely expects properly generated JSON schemas. The failure of `zlibrary-mcp` to provide these via `zod-to-json-schema` (instead sending dummy schemas) is the most probable cause of the client-side error (INT-001), even if the overall response structure is valid JSON. The `sqlite-npx` example confirms `zodToJsonSchema` is the correct approach.

2.  **CJS SDK Usage (v1.8.0):**
    *   The import paths (`@mcp/sdk/server/index.js`, `@mcp/sdk/server/stdio.js`, `@mcp/sdk/types.js`) and instantiation (`new Server()`, `new StdioServerTransport()`, `server.connect(transport)`) seem consistent with patterns observed in Memory Bank fixes (`[2025-04-14 10:16:20] - Debug`).

## Potential Fixes / Next Steps for `zlibrary-mcp`

1.  **Restore `zod-to-json-schema`:** **This is the highest priority.** Modify the `ListToolsRequest` handler in `zlibrary-mcp/index.js` to correctly use `zodToJsonSchema` to generate the `input_schema` for each tool, similar to the `sqlite-npx` example. Ensure the `zod-to-json-schema` dependency is correctly imported (`require('zod-to-json-schema').default`).
    ```javascript
    // In zlibrary-mcp/index.js ListTools handler:
    const zodToJsonSchema = require('zod-to-json-schema').default;
    // ...
    const tools = Object.entries(toolRegistry).map(([name, tool]) => {
      // Generate JSON schema from Zod schema
      const jsonSchema = zodToJsonSchema(tool.schema, name); // Adjust options if needed
      return {
        name: name,
        description: tool.description,
        // Use the generated schema (potentially needs type assertion like 'as any' or a specific MCP type if available)
        input_schema: jsonSchema,
      };
    });
    return { tools };
    ```
2.  **Align Result Structure (Optional but Recommended):** Consider modifying the `CallToolRequest` handler in `zlibrary-mcp` to return results in the `{ content: [{ type: 'text', text: ... }] }` format for success and `{ content: [...], isError: true }` for errors, matching the `sqlite-npx` example. This might improve compatibility or adherence to potential implicit MCP standards, although the current `zlibrary-mcp` error structure (`{ error: { message: '...' } }`) is also explicitly mentioned in some SDK documentation/examples.
3.  **Verify CJS/ESM Interop:** Although imports seem correct, double-check that the CJS usage of `zod-to-json-schema` (`require(...).default`) behaves identically to the ESM import in `sqlite-npx`.
4.  **Consult Client Implementation:** If restoring `zodToJsonSchema` doesn't resolve INT-001, further investigation into the client's parsing logic remains necessary, potentially comparing the exact JSON schema output of `zlibrary-mcp` (once fixed) with what the client expects.

## Conclusion

The comparison with `mcp-server-sqlite-npx` strongly suggests that the primary reason for `zlibrary-mcp`'s tool listing failure (INT-001) is its current **failure to provide correctly generated JSON schemas using `zod-to-json-schema`** in the `ListToolsResponse`. Instead, it sends dummy schemas. While `zlibrary-mcp` (CJS) and `sqlite-npx` (ESM) differ in module type, their SDK usage patterns (imports, registration) are largely consistent for v1.8.0. The key actionable difference lies in schema provision. Differences in result handling structure were also noted but are less likely to cause the initial tool listing failure.

**Recommendation:** Restore the use of `zod-to-json-schema` in `zlibrary-mcp`'s `ListToolsRequest` handler, aligning with the `mcp-server-sqlite-npx` and `filesystem` examples, as the immediate next step to resolve the INT-001 error. This approach is confirmed functional across different SDK versions when Zod is used. Manual schema definition is less ideal. Consider aligning the `CallTool` result structure with the `{ content: ..., isError: ... }` pattern for consistency, although this is likely secondary to the schema issue.