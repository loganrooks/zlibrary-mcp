---
phase: 08-infrastructure-modernization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .github/workflows/ci.yml
  - Dockerfile.test
  - .nvmrc
  - src/lib/venv-manager.ts
autonomous: true

must_haves:
  truths:
    - "Project builds and all tests pass on Node 22 LTS"
    - "CI matrix uses Node 22"
    - "Docker test image uses node:22-slim base"
    - "env-paths v4 is installed and importable"
  artifacts:
    - path: "package.json"
      provides: "engines >= 22, env-paths ^4.0.0"
      contains: '"node": ">=22"'
    - path: ".github/workflows/ci.yml"
      provides: "CI with Node 22"
      contains: "node-version: '22'"
    - path: "Dockerfile.test"
      provides: "Docker test with Node 22"
      contains: "node:22-slim"
    - path: ".nvmrc"
      provides: "Local dev Node version"
      contains: "22"
  key_links:
    - from: "package.json"
      to: ".github/workflows/ci.yml"
      via: "Node version alignment"
      pattern: "node-version.*22"
---

<objective>
Upgrade Node.js runtime from 18 to 22 LTS and update env-paths from v3 to v4.

Purpose: Node 22 is active LTS (until April 2027), unlocks env-paths v4 (pure ESM requiring Node 20+), and aligns CI/Docker with current runtime.
Output: All config files targeting Node 22, env-paths v4 installed, tests passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-infrastructure-modernization/08-RESEARCH.md
@package.json
@.github/workflows/ci.yml
@Dockerfile.test
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Node 22 + env-paths v4 in package.json</name>
  <files>package.json, .nvmrc</files>
  <action>
1. In package.json, change `"engines": { "node": ">=18" }` to `"node": ">=22"`.
2. Run `npm install env-paths@4` to upgrade env-paths from 3.0.0 to 4.0.0. env-paths v4 is pure ESM (no API changes, just drops CJS support).
3. Create `.nvmrc` with content `22` for local dev consistency.
4. Run `npm run build` to verify TypeScript compiles cleanly.
5. Run `npm test` to verify all Jest tests pass.
6. Run `uv run pytest` to verify Python tests unaffected.
  </action>
  <verify>
- `npm run build` exits 0
- `npm test` all pass
- `uv run pytest` all pass
- `node -e "import('env-paths').then(m => console.log(m.default('test')))"` prints paths without error
  </verify>
  <done>package.json engines field says >=22, env-paths is 4.x in package-lock.json, all tests green.</done>
</task>

<task type="auto">
  <name>Task 2: Update CI workflow and Docker to Node 22</name>
  <files>.github/workflows/ci.yml, Dockerfile.test</files>
  <action>
1. In `.github/workflows/ci.yml`, change both `node-version: '18'` to `node-version: '22'` (test job and audit job).
2. In `Dockerfile.test`, change `FROM node:20-slim AS base` to `FROM node:22-slim AS base`.
3. Verify CI YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"` (or manual review if PyYAML not available).
4. Build Docker test image locally to verify: `docker build -f Dockerfile.test -t zlibrary-mcp-test . 2>&1 | tail -5` (just build, don't need to run full E2E).
  </action>
  <verify>
- `grep 'node-version' .github/workflows/ci.yml` shows '22' (both occurrences)
- `grep 'node:22' Dockerfile.test` matches the FROM line
- Docker build completes without errors (or at minimum, the Node/npm stages succeed)
  </verify>
  <done>CI and Docker both target Node 22. No references to Node 18 or 20 remain in CI/Docker config.</done>
</task>

</tasks>

<verification>
- `grep -r "node.*18\|node.*20" .github/workflows/ Dockerfile*` returns no matches (all upgraded)
- `npm run build && npm test` passes
- `grep '">=22"' package.json` confirms engines field
</verification>

<success_criteria>
Project builds, all tests pass on Node 22. CI and Docker configs target Node 22. env-paths v4 installed.
</success_criteria>

<output>
After completion, create `.planning/phases/08-infrastructure-modernization/08-01-SUMMARY.md`
</output>
