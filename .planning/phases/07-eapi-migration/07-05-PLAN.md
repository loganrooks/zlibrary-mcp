---
phase: 07-eapi-migration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/python/integration/test_real_zlibrary.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Integration tests import EAPI functions, not deprecated HTML functions"
    - "No BeautifulSoup imports remain in integration tests"
    - "TestHTMLStructureValidation class is removed or rewritten for EAPI"
  artifacts:
    - path: "__tests__/python/integration/test_real_zlibrary.py"
      provides: "EAPI-based integration tests"
      contains: "from enhanced_metadata import get_enhanced_metadata"
  key_links:
    - from: "__tests__/python/integration/test_real_zlibrary.py"
      to: "lib/enhanced_metadata.py"
      via: "import get_enhanced_metadata"
      pattern: "from enhanced_metadata import get_enhanced_metadata"
---

<objective>
Migrate integration tests from deprecated HTML-based imports to EAPI equivalents.

Purpose: Close verification gap 1 — integration tests still import `extract_complete_metadata` (HTML parser) instead of `get_enhanced_metadata` (EAPI). The `TestHTMLStructureValidation` class tests BeautifulSoup parsing of HTML which no longer exists in the EAPI path.
Output: All integration tests use EAPI functions and assertions match EAPI response format.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-eapi-migration/07-VERIFICATION.md
@lib/enhanced_metadata.py
@__tests__/python/integration/test_real_zlibrary.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update integration test imports and remove HTML-based tests</name>
  <files>__tests__/python/integration/test_real_zlibrary.py</files>
  <action>
1. Change line 32 from `from enhanced_metadata import extract_complete_metadata` to `from enhanced_metadata import get_enhanced_metadata`

2. Remove the entire `TestHTMLStructureValidation` class (lines ~582-650). These tests use BeautifulSoup to parse HTML from `zlib_client.search()` which returns raw HTML — this is the old HTML scraping path. EAPI returns JSON, so these tests are invalid. Do NOT rewrite them; the functionality they tested (HTML parsing) no longer exists.

3. In `TestRealMetadataExtraction`, the tests call `python_bridge.get_book_metadata_complete()` which already uses EAPI internally. The following fields are NOT available via EAPI (they were HTML-scraped) and tests asserting them must be skipped:
   - `terms`: not in EAPI — skip with `pytest.mark.skip(reason="Field not available via EAPI — was HTML-scraped")`
   - `booklists`: not in EAPI — skip with same reason
   - `ipfs_cids`: not in EAPI — skip with same reason
   Any test methods that assert only these fields should be skipped. Test methods that assert other EAPI-available fields (title, author, year, extension, filesize, description, rating, language, publisher, isbn) should be kept and updated if assertion shapes differ.

4. In `TestRealAdvancedSearch`: The function `python_bridge.search_advanced()` was likely removed during EAPI migration. Check if `search_advanced` exists as an attribute on python_bridge:
   - First, `grep -r "search_advanced" lib/python_bridge.py` to confirm
   - If `search_advanced` does NOT exist: skip the entire `TestRealAdvancedSearch` class with `@pytest.mark.skip(reason="search_advanced removed during EAPI migration")`
   - If it DOES exist: leave the tests but update any HTML-specific assertions

5. Remove any remaining `from bs4 import BeautifulSoup` imports in this file.

6. Ensure the `zlib_client` fixture still works — it imports `ZLibraryClient` from `lib.client_manager`. Verify this module exists and is EAPI-compatible. If not, update the fixture to use the EAPI client setup pattern from `python_bridge.get_eapi_client()`.
  </action>
  <verify>
Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run python -c "import ast; ast.parse(open('__tests__/python/integration/test_real_zlibrary.py').read()); print('Syntax OK')"`
Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && grep -c 'extract_complete_metadata\|from bs4' __tests__/python/integration/test_real_zlibrary.py` — should return 0
Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && grep 'get_enhanced_metadata' __tests__/python/integration/test_real_zlibrary.py` — should show the import
  </verify>
  <done>Integration test file has zero references to deprecated HTML functions or BeautifulSoup. All imports use EAPI equivalents. EAPI-unavailable fields (terms, booklists, ipfs_cids) are skipped. TestRealAdvancedSearch is skipped if search_advanced was removed. File parses without syntax errors.</done>
</task>

</tasks>

<verification>
- `grep -c 'extract_complete_metadata' __tests__/python/integration/test_real_zlibrary.py` returns 0
- `grep -c 'BeautifulSoup' __tests__/python/integration/test_real_zlibrary.py` returns 0
- `grep 'get_enhanced_metadata' __tests__/python/integration/test_real_zlibrary.py` shows import
- Python syntax check passes
- `uv run pytest __tests__/python/ -k "not integration" --tb=short` — non-integration tests still pass
</verification>

<success_criteria>
Integration tests reference only EAPI functions. No deprecated HTML imports remain. TestHTMLStructureValidation removed. EAPI-unavailable fields skipped. TestRealAdvancedSearch handled based on function existence. File is syntactically valid.
</success_criteria>

<output>
After completion, create `.planning/phases/07-eapi-migration/07-05-SUMMARY.md`
</output>
