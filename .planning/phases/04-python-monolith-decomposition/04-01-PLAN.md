---
phase: 04-python-monolith-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rag/utils/constants.py
  - lib/rag/utils/exceptions.py
  - lib/rag/utils/text.py
  - lib/rag/utils/cache.py
  - lib/rag/utils/header.py
  - lib/rag/utils/__init__.py
  - lib/rag/detection/footnotes.py
  - lib/rag/detection/headings.py
  - lib/rag/detection/toc.py
  - lib/rag/detection/front_matter.py
  - lib/rag/detection/page_numbers.py
  - lib/rag/detection/__init__.py
  - lib/rag/ocr/spacing.py
  - lib/rag/ocr/corruption.py
  - lib/rag/ocr/__init__.py
  - lib/rag/__init__.py
  - lib/rag_processing.py
autonomous: true

must_haves:
  truths:
    - "lib/rag/ directory exists with utils/, detection/, and ocr/ subdirectories"
    - "Each new module has __all__, logger = logging.getLogger(__name__), and module docstring"
    - "All extracted functions are verbatim copies (no signature changes, no refactoring)"
    - "uv run pytest passes with zero test file modifications"
    - "npm test passes (Node.js bridge intact)"
  artifacts:
    - path: "lib/rag/utils/constants.py"
      provides: "SUPPORTED_FORMATS, PROCESSED_OUTPUT_DIR, _PDF_QUALITY_* constants, STRATEGY_CONFIGS"
      contains: "__all__"
    - path: "lib/rag/utils/exceptions.py"
      provides: "TesseractNotFoundError, FileSaveError, OCRDependencyError"
      contains: "__all__"
    - path: "lib/rag/utils/text.py"
      provides: "_slugify, _html_to_text, _apply_formatting_to_text"
      contains: "__all__"
    - path: "lib/rag/utils/cache.py"
      provides: "_TEXTPAGE_CACHE, _get_cached_text_blocks, _clear_textpage_cache"
      contains: "__all__"
    - path: "lib/rag/detection/footnotes.py"
      provides: "All footnote detection functions (~700 lines)"
      contains: "_detect_footnotes_in_page"
    - path: "lib/rag/detection/page_numbers.py"
      provides: "Page number detection and roman numeral conversion"
      contains: "infer_written_page_numbers"
  key_links:
    - from: "lib/rag_processing.py"
      to: "lib/rag/utils/constants.py"
      via: "from lib.rag.utils.constants import *"
      pattern: "from lib.rag"
    - from: "lib/rag/detection/footnotes.py"
      to: "lib/rag/utils/cache.py"
      via: "import for _get_cached_text_blocks"
      pattern: "from lib.rag.utils.cache import"
---

<objective>
Extract leaf-node modules (zero or minimal internal dependencies) from rag_processing.py into lib/rag/ package structure. This covers utils/, detection/, and the dependency-free parts of ocr/ (spacing, corruption).

Purpose: Creates the foundation layer that all higher-level modules will depend on. By extracting leaves first, no circular imports are possible, and each step is independently testable.

Output: lib/rag/ package with utils/, detection/, and ocr/ subdirectories containing verbatim-extracted functions. rag_processing.py imports from new modules and re-exports everything — all tests pass unchanged.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-python-monolith-decomposition/04-RESEARCH.md
@lib/rag_processing.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/rag/ package and extract utils modules</name>
  <files>
    lib/rag/__init__.py
    lib/rag/utils/__init__.py
    lib/rag/utils/constants.py
    lib/rag/utils/exceptions.py
    lib/rag/utils/text.py
    lib/rag/utils/cache.py
    lib/rag/utils/header.py
  </files>
  <action>
Create the lib/rag/ directory structure with __init__.py files.

Extract these groups VERBATIM from rag_processing.py (no signature changes, no refactoring):

**constants.py**: All module-level constants — SUPPORTED_FORMATS, PROCESSED_OUTPUT_DIR, _PDF_QUALITY_THRESHOLD_*, _PDF_QUALITY_MIN_*, STRATEGY_CONFIGS, and any other uppercase constants. Include necessary imports (Path, etc).

**exceptions.py**: TesseractNotFoundError, FileSaveError, OCRDependencyError classes.

**text.py**: _slugify, _html_to_text, _apply_formatting_to_text functions. Include their imports (re, unicodedata, etc).

**cache.py**: _TEXTPAGE_CACHE dict, _get_cached_text_blocks, _clear_textpage_cache functions.

**header.py**: _generate_document_header, _generate_markdown_toc_from_pdf, _find_first_content_page functions.

Each module MUST have:
- Module docstring explaining responsibility
- `import logging` and `logger = logging.getLogger(__name__)`
- `__all__` listing all public names
- All original imports needed by the extracted functions

After extraction, replace the moved code in rag_processing.py with imports from the new modules. Use the SAME names (including underscores) so all existing references work.

Example for constants:
```python
# In rag_processing.py, replace constant definitions with:
from lib.rag.utils.constants import (
    SUPPORTED_FORMATS, PROCESSED_OUTPUT_DIR,
    _PDF_QUALITY_THRESHOLD_VERY_LOW_DENSITY, ...
)
```

Run `uv run pytest` after this task to verify no breakage.
  </action>
  <verify>
    uv run pytest — all Python tests pass
    npm test — all Node.js tests pass
    python -c "from lib.rag_processing import SUPPORTED_FORMATS, TesseractNotFoundError, _slugify" — imports work
  </verify>
  <done>
    lib/rag/utils/ contains 5 modules (constants, exceptions, text, cache, header), each under 500 lines.
    rag_processing.py imports from new modules and all tests pass without modification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract detection and leaf OCR modules</name>
  <files>
    lib/rag/detection/__init__.py
    lib/rag/detection/footnotes.py
    lib/rag/detection/headings.py
    lib/rag/detection/toc.py
    lib/rag/detection/front_matter.py
    lib/rag/detection/page_numbers.py
    lib/rag/ocr/__init__.py
    lib/rag/ocr/spacing.py
    lib/rag/ocr/corruption.py
    lib/rag_processing.py
  </files>
  <action>
Extract detection and dependency-free OCR modules VERBATIM from rag_processing.py:

**detection/footnotes.py** (~700 lines): _detect_footnotes_in_page, _format_footnotes_markdown, _calculate_page_normal_font_size, _is_superscript, _find_definition_for_marker, _find_markerless_content, _footnote_with_continuation_to_dict, _starts_with_marker, _extract_text_from_block, _merge_bboxes, _markers_are_equivalent, and the FootnoteWithContinuation class/namedtuple if present. Import _get_cached_text_blocks from lib.rag.utils.cache.

**detection/headings.py**: _detect_headings_from_fonts, _analyze_font_distribution functions.

**detection/toc.py**: _extract_toc_from_pdf, _extract_and_format_toc, _format_toc_lines_as_markdown, _identify_and_remove_front_matter functions.

**detection/front_matter.py**: _extract_publisher_from_front_matter function.

**detection/page_numbers.py**: _extract_written_page_number, _roman_to_int, _int_to_roman, _is_roman_numeral, _detect_written_page_on_page, infer_written_page_numbers functions.

**ocr/spacing.py**: detect_letter_spacing_issue, correct_letter_spacing functions.

**ocr/corruption.py**: _is_ocr_corrupted function.

Each module MUST have module docstring, logger, __all__.

Detection modules should import from lib.rag.utils as needed (constants, cache, text). Do NOT import from peer detection modules — if footnotes.py and toc.py share code, that shared code should be in utils.

Replace moved code in rag_processing.py with imports from new modules. Keep same function names.

Run full test suite after extraction.

IMPORTANT: Do not change any function signatures. Copy verbatim including all BUG-X FIX comments — comment cleanup happens in plan 04-03.
  </action>
  <verify>
    uv run pytest — all Python tests pass
    npm test — all Node.js tests pass
    python -c "from lib.rag_processing import _detect_footnotes_in_page, _is_ocr_corrupted, infer_written_page_numbers" — imports work
    python -c "from lib.rag_processing import _extract_and_format_toc, _extract_publisher_from_front_matter" — imports work
  </verify>
  <done>
    lib/rag/detection/ contains 5 modules (footnotes up to 700 lines, others under 500).
    lib/rag/ocr/ contains spacing.py and corruption.py.
    rag_processing.py imports from new modules; all tests pass without modification.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `uv run pytest` — all Python tests pass (zero test file modifications)
2. `npm test` — all Node.js tests pass
3. `python -c "from lib import rag_processing"` — module loads without error
4. Every function previously defined in rag_processing.py is still importable from it
5. lib/rag/ contains utils/, detection/, ocr/ with __init__.py files
6. No module exceeds 500 lines (footnotes.py allowed up to 700)
</verification>

<success_criteria>
- lib/rag/ package structure exists with utils/, detection/, ocr/ subdirectories
- All leaf-node functions extracted verbatim with per-module logging and __all__
- rag_processing.py imports and re-exports everything from new modules
- Full test suite passes with zero test file modifications
- No circular imports between new modules
</success_criteria>

<output>
After completion, create `.planning/phases/04-python-monolith-decomposition/04-01-SUMMARY.md`
</output>
