---
phase: 11-body-text-purity
plan: 04
type: tdd
wave: 2
depends_on: ["11-01"]
files_modified:
  - lib/rag/pipeline/compositor.py
  - __tests__/python/test_compositor.py
autonomous: true

must_haves:
  truths:
    - "When multiple detectors claim the same block (overlapping bboxes), the higher-confidence classification wins"
    - "When no detector claims a block, it is classified as BODY (default-to-body bias)"
    - "When max confidence is below threshold (0.6), block stays as BODY regardless of detector claim"
    - "Footnote-margin bbox overlaps are resolved (footnote wins on overlap)"
    - "resolve_conflicts returns a complete mapping of all blocks with final classifications"
  artifacts:
    - path: "lib/rag/pipeline/compositor.py"
      provides: "resolve_conflicts(), compute_bbox_overlap(), classify_page_blocks()"
      contains: "def resolve_conflicts"
    - path: "__tests__/python/test_compositor.py"
      provides: "Unit tests for conflict resolution, overlap detection, body-default behavior"
      contains: "test_body_default"
  key_links:
    - from: "lib/rag/pipeline/compositor.py"
      to: "lib/rag/pipeline/models.py"
      via: "imports BlockClassification, DetectionResult, ContentType"
      pattern: "from.*pipeline.*models.*import"
---

<objective>
Build the compositor that resolves conflicts between detector claims and routes blocks to content types, using TDD to verify recall-biased behavior.

Purpose: The compositor is the core logic that prevents recall loss (body text misclassification) and resolves the footnote-margin double classification problem.
Output: `lib/rag/pipeline/compositor.py` with conflict resolution logic, `__tests__/python/test_compositor.py`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-body-text-purity/11-RESEARCH.md
@.planning/phases/11-body-text-purity/11-01-SUMMARY.md
@lib/rag/pipeline/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — Write failing tests for compositor</name>
  <files>__tests__/python/test_compositor.py</files>
  <action>
Write tests FIRST (RED phase). Create `__tests__/python/test_compositor.py` with:

1. `test_body_default_when_no_claims()` — blocks with no detector claim → ContentType.BODY
2. `test_higher_confidence_wins()` — two detectors claim same bbox, higher confidence wins
3. `test_footnote_wins_on_overlap_tie()` — footnote vs margin at equal confidence, footnote wins (type priority)
4. `test_low_confidence_stays_body()` — detector claims block with confidence 0.4, block stays BODY (below 0.6 threshold)
5. `test_non_overlapping_blocks_independent()` — two detectors claim different blocks, both classifications kept
6. `test_bbox_overlap_detection()` — test compute_bbox_overlap utility (>50% overlap = same block)
7. `test_recall_bias_ambiguous_block()` — ambiguous block (two detectors, both low confidence) → BODY

Each test creates BlockClassification and DetectionResult objects, calls resolve_conflicts(), and asserts the expected output classification.

Run tests — they should all FAIL (compositor doesn't exist yet).

```python
# Test structure example:
def test_body_default_when_no_claims():
    # Page has blocks at these bboxes from raw PDF extraction
    page_blocks = [(72, 100, 500, 120), (72, 130, 500, 150)]
    # No detector produced any classifications for these blocks
    detection_results = []
    classified = classify_page_blocks(page_blocks, detection_results)
    assert all(c.content_type == ContentType.BODY for c in classified)
```
  </action>
  <verify>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp
uv run pytest __tests__/python/test_compositor.py -v 2>&1 | grep -E "FAILED|PASSED|ERROR" | head -10
# All tests should FAIL or ERROR (no implementation yet)
```
  </verify>
  <done>7+ compositor tests written, all failing (RED phase complete)</done>
</task>

<task type="auto">
  <name>Task 2: Implement compositor to pass all tests</name>
  <files>lib/rag/pipeline/compositor.py</files>
  <action>
Implement `lib/rag/pipeline/compositor.py` (GREEN phase):

1. `compute_bbox_overlap(bbox_a, bbox_b) -> float`:
   - Returns overlap ratio (0.0-1.0) as intersection area / min(area_a, area_b)
   - Used to determine if two bboxes refer to the same block

2. `classify_page_blocks(page_blocks: List[Tuple], detection_results: List[DetectionResult], confidence_floor: float = 0.6) -> List[BlockClassification]`:
   - Takes raw page block bboxes and all detection results for that page
   - For each page block, finds which DetectionResult classifications overlap (>50% overlap)
   - If no overlapping classification: assign BODY with confidence 1.0
   - If one classification above confidence_floor: use it
   - If multiple overlapping: pick highest confidence; on tie use type priority (FOOTNOTE > MARGIN > PAGE_NUMBER > HEADER > FOOTER)
   - If best confidence < confidence_floor: assign BODY (recall bias)

3. `resolve_conflicts(all_results: List[DetectionResult], page_blocks_by_page: Dict[int, List[Tuple]]) -> Dict[int, List[BlockClassification]]`:
   - High-level function that calls classify_page_blocks per page
   - Returns dict mapping page_num to list of final BlockClassification

4. Type priority constant:
```python
TYPE_PRIORITY = {
    ContentType.FOOTNOTE: 1,
    ContentType.ENDNOTE: 2,
    ContentType.MARGIN: 3,
    ContentType.PAGE_NUMBER: 4,
    ContentType.HEADER: 5,
    ContentType.FOOTER: 6,
    ContentType.TOC: 7,
    ContentType.FRONT_MATTER: 8,
    ContentType.CITATION: 9,
    ContentType.HEADING: 10,
    ContentType.BODY: 99,
}
```

Run all tests — they should PASS.
  </action>
  <verify>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp
uv run pytest __tests__/python/test_compositor.py -v --tb=short 2>&1 | tail -15
```
  </verify>
  <done>All 7+ compositor tests pass; recall-biased conflict resolution working correctly</done>
</task>

</tasks>

<verification>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp
uv run pytest __tests__/python/test_compositor.py -v
uv run python -c "from lib.rag.pipeline.compositor import resolve_conflicts, classify_page_blocks, compute_bbox_overlap; print('Compositor imports OK')"
```
</verification>

<success_criteria>
- All compositor tests pass
- Default-to-body bias verified: unclaimed blocks → BODY
- Confidence floor verified: low-confidence claims → BODY
- Overlap resolution verified: higher confidence wins, type priority breaks ties
- Footnote-margin overlap: footnote wins (type priority)
</success_criteria>

<output>
After completion, create `.planning/phases/11-body-text-purity/11-04-SUMMARY.md`
</output>
