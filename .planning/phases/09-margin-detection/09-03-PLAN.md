---
phase: 09-margin-detection
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - lib/rag/orchestrator_pdf.py
  - lib/rag/processors/pdf.py
  - lib/rag/detection/__init__.py
  - __tests__/python/test_margin_integration.py
autonomous: true

must_haves:
  truths:
    - "PDFs with margin content produce markdown where body text contains no leaked margin artifacts"
    - "Stephanus references appear as {{stephanus: 231a}} annotations inline with adjacent body text"
    - "Bekker references appear as {{bekker: 1094a1}} annotations inline with adjacent body text"
    - "Line numbers appear as {{line_number: 25}} annotations inline with adjacent body text"
    - "Generic margin notes appear as {{margin: content}} annotations inline with adjacent body text"
    - "Margin detection runs after page number and footnote detection, excluding already-claimed blocks"
    - "Margin annotations do not break existing footnote or page number output"
  artifacts:
    - path: "lib/rag/orchestrator_pdf.py"
      provides: "Margin detection integration into PDF pipeline"
      contains: "detect_margin_zones"
    - path: "lib/rag/processors/pdf.py"
      provides: "Margin annotation insertion in markdown output"
      contains: "margin"
    - path: "__tests__/python/test_margin_integration.py"
      provides: "Integration tests for margin pipeline"
      min_lines: 60
  key_links:
    - from: "lib/rag/orchestrator_pdf.py"
      to: "lib/rag/detection/margins.py"
      via: "detect_margin_zones() call per page"
      pattern: "detect_margin_zones"
    - from: "lib/rag/orchestrator_pdf.py"
      to: "lib/rag/detection/margin_patterns.py"
      via: "classify_margin_blocks() on detected margins"
      pattern: "classify_margin_blocks"
    - from: "lib/rag/processors/pdf.py"
      to: "margin annotation output"
      via: "{{type: content}} markers in markdown"
      pattern: "\\{\\{(stephanus|bekker|line_number|margin):"
---

<objective>
Integrate margin detection and classification into the existing PDF processing pipeline, producing inline `{{type: content}}` annotations in markdown output.

Purpose: Wire 09-01 detection and 09-02 classification into the actual PDF-to-markdown pipeline so margin content appears as structured annotations rather than polluting body text.
Output: Updated orchestrator and processor with margin support, plus integration tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-margin-detection/09-01-SUMMARY.md
@.planning/phases/09-margin-detection/09-02-SUMMARY.md
@lib/rag/orchestrator_pdf.py
@lib/rag/processors/pdf.py
@lib/rag/detection/margins.py
@lib/rag/detection/margin_patterns.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate margin detection into PDF orchestrator</name>
  <files>lib/rag/orchestrator_pdf.py, lib/rag/detection/__init__.py</files>
  <action>
    In orchestrator_pdf.py, add margin detection to the per-page processing flow:

    1. Import detect_margin_zones from lib.rag.detection.margins
    2. Import classify_margin_blocks from lib.rag.detection.margin_patterns
    3. After existing page number and footnote detection, call detect_margin_zones(page, excluded_blocks=already_claimed_blocks)
       - already_claimed_blocks = blocks identified by page_numbers + footnotes detectors
       - This prevents double-detection (pitfall P5 from research)
    4. Call classify_margin_blocks() on the detected margin blocks
    5. Pass the classified margin data to _format_pdf_markdown as a new parameter (e.g., margin_annotations=classified_margins)

    In detection/__init__.py, add margins and margin_patterns to module exports.

    IMPORTANT: Do NOT modify the existing footnote or page number detection logic. Margin detection is additive.
    IMPORTANT: Annotate-don't-remove — margin blocks must be marked, not deleted from the block list. Body text flow must not break. (pitfall P-06 from STATE.md)
  </action>
  <verify>
    ```bash
    cd /home/rookslog/workspace/projects/zlibrary-mcp
    python -c "from lib.rag.detection import detect_margin_zones, classify_margin_blocks"
    uv run pytest __tests__/python/ -k "not test_real" --tb=short -q 2>&1 | tail -5
    ```
    No import errors. Existing tests still pass.
  </verify>
  <done>orchestrator_pdf.py calls margin detection after footnote/page number detection and passes results to formatter</done>
</task>

<task type="auto">
  <name>Task 2: Add margin annotations to markdown output and write integration tests</name>
  <files>lib/rag/processors/pdf.py, __tests__/python/test_margin_integration.py</files>
  <action>
    In processors/pdf.py (_format_pdf_markdown or equivalent formatting function):

    1. Accept new margin_annotations parameter (list of classified margin blocks with body association indices)
    2. During block iteration, after outputting each body block's text, check if any margin annotations are associated with this block index
    3. For each associated annotation, append the appropriate marker:
       - MarginContentType.STEPHANUS → `{{stephanus: 231a}}`
       - MarginContentType.BEKKER → `{{bekker: 1094a1}}`
       - MarginContentType.LINE_NUMBER → `{{line_number: 25}}`
       - MarginContentType.MARGIN → `{{margin: content text}}`
    4. Margin markers go on a new line after the body text line they're associated with
    5. If margin_annotations is None or empty, behavior is identical to before (backward compatible)

    Create __tests__/python/test_margin_integration.py:

    1. Test that margin annotations appear in output with correct typed brackets
    2. Test that body text remains clean (no margin content leaked into body lines)
    3. Test backward compatibility: when no margin_annotations passed, output unchanged
    4. Test multiple margin types on same page produce correct mixed output
    5. Use mock fitz.Page objects with synthetic block data (follow existing test patterns)

    IMPORTANT: Escape any literal {{ and }} in margin content text to avoid bracket conflicts.
  </action>
  <verify>
    ```bash
    cd /home/rookslog/workspace/projects/zlibrary-mcp
    uv run pytest __tests__/python/test_margin_integration.py -v
    uv run pytest __tests__/python/ -k "not test_real" --tb=short -q 2>&1 | tail -5
    ```
    New integration tests pass. All existing tests still pass.
  </verify>
  <done>Markdown output contains typed margin annotations inline with body text. Existing pipeline unbroken.</done>
</task>

</tasks>

<verification>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp

# All margin-related tests pass
uv run pytest __tests__/python/test_margin_detection.py __tests__/python/test_margin_patterns.py __tests__/python/test_margin_integration.py -v

# No regressions in existing tests
uv run pytest __tests__/python/ -k "not test_real" --tb=short -q

# Module imports work
python -c "
from lib.rag.detection.margins import detect_margin_zones, MarginDetectionResult
from lib.rag.detection.margin_patterns import classify_margin_content, MarginContentType
print('All imports OK')
"
```
</verification>

<success_criteria>
- PDF pages with margin content produce `{{stephanus: ...}}`, `{{bekker: ...}}`, `{{line_number: ...}}`, or `{{margin: ...}}` annotations
- Annotations appear inline after the body text line they're adjacent to
- No margin content leaks into body text lines
- Existing footnote and page number detection unaffected
- Backward compatible when no margins detected
</success_criteria>

<output>
After completion, create `.planning/phases/09-margin-detection/09-03-SUMMARY.md`
</output>
