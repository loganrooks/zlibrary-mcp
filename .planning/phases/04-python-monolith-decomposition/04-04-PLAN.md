---
phase: 04-python-monolith-decomposition
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rag/detection/footnotes.py
  - lib/rag/detection/footnote_markers.py
  - lib/rag/detection/footnote_core.py
  - lib/rag/detection/__init__.py
  - lib/rag/quality/pipeline.py
  - lib/rag/quality/ocr_stage.py
  - lib/rag/quality/__init__.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "footnotes.py is under 700 lines"
    - "pipeline.py is under 500 lines"
    - "All existing imports from detection/footnotes.py still work"
    - "All existing imports from quality/pipeline.py still work"
    - "All Python tests pass without test file modifications"
  artifacts:
    - path: "lib/rag/detection/footnote_markers.py"
      provides: "Marker matching and definition finding helpers"
      contains: "_find_definition_for_marker"
    - path: "lib/rag/detection/footnote_core.py"
      provides: "Main detection loop and markerless content finding"
      contains: "_detect_footnotes_in_page"
    - path: "lib/rag/quality/ocr_stage.py"
      provides: "Stage 3 OCR recovery and word-finding helper"
      contains: "_stage_3_ocr_recovery"
  key_links:
    - from: "lib/rag/detection/footnotes.py"
      to: "footnote_markers.py, footnote_core.py"
      via: "import and re-export in __all__"
      pattern: "from lib.rag.detection.footnote_"
    - from: "lib/rag/quality/pipeline.py"
      to: "ocr_stage.py"
      via: "import and re-export"
      pattern: "from lib.rag.quality.ocr_stage import"
---

<objective>
Decompose oversized footnotes.py (1175 lines) and pipeline.py (604 lines) into submodules to meet line count targets.

Purpose: Close gap from VERIFICATION.md — Success Criteria #1 requires footnotes.py <= 700 and pipeline.py <= 500.
Output: footnotes.py becomes a thin re-exporter (~250 lines) backed by footnote_markers.py and footnote_core.py. pipeline.py drops below 500 by extracting OCR stage to ocr_stage.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-python-monolith-decomposition/04-VERIFICATION.md
@lib/rag/detection/footnotes.py
@lib/rag/quality/pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split footnotes.py into 3 files</name>
  <files>
    lib/rag/detection/footnote_markers.py
    lib/rag/detection/footnote_core.py
    lib/rag/detection/footnotes.py
    lib/rag/detection/__init__.py
  </files>
  <action>
Create two new submodules and slim down footnotes.py:

**footnote_markers.py** (~320 lines) — marker matching and definition finding:
- Move: `_starts_with_marker` (L77-99), `_extract_text_from_block` (L103-121), `_merge_bboxes` (L125-143), `_markers_are_equivalent` (L147-197), `_find_definition_for_marker` (L201-377), `_find_markerless_content` (L381-558)
- Add imports: `re`, typing, `logging`, `_get_cached_text_blocks` from cache, `_is_ocr_corrupted` from corruption
- Add `__all__`, logger, docstring

**footnote_core.py** (~570 lines) — detection loop and font analysis:
- Move: `_calculate_page_normal_font_size` (L563-601), `_is_superscript` (L605-666), `_detect_footnotes_in_page` (L672-1142)
- `_detect_footnotes_in_page` calls `_find_definition_for_marker`, `_find_markerless_content`, `_starts_with_marker`, `_markers_are_equivalent` — import these from `footnote_markers`
- Also imports `FootnoteWithContinuation`, `is_footnote_incomplete` from `lib.footnote_continuation`, `apply_corruption_recovery` from `lib.footnote_corruption_model`, `classify_note_comprehensive` from `lib.note_classification`
- Add `__all__`, logger, docstring

**footnotes.py** (~250 lines) — becomes re-exporter + small helpers:
- Keep: `_footnote_with_continuation_to_dict` (L42-73), `_format_footnotes_markdown` (L1146-1174)
- Import and re-export everything from `footnote_markers` and `footnote_core`
- Update `__all__` to include all original symbols (existing imports from footnotes.py must not break)
- Keep existing imports at top (FootnoteWithContinuation etc.) that are needed by kept functions

**detection/__init__.py** — no changes needed (footnotes.py still exists at same path with same exports).

CRITICAL: The `__all__` in footnotes.py must list every symbol that was there before. All existing `from lib.rag.detection.footnotes import X` statements must continue to work.
  </action>
  <verify>
    Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && python3 -c "from lib.rag.detection.footnotes import _detect_footnotes_in_page, _format_footnotes_markdown, _find_definition_for_marker, _find_markerless_content, _starts_with_marker, _markers_are_equivalent, _extract_text_from_block, _merge_bboxes, _calculate_page_normal_font_size, _is_superscript, _footnote_with_continuation_to_dict; print('OK')"` returns OK.
    Run: `wc -l lib/rag/detection/footnotes.py lib/rag/detection/footnote_markers.py lib/rag/detection/footnote_core.py` — footnotes.py <= 700, each submodule <= 600.
  </verify>
  <done>footnotes.py is under 700 lines. All original exports still importable from footnotes.py.</done>
</task>

<task type="auto">
  <name>Task 2: Extract OCR stage from pipeline.py</name>
  <files>
    lib/rag/quality/ocr_stage.py
    lib/rag/quality/pipeline.py
    lib/rag/quality/__init__.py
  </files>
  <action>
Create ocr_stage.py and slim pipeline.py:

**ocr_stage.py** (~290 lines) — OCR recovery stage and helper:
- Move: `_stage_3_ocr_recovery` (L247-449, 203 lines), `_find_word_between_contexts` (L452-535, 84 lines)
- Add imports needed by these functions: `io`, `logging`, `os`, `re`, `Path`, `Optional`, `STRATEGY_CONFIGS`, OCR optional imports (pytesseract, pdf2image, PIL), cv2/numpy optional imports, `_get_facade`
- Add `__all__`, logger, docstring

**pipeline.py** (~315 lines) — keep everything else:
- Keep: `_get_facade`, `QualityPipelineConfig`, `_stage_1_statistical_detection`, `_stage_2_visual_analysis`, `_apply_quality_pipeline`
- Import `_stage_3_ocr_recovery` and `_find_word_between_contexts` from `ocr_stage`
- Update `__all__` to still export all original symbols (re-export the moved ones)

**quality/__init__.py** — no changes needed (pipeline.py still exists at same path).

CRITICAL: All existing `from lib.rag.quality.pipeline import X` must continue working. `_apply_quality_pipeline` calls `_stage_3_ocr_recovery` internally — update this call to use the imported version.
  </action>
  <verify>
    Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && python3 -c "from lib.rag.quality.pipeline import QualityPipelineConfig, _stage_1_statistical_detection, _stage_2_visual_analysis, _stage_3_ocr_recovery, _find_word_between_contexts, _apply_quality_pipeline; print('OK')"` returns OK.
    Run: `wc -l lib/rag/quality/pipeline.py lib/rag/quality/ocr_stage.py` — pipeline.py <= 500.
  </verify>
  <done>pipeline.py is under 500 lines. All original exports still importable from pipeline.py.</done>
</task>

</tasks>

<verification>
1. `wc -l lib/rag/detection/footnotes.py` <= 700
2. `wc -l lib/rag/quality/pipeline.py` <= 500
3. `cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run pytest` — all 695 Python tests pass
4. `cd /home/rookslog/workspace/projects/zlibrary-mcp && node --experimental-vm-modules node_modules/jest/bin/jest.js` — all 138 Node.js tests pass
5. No test files modified (git diff should show zero changes in __tests__/)
</verification>

<success_criteria>
- footnotes.py <= 700 lines with all original exports intact
- pipeline.py <= 500 lines with all original exports intact
- All Python and Node.js tests pass without test file modifications
</success_criteria>

<output>
After completion, create `.planning/phases/04-python-monolith-decomposition/04-04-SUMMARY.md`
</output>
