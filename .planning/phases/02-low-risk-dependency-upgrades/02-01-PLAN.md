---
phase: 02-low-risk-dependency-upgrades
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "zod is at 3.25.x and all existing tests pass"
    - "npm audit reports zero high/critical vulnerabilities"
    - "pip-audit reports zero high/critical vulnerabilities"
  artifacts:
    - path: "package.json"
      provides: "Updated zod and security-fixed dependencies"
      contains: "zod.*3.25"
  key_links:
    - from: "package.json"
      to: "src/index.ts"
      via: "zod import still resolves to Zod 3 root API"
      pattern: "from ['\"]zod['\"]"
---

<objective>
Upgrade Zod to 3.25.x bridge version (keeps Zod 3 root API for SDK compatibility) and fix all npm security vulnerabilities.

Purpose: Prepare for Phase 3 full Zod 4 migration while resolving security audit findings now.
Output: Updated package.json/package-lock.json with zero high/critical npm audit findings and Zod 3.25.x installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-low-risk-dependency-upgrades/02-RESEARCH.md

Key research findings:
- Zod 4 is BLOCKED by MCP SDK 1.8.0 (causes `w._parse is not a function`). Use 3.25.x bridge only.
- env-paths v4 requires Node 20+; project on Node 18. Stay on v3.
- DEP-05 (.tsbuildinfo in .gitignore) is ALREADY DONE — skip.
- npm audit shows 5 vulnerabilities (2 high: js-yaml, qs), fixable via `npm audit fix`.
- Keep zod-to-json-schema — it works with Zod 3 root import.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade Zod to 3.25.x and fix npm vulnerabilities</name>
  <files>package.json, package-lock.json</files>
  <action>
1. Run `npm install zod@^3.25.0` to upgrade Zod to the 3.25.x bridge version.
   - This keeps the root `import { z } from 'zod'` as Zod 3 API (SDK compatible).
   - Do NOT change any application code — no imports, no schema changes.
   - Do NOT upgrade env-paths (requires Node 20+, project on Node 18).

2. Run `npm audit fix` to resolve security vulnerabilities (5 total, 2 high: js-yaml, qs).
   - Use semver ranges (^) per project convention.
   - If `npm audit fix` cannot resolve all high/critical, try `npm audit fix --force` cautiously and verify no breaking changes.

3. Verify no regressions:
   - Run `npm run build` — TypeScript must compile cleanly.
   - Run `npm test` — all existing tests must pass.
   - Run `npm audit` — zero high/critical vulnerabilities.
   - Run `npm outdated` — confirm zod shows 3.25.x.
  </action>
  <verify>
```bash
npm run build && npm test
npm audit 2>&1 | grep -E "high|critical|found 0"
npm list zod | grep zod
```
  </verify>
  <done>
- zod is at 3.25.x in package.json
- `npm audit` reports zero high/critical vulnerabilities
- `npm run build` succeeds
- `npm test` passes with zero regressions
  </done>
</task>

<task type="auto">
  <name>Task 2: Run pip-audit on Python dependencies</name>
  <files></files>
  <action>
1. Install pip-audit if not available: `uv pip install pip-audit` or use `uv run pip-audit`.
2. Run `pip-audit` against the project's Python environment:
   ```bash
   cd /home/rookslog/workspace/projects/zlibrary-mcp
   uv run pip-audit
   ```
3. If any high/critical vulnerabilities found:
   - Fix by upgrading the affected package in pyproject.toml.
   - Run `uv sync` to update the lock file.
   - Re-run `uv run pytest` to confirm no regressions.
4. If zero vulnerabilities, just document the clean result.

Note: The vendored zlibrary fork's dependencies will show up if they have vulnerabilities — fix those too.
  </action>
  <verify>
```bash
uv run pip-audit 2>&1 | tail -5
uv run pytest
```
  </verify>
  <done>
- `pip-audit` reports zero high/critical vulnerabilities
- All Python tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
npm run build && npm test
uv run pytest

# Security clean
npm audit
uv run pip-audit

# Zod version correct
npm list zod | grep "3.25"
```
</verification>

<success_criteria>
- zod at 3.25.x with zero code changes (bridge version)
- npm audit: zero high/critical vulnerabilities
- pip-audit: zero high/critical vulnerabilities
- All Node.js and Python tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-low-risk-dependency-upgrades/02-01-SUMMARY.md`
</output>
