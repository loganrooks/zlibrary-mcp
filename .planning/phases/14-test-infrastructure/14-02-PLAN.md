---
phase: 14-test-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - test_files/ground_truth/derrida_footnotes.json
  - test_files/ground_truth/derrida_of_grammatology.json
  - test_files/ground_truth/heidegger_being_time.json
  - test_files/ground_truth/heidegger_22_23_footnotes.json
  - test_files/ground_truth/derrida_footnotes_v2.json
  - test_files/ground_truth/kant_footnotes.json
  - test_files/ground_truth/kant_64_65_footnotes.json
  - test_files/ground_truth/schema.json
  - test_files/ground_truth/schema_v2.json
  - test_files/ground_truth_loader.py
  - __tests__/python/test_schema_validation.py
autonomous: true

must_haves:
  truths:
    - "Only schema_v3.json exists in test_files/ground_truth/ (schema.json and schema_v2.json deleted)"
    - "All 7 ground truth data files validate against schema_v3.json without errors"
    - "A pytest test parametrically validates every ground truth JSON file against v3 schema"
    - "ground_truth_loader.py references schema_v3.json (not schema.json) and checks for metadata field"
  artifacts:
    - path: "test_files/ground_truth/schema_v3.json"
      provides: "Canonical v3 schema definition"
    - path: "__tests__/python/test_schema_validation.py"
      provides: "Parametrized schema validation test"
      contains: "jsonschema"
    - path: "test_files/ground_truth_loader.py"
      provides: "Updated loader referencing v3 schema"
      contains: "schema_v3.json"
  key_links:
    - from: "__tests__/python/test_schema_validation.py"
      to: "test_files/ground_truth/schema_v3.json"
      via: "jsonschema.validate()"
      pattern: "validate.*instance.*schema"
    - from: "test_files/ground_truth_loader.py"
      to: "test_files/ground_truth/schema_v3.json"
      via: "error message reference"
      pattern: "schema_v3.json"
---

<objective>
Consolidate ground truth to v3 schema only, with a validation test proving conformance.

Purpose: Eliminate schema confusion (three coexisting versions) and add an automated guard ensuring all ground truth files conform to the canonical v3 schema. This is a prerequisite for Phase 17 (Quality Scoring) which needs a single reliable ground truth format.

Output: All ground truth JSON files migrated to v3 structure, old schemas deleted, jsonschema dependency added, parametrized validation test created, ground_truth_loader.py updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-test-infrastructure/14-RESEARCH.md
@test_files/ground_truth/schema_v3.json
@test_files/ground_truth_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ground truth files to v3 and delete old schemas</name>
  <files>
    test_files/ground_truth/derrida_footnotes.json
    test_files/ground_truth/derrida_of_grammatology.json
    test_files/ground_truth/heidegger_being_time.json
    test_files/ground_truth/heidegger_22_23_footnotes.json
    test_files/ground_truth/derrida_footnotes_v2.json
    test_files/ground_truth/kant_footnotes.json
    test_files/ground_truth/kant_64_65_footnotes.json
    test_files/ground_truth/schema.json
    test_files/ground_truth/schema_v2.json
    test_files/ground_truth_loader.py
  </files>
  <action>
**Step 1: Migrate v1-structure files to v3.**

Four files need structural migration (v1 → v3). The key change: `pages`, `created_date`, `verified_by`, `description` move INTO a `metadata` object.

**derrida_footnotes.json** (v1 → v3):
- Move `pages` (6), `created_date`, `verified_by` into `metadata: {}`
- `verified_by` value "manual_inspection" → use "human" (valid v3 enum)
- Add `description` into metadata from existing top-level `description`
- Remove top-level `pages`, `created_date`, `verified_by`, `description`
- Footnotes: Add `note_source: "translator"`, `classification_confidence: 0.9`, `classification_method: "manual_verification"` to each footnote (both are translator notes per research)
- Footnotes currently use flat `marker` (string) — restructure to v3 `marker` object: `{"symbol": "*", "location_type": "inline_body"}` for first, `{"symbol": "†", "location_type": "inline_body"}` for second
- Footnote `definition` must be an object: `{"content": "...existing content text..."}` (wrap the string)
- Keep `note_type` fields for backward compatibility
- Remove non-schema fields: `page`, `marker_location`, `marker_context`, `content_page`, `content_location`, `expected_output`, `confidence_min` — OR restructure them into v3 equivalents (move `page` to `page_index`, `content` stays in `definition.content`)

**derrida_of_grammatology.json** (v1 → v3):
- Move `pages`, `created_date`, `verified_by` into `metadata: {}`
- `verified_by` value "manual_inspection" → use "human"
- Move `description` into metadata
- No footnotes to migrate (empty array)
- xmarks: current structure uses `page` (not `page_index`). Schema expects `page_index` for xmarks (see definitions). Keep as-is since xmark definition in v3 doesn't require `page_index` as required field — but `page_index` and `word_under_erasure` ARE required. Rename `page` → `page_index` in each xmark.

**heidegger_being_time.json** (v1 → v3):
- Move `pages`, `created_date`, `verified_by` into `metadata: {}`
- `verified_by` value "manual_inspection" → use "human"
- Move `description` into metadata
- No footnotes to migrate (empty array)
- xmarks: rename `page` → `page_index` in each xmark

**heidegger_22_23_footnotes.json** (v1-like → v3):
- This file has a completely different structure: top-level `source`, `footnotes` (not inside `features`), `pages` as array [22, 23], `schema_version`, `verification_method`, `verification_date`, etc.
- Restructure completely:
  - Add `test_name` field (use "heidegger_22_23_footnotes")
  - Keep `pdf_file` (but prepend `test_files/` if not already present — check actual value)
  - Create `metadata: { pages: 2, created_date: "2025-10-30", verified_by: "human", description: "..." }` from existing fields
  - Move `footnotes` array into `features: { footnotes: [...] }`
  - Each footnote needs restructuring: current has flat `marker`, `content`, `note_source`, `classification_confidence` etc. Convert `marker` string to `marker: { symbol: "...", location_type: "superscript_inline" }`. Convert `content` to `definition: { content: "..." }`.
  - Add `classification_method: "manual_verification"` to each footnote (they have `classification_confidence` already)
  - Add `expected_quality: { quality_score_min: 0.85, processing_time_max_ms: 15000 }` (reasonable defaults for a 2-page doc)
  - Remove non-v3 top-level fields: `source`, `schema_version`, `verification_method`, `verification_date`, `ocr_quality`, `ocr_issues`

**Step 2: Fix v3-ish files (minor adjustments).**

These three files already have `metadata` and mostly v3 structure, but may need small fixes:

**derrida_footnotes_v2.json** — Read the full file to check conformance. Likely needs:
- Verify all footnotes have `note_source`, `classification_confidence`, `classification_method` (the three required v3 fields on footnote_v3)
- If any footnote is missing `classification_method`, add `"classification_method": "manual_verification"`

**kant_footnotes.json** — Read the full file. Likely already v3-compliant since it was created with v3 schema in mind. Verify and fix any missing required fields.

**kant_64_65_footnotes.json** — Read the full file. Similar check.

**Step 3: Delete old schemas.**

Delete `test_files/ground_truth/schema.json` and `test_files/ground_truth/schema_v2.json` using `git rm`.

**Step 4: Update ground_truth_loader.py.**

In `test_files/ground_truth_loader.py`:
1. In `load_ground_truth()`, change the error message from `"Follow schema in test_files/ground_truth/schema.json"` → `"Follow schema in test_files/ground_truth/schema_v3.json"`
2. In `_validate_ground_truth_schema()`, add a check: if `metadata` not in gt, raise ValueError including guidance to use v3 schema
3. In `list_ground_truth_tests()`, remove `'schema.json'` and `'schema_v2.json'` from EXCLUDED_FILES (they no longer exist). Keep `'schema_v3.json'`.

**IMPORTANT:** After migrating each file, validate it manually by loading it as JSON to check for syntax errors. Run existing tests after all migrations to catch regressions early.

**IMPORTANT:** The v3 schema's `footnote_v3` definition requires `["marker", "definition", "note_source", "classification_confidence", "classification_method"]`. Every footnote in every migrated file MUST have all five fields.
  </action>
  <verify>
1. `ls test_files/ground_truth/schema*.json` — should show only schema_v3.json
2. `python3 -c "import json; [json.load(open(f'test_files/ground_truth/{n}.json')) for n in ['derrida_footnotes', 'derrida_of_grammatology', 'heidegger_being_time', 'heidegger_22_23_footnotes', 'derrida_footnotes_v2', 'kant_footnotes', 'kant_64_65_footnotes']]; print('All files valid JSON')"` — no JSON parse errors
3. `uv run pytest __tests__/python/test_real_world_validation.py -x -q 2>&1 | tail -5` — existing tests still pass (if they were passing before)
4. `uv run pytest __tests__/python/test_recall_baseline.py -x -q 2>&1 | tail -5` — existing tests still pass
  </verify>
  <done>All 7 ground truth data files have v3 structure. Old schemas (schema.json, schema_v2.json) deleted. ground_truth_loader.py updated to reference v3.</done>
</task>

<task type="auto">
  <name>Task 2: Add jsonschema dependency and create validation test</name>
  <files>
    pyproject.toml
    __tests__/python/test_schema_validation.py
  </files>
  <action>
**Step 1: Add jsonschema as dev dependency.**

Run: `uv add --dev jsonschema`

This adds jsonschema to pyproject.toml dev dependencies and updates uv.lock.

**Step 2: Create parametrized schema validation test.**

Create `__tests__/python/test_schema_validation.py` with this content:

```python
"""Validate all ground truth JSON files conform to v3 schema.

This test ensures schema consistency across all ground truth files.
Any new ground truth file added must conform to schema_v3.json.
"""
import json
import pytest
from pathlib import Path
from jsonschema import validate, ValidationError

pytestmark = pytest.mark.unit

GROUND_TRUTH_DIR = Path("test_files/ground_truth")
SCHEMA_PATH = GROUND_TRUTH_DIR / "schema_v3.json"

# Files that are NOT ground truth test cases (utility/schema files)
EXCLUDED_FILES = {
    "schema_v3.json",
    "body_text_baseline.json",
    "correction_matrix.json",
}


def get_ground_truth_files():
    """List all ground truth JSON files that should conform to v3 schema."""
    return sorted([
        f for f in GROUND_TRUTH_DIR.glob("*.json")
        if f.name not in EXCLUDED_FILES
    ])


@pytest.fixture(scope="module")
def v3_schema():
    """Load the v3 schema once for all tests in this module."""
    with open(SCHEMA_PATH) as f:
        return json.load(f)


class TestGroundTruthSchemaConformance:
    """Every ground truth JSON file must validate against schema_v3.json."""

    @pytest.mark.parametrize(
        "gt_file",
        get_ground_truth_files(),
        ids=lambda f: f.stem,
    )
    def test_conforms_to_v3_schema(self, v3_schema, gt_file):
        """Validate a single ground truth file against v3 schema."""
        with open(gt_file) as f:
            data = json.load(f)
        try:
            validate(instance=data, schema=v3_schema)
        except ValidationError as e:
            pytest.fail(
                f"{gt_file.name} failed v3 schema validation:\n"
                f"  Path: {' -> '.join(str(p) for p in e.absolute_path)}\n"
                f"  Error: {e.message}"
            )

    @pytest.mark.parametrize(
        "gt_file",
        get_ground_truth_files(),
        ids=lambda f: f.stem,
    )
    def test_referenced_pdf_exists(self, gt_file):
        """Every ground truth file must reference a PDF that exists on disk."""
        with open(gt_file) as f:
            data = json.load(f)
        pdf_path = Path(data["pdf_file"])
        assert pdf_path.exists(), (
            f"{gt_file.name} references PDF '{data['pdf_file']}' which does not exist"
        )

    def test_no_old_schema_files(self):
        """Old schema versions must not exist (migration complete)."""
        assert not (GROUND_TRUTH_DIR / "schema.json").exists(), "schema.json (v1) should be deleted"
        assert not (GROUND_TRUTH_DIR / "schema_v2.json").exists(), "schema_v2.json should be deleted"

    def test_v3_schema_exists(self):
        """The canonical v3 schema must exist."""
        assert SCHEMA_PATH.exists(), "schema_v3.json must exist"
```

**IMPORTANT:** The `pytestmark = pytest.mark.unit` is required because Plan 01 enables strict_markers. This test uses no real PDF files and runs quickly — `unit` is the correct marker.
  </action>
  <verify>
1. `uv run python -c "import jsonschema; print(jsonschema.__version__)"` — jsonschema importable
2. `uv run pytest __tests__/python/test_schema_validation.py -v` — all parametrized tests pass (7 data files x 2 tests + 2 static tests)
3. `uv run pytest __tests__/python/test_schema_validation.py -v 2>&1 | grep -c "PASSED"` — should show 16 or more PASSED lines (7 schema + 7 pdf_exists + 2 static)
  </verify>
  <done>jsonschema dependency installed. Parametrized validation test confirms all 7 ground truth files conform to v3 schema and reference existing PDFs. Old schema deletion verified by test.</done>
</task>

</tasks>

<verification>
1. `ls test_files/ground_truth/schema*.json` — only schema_v3.json
2. `uv run pytest __tests__/python/test_schema_validation.py -v` — all tests pass
3. `uv run pytest __tests__/python/test_real_world_validation.py -x -q` — existing ground truth consumers still work
4. `grep "schema_v3" test_files/ground_truth_loader.py` — loader references v3
5. `uv run pytest` — full suite passes (no regressions from migration)
</verification>

<success_criteria>
- Only schema_v3.json exists (v1 and v2 deleted)
- All 7 ground truth data files validate against v3 schema
- Parametrized test exists and passes
- ground_truth_loader.py updated to reference v3
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/14-test-infrastructure/14-02-SUMMARY.md`
</output>
