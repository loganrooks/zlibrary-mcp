{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RAG Pipeline Ground Truth Schema v2 (ML-Optimized)",
  "description": "Machine learning-friendly schema with enums, bbox coordinates, and corruption modeling",
  "version": "2.0.0",
  "type": "object",
  "required": ["test_name", "pdf_file", "metadata", "features", "expected_quality"],

  "properties": {
    "test_name": {
      "type": "string",
      "description": "Unique identifier for this test"
    },
    "pdf_file": {
      "type": "string",
      "description": "Path to test PDF relative to project root"
    },
    "metadata": {
      "type": "object",
      "required": ["pages", "created_date", "verified_by"],
      "properties": {
        "pages": {"type": "integer"},
        "physical_page_start": {"type": "integer", "description": "First printed page number"},
        "created_date": {"type": "string", "format": "date"},
        "verified_by": {
          "type": "string",
          "enum": ["human", "visual_inspection_claude", "agent_verification", "automated"]
        },
        "description": {"type": "string"}
      }
    },
    "features": {
      "type": "object",
      "properties": {
        "footnotes": {
          "type": "array",
          "items": {"$ref": "#/definitions/footnote_v2"}
        },
        "endnotes": {
          "type": "array",
          "items": {"$ref": "#/definitions/endnote_v2"}
        },
        "citations": {
          "type": "array",
          "items": {"$ref": "#/definitions/citation"}
        },
        "formatting": {
          "type": "array",
          "items": {"$ref": "#/definitions/formatting"}
        },
        "xmarks": {
          "type": "array",
          "items": {"$ref": "#/definitions/xmark"}
        }
      }
    },
    "corruption_model": {
      "type": "object",
      "description": "Document-specific symbol corruption patterns",
      "properties": {
        "symbol_mappings": {
          "type": "object",
          "description": "Maps corrupted text to actual symbols",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "actual_symbol": {"type": "string"},
              "unicode": {"type": "string"},
              "probability": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "font_issues": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "font_name": {"type": "string"},
              "affected_symbols": {"type": "array", "items": {"type": "string"}},
              "corruption_pattern": {"type": "string"}
            }
          }
        }
      }
    },
    "expected_quality": {
      "type": "object",
      "required": ["quality_score_min", "processing_time_max_ms"],
      "properties": {
        "quality_score_min": {"type": "number", "minimum": 0, "maximum": 1},
        "quality_flags": {"type": "array", "items": {"type": "string"}},
        "processing_time_max_ms": {"type": "integer"},
        "footnote_detection_required": {"type": "boolean"},
        "corruption_recovery_required": {"type": "boolean"}
      }
    },
    "validation_criteria": {
      "type": "object",
      "properties": {
        "all_footnotes_detected": {"type": "boolean"},
        "symbols_correctly_inferred": {"type": "boolean"},
        "pairing_complete": {"type": "boolean"},
        "no_false_positives": {"type": "boolean"},
        "confidence_calibrated": {"type": "boolean"}
      }
    }
  },

  "definitions": {
    "footnote_v2": {
      "type": "object",
      "required": ["marker", "marker_bbox", "content", "content_bbox"],
      "properties": {
        "page_index": {
          "type": "integer",
          "description": "0-indexed page number"
        },
        "physical_page": {
          "type": "integer",
          "description": "Printed page number on document"
        },
        "marker": {
          "type": "object",
          "required": ["symbol", "bbox", "location_type"],
          "properties": {
            "symbol": {
              "type": "string",
              "description": "Actual symbol: *, †, ‡, §, ¶, or numeric"
            },
            "unicode": {
              "type": "string",
              "pattern": "^0x[0-9a-fA-F]+$",
              "description": "Unicode code point (e.g., '0x2020' for †)"
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4,
              "description": "[x0, y0, x1, y1] coordinates"
            },
            "location_type": {
              "type": "string",
              "enum": [
                "inline_body",
                "section_heading_suffix",
                "paragraph_end",
                "page_reference_bracket",
                "superscript_inline",
                "margin"
              ]
            },
            "context_before": {
              "type": "string",
              "description": "20-50 chars before marker"
            },
            "context_after": {
              "type": "string",
              "description": "20-50 chars after marker"
            },
            "font": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "size": {"type": "number"},
                "is_superscript": {"type": "boolean"}
              }
            },
            "corruption": {
              "type": "object",
              "description": "How this marker appears in corrupted text layer",
              "properties": {
                "extracted_as": {
                  "type": "string",
                  "description": "What PyMuPDF extracts (e.g., 't' for †)"
                },
                "corruption_probability": {
                  "type": "number",
                  "description": "P(extracted | actual) learned from corpus"
                }
              }
            }
          }
        },
        "definition": {
          "type": "object",
          "required": ["content", "bbox"],
          "properties": {
            "content": {
              "type": "string",
              "description": "Full footnote text"
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4,
              "description": "Bounding box of definition region"
            },
            "starts_with_corrupted": {
              "type": "string",
              "description": "How definition starts in corrupted text (e.g., 'iii' or 't')"
            },
            "location_type": {
              "type": "string",
              "enum": ["page_bottom", "chapter_end", "document_end", "margin"]
            },
            "page_index": {"type": "integer"},
            "font": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "size": {"type": "number"},
                "size_ratio_to_body": {"type": "number", "description": "Typically 0.8-0.9 for footnotes"}
              }
            }
          }
        },
        "pairing": {
          "type": "object",
          "description": "Information for validating marker-definition pairing",
          "properties": {
            "spatial_distance": {
              "type": "number",
              "description": "Euclidean distance between marker and definition (pixels)"
            },
            "sequence_position": {
              "type": "integer",
              "description": "Position in footnote sequence (0-indexed)"
            },
            "confidence_min": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Minimum acceptable confidence for correct pairing"
            }
          }
        },
        "schema_info": {
          "type": "object",
          "properties": {
            "schema_type": {
              "type": "string",
              "enum": ["numeric", "symbolic", "alphabetic", "roman", "mixed"]
            },
            "sequence_index": {
              "type": "integer",
              "description": "Position in schema sequence (0 for first *, 1 for †, etc.)"
            },
            "expected_next": {
              "type": "string",
              "description": "Expected next symbol in sequence (for validation)"
            }
          }
        },
        "note_type": {
          "type": "string",
          "enum": ["translator_note", "author_note", "editor_note", "citation", "cross_reference", "explanation"]
        }
      }
    },

    "endnote_v2": {
      "type": "object",
      "description": "Similar to footnote but with chapter/section scope",
      "allOf": [{"$ref": "#/definitions/footnote_v2"}],
      "properties": {
        "chapter_number": {"type": "integer"},
        "section_title": {"type": "string"}
      }
    },

    "citation": {
      "type": "object",
      "properties": {
        "page_index": {"type": "integer"},
        "text": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "citation_type": {
          "type": "string",
          "enum": ["author_year", "numeric", "footnote_reference", "stephanus", "bekker", "custom"]
        },
        "author_hint": {"type": "string"},
        "year_hint": {"type": "integer"},
        "work_hint": {"type": "string"}
      }
    },

    "formatting": {
      "type": "object",
      "properties": {
        "page_index": {"type": "integer"},
        "text": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["bold", "italic", "underline", "strikethrough", "sous_erasure", "small_caps"]
          }
        },
        "expected_output": {"type": "string"}
      }
    },

    "xmark": {
      "type": "object",
      "required": ["page_index", "word_under_erasure", "bbox"],
      "properties": {
        "page_index": {"type": "integer"},
        "word_under_erasure": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "context_before": {"type": "string"},
        "context_after": {"type": "string"},
        "corrupted_extraction": {"type": "string"},
        "expected_recovery": {"type": "string"},
        "confidence_min": {"type": "number"}
      }
    }
  }
}
