---
phase: 12-annas-archive
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/source_adapter.py
  - lib/zlib_adapter.py
  - lib/libgen_adapter.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "UnifiedBookResult dataclass normalizes book results across Z-Library and LibGen"
    - "SourceAdapter ABC defines search(), resolve_download(), health_check() contract"
    - "ZLibAdapter wraps existing EAPI calls and returns UnifiedBookResult list"
    - "LibgenAdapter wraps libgen-api-enhanced and returns UnifiedBookResult list"
    - "LibGen sync calls run in asyncio.to_thread() to avoid blocking"
    - "libgen-api-enhanced is installed as a project dependency"
    - "LibGen mirror is configurable via LIBGEN_MIRROR env var"
  artifacts:
    - path: "lib/source_adapter.py"
      provides: "UnifiedBookResult dataclass, SourceAdapter ABC"
      contains: "class SourceAdapter"
    - path: "lib/zlib_adapter.py"
      provides: "ZLibAdapter wrapping EAPI client"
      contains: "class ZLibAdapter"
    - path: "lib/libgen_adapter.py"
      provides: "LibgenAdapter wrapping libgen-api-enhanced"
      contains: "class LibgenAdapter"
    - path: "pyproject.toml"
      provides: "libgen-api-enhanced dependency"
      contains: "libgen-api-enhanced"
  key_links:
    - from: "lib/zlib_adapter.py"
      to: "lib/source_adapter.py"
      via: "imports SourceAdapter, UnifiedBookResult"
      pattern: "from source_adapter import"
    - from: "lib/libgen_adapter.py"
      to: "lib/source_adapter.py"
      via: "imports SourceAdapter, UnifiedBookResult"
      pattern: "from source_adapter import"
    - from: "lib/zlib_adapter.py"
      to: "lib/python_bridge.py"
      via: "reuses get_eapi_client() and normalize functions"
      pattern: "from python_bridge import"
---

<objective>
Create the Python source abstraction layer with adapters for Z-Library and LibGen.

Purpose: Establishes the adapter pattern that enables multi-source search/download. All source-specific logic is encapsulated in adapters returning a unified result type. This is the foundation for fallback and parallel modes.
Output: `lib/source_adapter.py` (ABC + data model), `lib/zlib_adapter.py` (Z-Library adapter), `lib/libgen_adapter.py` (LibGen adapter), updated `pyproject.toml`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-annas-archive/12-RESEARCH.md
@lib/python_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install libgen-api-enhanced and create source abstraction</name>
  <files>pyproject.toml, lib/source_adapter.py</files>
  <action>
1. Install libgen-api-enhanced:
   ```bash
   cd /home/rookslog/workspace/projects/zlibrary-mcp && uv add libgen-api-enhanced
   ```

2. Create `lib/source_adapter.py` with:
   - `UnifiedBookResult` dataclass with fields: title, author, year (Optional[str]), language (Optional[str]), extension (Optional[str]), filesize (Optional[str]), md5 (Optional[str]), source (str: 'zlibrary' | 'libgen'), source_id (Optional[str]), download_url (Optional[str]), extra (Optional[dict])
   - Add `to_dict()` method that serializes to JSON-safe dict (for passing through Python bridge)
   - `SourceAdapter` ABC with three abstract async methods:
     - `async def search(self, query: str, **kwargs) -> List[UnifiedBookResult]`
     - `async def resolve_download(self, book: UnifiedBookResult) -> str` (returns download URL)
     - `async def health_check(self) -> bool`
   - Use stdlib only (dataclasses, abc, typing) — no external deps in this file
  </action>
  <verify>
    ```bash
    cd /home/rookslog/workspace/projects/zlibrary-mcp
    uv run python -c "from lib.source_adapter import UnifiedBookResult, SourceAdapter; print('OK')"
    grep "libgen-api-enhanced" pyproject.toml
    ```
  </verify>
  <done>UnifiedBookResult and SourceAdapter importable; libgen-api-enhanced in pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 2: Create ZLibAdapter and LibgenAdapter</name>
  <files>lib/zlib_adapter.py, lib/libgen_adapter.py</files>
  <action>
1. Create `lib/zlib_adapter.py`:
   - `class ZLibAdapter(SourceAdapter)` wrapping existing EAPI client
   - Constructor takes no args (reuses module-level `_eapi_client` from python_bridge.py via `get_eapi_client()`)
   - `search()`: Call `get_eapi_client()`, then `client.search_books(query, ...)`. Map EAPI results to `UnifiedBookResult` with `source='zlibrary'`. Support kwargs: exact, from_year, to_year, languages, extensions, count.
   - `resolve_download()`: Use `client.download_file()` approach or return download URL from book details. For now, return the book's download_url if already set, otherwise raise NotImplementedError (download routing handled by existing python_bridge.download_book).
   - `health_check()`: Call `eapi_health_check()` from python_bridge, return True if status is 'healthy'.
   - Import from python_bridge: `get_eapi_client`, `eapi_health_check`, `normalize_book_details`

2. Create `lib/libgen_adapter.py`:
   - `class LibgenAdapter(SourceAdapter)`
   - Constructor takes `mirror: str = None`, reads from `os.environ.get('LIBGEN_MIRROR', 'li')` if None
   - `search()`: Create `LibgenSearch(mirror=self.mirror)`. Use `asyncio.to_thread()` to run sync search. Use `search_default(query)` for general search. If kwargs include `search_type='title'` use `search_title()`, if `search_type='author'` use `search_author()`. Map results to `UnifiedBookResult` with `source='libgen'`. Each libgen result has: Title, Author, Year, Language, Extension, Size, MD5, ID fields (dict keys, not attributes — check actual libgen-api-enhanced return format).
   - `resolve_download()`: Use `asyncio.to_thread()` to call the libgen-api-enhanced download resolution. The library returns download links — resolve the direct download link.
   - `health_check()`: Try a minimal search in thread, return True/False.
   - IMPORTANT: libgen-api-enhanced returns dicts, not objects. Field names are capitalized (Title, Author, Year, etc.). Normalize to lowercase in `_normalize()`.
   - Add 0.5s delay between searches to avoid rate limiting (use asyncio.sleep).
  </action>
  <verify>
    ```bash
    cd /home/rookslog/workspace/projects/zlibrary-mcp
    uv run python -c "from lib.zlib_adapter import ZLibAdapter; print('ZLib OK')"
    uv run python -c "from lib.libgen_adapter import LibgenAdapter; print('LibGen OK')"
    uv run python -c "
from lib.libgen_adapter import LibgenAdapter
import asyncio
async def test():
    a = LibgenAdapter()
    results = await a.search('python programming')
    print(f'Got {len(results)} results')
    if results:
        r = results[0]
        print(f'First: {r.title} by {r.author} [source={r.source}]')
asyncio.run(test())
"
    ```
  </verify>
  <done>Both adapters importable. LibgenAdapter returns UnifiedBookResult from live LibGen search. ZLibAdapter importable (live test requires credentials).</done>
</task>

</tasks>

<verification>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp

# All imports work
uv run python -c "
from lib.source_adapter import UnifiedBookResult, SourceAdapter
from lib.zlib_adapter import ZLibAdapter
from lib.libgen_adapter import LibgenAdapter
print('All imports OK')

# Verify adapter is subclass
assert issubclass(ZLibAdapter, SourceAdapter)
assert issubclass(LibgenAdapter, SourceAdapter)
print('Inheritance OK')

# Verify UnifiedBookResult serialization
r = UnifiedBookResult(title='Test', author='Author', source='libgen')
d = r.to_dict()
assert d['source'] == 'libgen'
print('Serialization OK')
"

# LibGen live search test
uv run python -c "
import asyncio
from lib.libgen_adapter import LibgenAdapter
async def test():
    adapter = LibgenAdapter()
    results = await adapter.search('test')
    assert len(results) > 0
    assert results[0].source == 'libgen'
    print(f'LibGen search returned {len(results)} results')
asyncio.run(test())
"

# Existing tests still pass
uv run pytest --tb=short -q
```
</verification>

<success_criteria>
- UnifiedBookResult dataclass with to_dict() serialization
- SourceAdapter ABC with search/resolve_download/health_check
- ZLibAdapter wrapping EAPI client
- LibgenAdapter wrapping libgen-api-enhanced with async thread wrapper
- LibGen live search returns normalized results
- Existing pytest suite still passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-annas-archive/12-01-SUMMARY.md`
</output>
