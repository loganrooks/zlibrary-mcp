---
phase: 10-adaptive-resolution
plan: 02
type: tdd
wave: 2
depends_on: ["10-01"]
files_modified:
  - lib/rag/resolution/renderer.py
  - __tests__/python/test_resolution_renderer.py
autonomous: true

must_haves:
  truths:
    - "render_page_adaptive renders full page at computed DPI from PageAnalysis"
    - "render_region renders clipped region at region-specific DPI"
    - "Full-page DPI never exceeds 300 (DPI_PAGE_CAP)"
    - "Region DPI can go up to 600 for small-text regions"
    - "Coordinate mapping scales PDF points to pixel space correctly (coord * dpi/72)"
  artifacts:
    - path: "lib/rag/resolution/renderer.py"
      provides: "render_page_adaptive, render_region, AdaptiveRenderResult"
      exports: ["render_page_adaptive", "render_region"]
    - path: "__tests__/python/test_resolution_renderer.py"
      provides: "Unit tests for adaptive rendering"
  key_links:
    - from: "lib/rag/resolution/renderer.py"
      to: "lib/rag/resolution/models.py"
      via: "imports PageAnalysis, RegionDPI, DPI_PAGE_CAP"
      pattern: "from.*models import"
---

<objective>
Create the adaptive rendering engine that uses DPI decisions to render pages and regions.

Purpose: Translates DPI analysis into actual PyMuPDF rendering calls. Handles full-page rendering at adaptive DPI and region re-rendering at elevated DPI for small-text areas.
Output: `lib/rag/resolution/renderer.py` with render_page_adaptive and render_region, fully tested.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-adaptive-resolution/10-RESEARCH.md
@.planning/phases/10-adaptive-resolution/10-01-SUMMARY.md
@lib/rag/resolution/models.py
@lib/rag/resolution/analyzer.py
</context>

<feature>
  <name>Adaptive Page and Region Renderer</name>
  <files>
    lib/rag/resolution/renderer.py
    __tests__/python/test_resolution_renderer.py
  </files>
  <behavior>
    AdaptiveRenderResult dataclass:
    - page_image: PIL.Image (full page at page DPI)
    - region_images: list[tuple[RegionDPI, PIL.Image]] (re-rendered regions)
    - page_dpi: int (actual DPI used for full page)
    - metadata: dict (timing, memory stats)

    render_page_adaptive(page: fitz.Page, analysis: PageAnalysis) → AdaptiveRenderResult:
    - Renders full page at min(analysis.page_dpi.dpi, DPI_PAGE_CAP)
    - If analysis.has_small_text and analysis.regions exist:
      - For each region in analysis.regions where region.dpi_decision.dpi > page DPI:
        - Re-render that region using page.get_pixmap(dpi=region_dpi, clip=rect)
        - Cap region DPI at DPI_CEILING (600)
    - Convert pixmaps to PIL Images
    - Return AdaptiveRenderResult with page + region images

    render_region(page: fitz.Page, bbox: tuple, dpi: int) → PIL.Image:
    - Renders a clipped region at specified DPI
    - bbox is in PDF point space (72 DPI)
    - Uses pymupdf.Rect(bbox) for clip parameter
    - Returns PIL Image

    Coordinate mapping helper:
    - pdf_to_pixel(coord: float, dpi: int) → int: return round(coord * dpi / 72)
    - pixel_to_pdf(coord: float, dpi: int) → float: return coord * 72 / dpi

    Edge cases:
    - PageAnalysis with no regions → just render full page, no region re-renders
    - PageAnalysis with confidence 0 (scanned PDF) → render at DPI_DEFAULT (300)
    - Region bbox extends beyond page → clip to page bounds
  </behavior>
  <implementation>
    1. Create renderer.py with AdaptiveRenderResult dataclass
    2. Implement render_region using page.get_pixmap(dpi=N, clip=Rect(bbox))
    3. Implement render_page_adaptive orchestrating full-page + region renders
    4. Add coordinate mapping helpers
    5. Tests should mock fitz.Page to verify correct DPI and clip parameters passed
    6. Add timing instrumentation (time.perf_counter) in metadata
  </implementation>
</feature>

<verification>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run pytest __tests__/python/test_resolution_renderer.py -v

# Verify imports
uv run python -c "from lib.rag.resolution.renderer import render_page_adaptive, render_region; print('Renderer OK')"
```
</verification>

<success_criteria>
- render_page_adaptive passes correct DPI to get_pixmap (not hardcoded 300)
- Full-page DPI never exceeds DPI_PAGE_CAP (300)
- Region re-rendering uses clip parameter with correct bbox
- Region DPI can exceed page DPI up to DPI_CEILING (600)
- Coordinate mapping correctly scales between PDF points and pixel space
- Scanned PDF fallback renders at 300 DPI
</success_criteria>

<output>
After completion, create `.planning/phases/10-adaptive-resolution/10-02-SUMMARY.md`
</output>
