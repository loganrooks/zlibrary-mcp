---
phase: 02-low-risk-dependency-upgrades
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/booklist_tools.py
  - lib/term_tools.py
  - lib/author_tools.py
  - lib/advanced_search.py
  - lib/enhanced_metadata.py
  - lib/rag_processing.py
autonomous: true

must_haves:
  truths:
    - "booklist_tools.py:267 uses `except Exception` instead of bare `except`"
    - "All 10 BeautifulSoup calls across 6 files specify 'lxml' parser"
    - "All Python tests pass with the changes"
  artifacts:
    - path: "lib/booklist_tools.py"
      provides: "Specific exception handler + lxml parser"
      contains: "except Exception"
    - path: "lib/term_tools.py"
      provides: "lxml parser specification"
      contains: "lxml"
    - path: "lib/author_tools.py"
      provides: "lxml parser specification"
      contains: "lxml"
    - path: "lib/advanced_search.py"
      provides: "lxml parser specification"
      contains: "lxml"
    - path: "lib/enhanced_metadata.py"
      provides: "lxml parser specification"
      contains: "lxml"
    - path: "lib/rag_processing.py"
      provides: "lxml parser specification"
      contains: "lxml"
  key_links:
    - from: "lib/booklist_tools.py"
      to: "logging module"
      via: "logger.warning at exception site"
      pattern: "logger\\.warning.*failed"
---

<objective>
Fix bare exception handler in booklist_tools.py and specify 'lxml' parser in all 10 BeautifulSoup calls across 6 Python files.

Purpose: Eliminate Python code quality issues (QUAL-01, QUAL-06) — bare except catches SystemExit/KeyboardInterrupt, unspecified BS4 parser is an XXE risk.
Output: 6 Python files updated with specific exception handling and explicit parser specification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-low-risk-dependency-upgrades/02-CONTEXT.md

Key context:
- lxml is already a project dependency — no new deps needed.
- Bare except at booklist_tools.py:267 wraps `await zlib.search("init", count=1)` — network/auth errors.
- 10 BeautifulSoup sites across 6 files (see research for exact lines).
- Opportunistic fixes in same files are allowed per CONTEXT decisions.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix bare except and BS4 parsers in booklist_tools.py</name>
  <files>lib/booklist_tools.py</files>
  <action>
1. Fix bare except at line 267:
   - Change `except:` to `except Exception as e:`
   - Add logging: `logger.warning("Initial search during authentication failed: %s", e)`
   - Ensure `import logging` and `logger = logging.getLogger(__name__)` exist at module top (add if missing).

2. Fix BeautifulSoup parser at lines 91 and 162:
   - Change `BeautifulSoup(html, 'html.parser')` to `BeautifulSoup(html, 'lxml')` (variable name may differ — match existing code).

3. Opportunistic: If there are other bare excepts or unspecified BS4 parsers in this file, fix those too.

4. Run Python tests to verify: `uv run pytest`
  </action>
  <verify>
```bash
# No bare excepts remain
grep -n "except:" lib/booklist_tools.py | grep -v "except [A-Z]"
# lxml parser used
grep -n "BeautifulSoup" lib/booklist_tools.py
# Tests pass
uv run pytest
```
  </verify>
  <done>
- Line 267 uses `except Exception as e:` with logging
- Lines 91 and 162 use 'lxml' parser
- All Python tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix BS4 parsers in remaining 5 Python files</name>
  <files>lib/term_tools.py, lib/author_tools.py, lib/advanced_search.py, lib/enhanced_metadata.py, lib/rag_processing.py</files>
  <action>
In each file, change all `BeautifulSoup(...)` calls to specify `'lxml'` parser:

1. **lib/term_tools.py** (line 70): Change parser to 'lxml'
2. **lib/author_tools.py** (line 210): Change parser to 'lxml'
3. **lib/advanced_search.py** (lines 42, 115): Change parser to 'lxml' at both sites
4. **lib/enhanced_metadata.py** (lines 79, 435): Change parser to 'lxml' at both sites
5. **lib/rag_processing.py** (lines 1539, 4576): Change parser to 'lxml' at both sites

For each file:
- The exact variable name in the BS4 call may be `html`, `html_content`, `response.text`, etc. — match existing code, only change the parser argument.
- If any BS4 call has NO parser specified at all (just `BeautifulSoup(content)`), add `'lxml'` as second argument.
- Opportunistic: fix any other bare excepts or similar quality issues in the same files if safe.

Run full Python test suite after all changes.
  </action>
  <verify>
```bash
# All BS4 calls use lxml
grep -rn "BeautifulSoup" lib/ | grep -v "lxml" | grep -v "__pycache__" | grep -v ".pyc"
# No bare excepts in modified files
grep -n "except:" lib/term_tools.py lib/author_tools.py lib/advanced_search.py lib/enhanced_metadata.py lib/rag_processing.py | grep -v "except [A-Z]"
# Tests pass
uv run pytest
```
  </verify>
  <done>
- All 8 remaining BS4 calls across 5 files use 'lxml' parser
- No bare excepts introduced
- All Python tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Zero unspecified BS4 parsers
grep -rn "BeautifulSoup" lib/ | grep -v lxml | grep -v __pycache__

# Zero bare excepts in modified files
grep -rn "except:" lib/booklist_tools.py lib/term_tools.py lib/author_tools.py lib/advanced_search.py lib/enhanced_metadata.py lib/rag_processing.py | grep -v "except [A-Z]"

# All tests pass
uv run pytest
```
</verification>

<success_criteria>
- booklist_tools.py:267 uses `except Exception as e:` with logging
- All 10 BeautifulSoup calls across 6 files specify 'lxml' parser
- Zero bare excepts in modified files
- All Python tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-low-risk-dependency-upgrades/02-02-SUMMARY.md`
</output>
