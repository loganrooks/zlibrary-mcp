---
phase: 08-infrastructure-modernization
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Dockerfile.test
  - pyproject.toml
  - lib/booklist_tools.py
  - lib/python_bridge.py
  - lib/enhanced_metadata.py
autonomous: true

must_haves:
  truths:
    - "Docker production image builds without numpy/opencv compilation errors"
    - "EAPI booklist browsing returns topic-enriched results (not just degradation stub)"
    - "EAPI full-text search attempts content-aware fallback beyond plain search"
  artifacts:
    - path: "pyproject.toml"
      provides: "opencv-python-headless replaces opencv-python"
      contains: "opencv-python-headless"
    - path: "lib/booklist_tools.py"
      provides: "Enhanced booklist fallback with metadata enrichment"
    - path: "lib/python_bridge.py"
      provides: "Improved full-text search fallback"
  key_links:
    - from: "Dockerfile.test"
      to: "pyproject.toml"
      via: "uv sync installs headless opencv"
      pattern: "uv sync"
---

<objective>
Fix Docker Alpine/numpy compilation issue and improve EAPI gap workarounds for booklist browsing and full-text search.

Purpose: Docker builds currently fail on Alpine due to opencv-python needing C compilation. EAPI booklist and full-text search degrade to simple stubs. This plan fixes the Docker issue and improves the EAPI fallbacks to provide more useful results.
Output: Docker builds cleanly, booklist returns enriched topic results, full-text search uses smarter fallback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-infrastructure-modernization/08-RESEARCH.md
@pyproject.toml
@Dockerfile.test
@lib/booklist_tools.py
@lib/python_bridge.py
@lib/enhanced_metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Docker opencv compilation (headless variant)</name>
  <files>pyproject.toml, Dockerfile.test</files>
  <action>
1. In `pyproject.toml`, replace `"opencv-python>=4.12.0.88"` with `"opencv-python-headless>=4.12.0.88"`. The headless variant has pre-built manylinux wheels that work on Debian-slim without compilation. It provides the same `cv2` API minus GUI functions (which we don't use â€” MCP server is headless).

2. Run `uv lock` to regenerate uv.lock with the new dependency.
3. Run `uv sync` to install the headless variant.
4. Verify import works: `uv run python -c "import cv2; print(cv2.__version__)"`.
5. Run `uv run pytest` to verify no test regressions.
6. Build Docker test image: `docker build -f Dockerfile.test -t zlibrary-mcp-test .`
   - This must complete without numpy/opencv compilation errors
   - If build fails, check if `gcc` and `python3-dev` are still needed in Dockerfile.test; with headless wheels they may be removable.

7. If Docker builds clean, try removing `gcc python3-dev` from Dockerfile.test apt-get install to slim the image. Re-test build. If it fails without them (other deps need them), keep them.
  </action>
  <verify>
- `grep "opencv-python-headless" pyproject.toml` matches
- `grep -v "opencv-python[^-]" pyproject.toml` confirms no non-headless opencv reference
- `uv run pytest` all pass
- `docker build -f Dockerfile.test -t zlibrary-mcp-test .` completes without compilation errors
  </verify>
  <done>Docker image builds without opencv/numpy compilation issues. opencv-python-headless used throughout.</done>
</task>

<task type="auto">
  <name>Task 2: Improve EAPI booklist and full-text search fallbacks</name>
  <files>lib/booklist_tools.py, lib/python_bridge.py, lib/enhanced_metadata.py</files>
  <action>
1. **Booklist improvement** in `lib/booklist_tools.py`:
   - Current: falls back to topic search with just the topic name
   - Improve: When EAPI search returns results for the topic, enrich each result with metadata tiering (call `get_book_metadata` for top 5 results to add descriptions, categories)
   - Add a `"source": "topic_search_enriched"` field to distinguish from true booklist results
   - Add a note in the response explaining that true booklist browsing is unavailable via EAPI and these are curated topic results
   - Keep the existing graceful degradation message but make it more informative

2. **Full-text search improvement** in `lib/python_bridge.py` (function `full_text_search`, around line 347):
   - Current: likely falls back to regular search when EAPI lacks full-text endpoint
   - Improve: Try multiple search strategies:
     a. First try exact phrase search via EAPI (if supported)
     b. Then try searching with query wrapped in quotes
     c. Add `"search_type": "content_fallback"` to results so consumers know this isn't true full-text search
   - Add logging to indicate which fallback strategy was used

3. In `lib/enhanced_metadata.py`, update the booklists field comment from `'booklists': []  # Not available via EAPI` to reflect the improved fallback.

4. Run `uv run pytest` to verify no regressions.
5. Run `npm test` to verify Node tests still pass.
  </action>
  <verify>
- `uv run pytest` all pass
- `npm test` all pass
- `grep "topic_search_enriched\|content_fallback" lib/booklist_tools.py lib/python_bridge.py` shows new markers
  </verify>
  <done>Booklist returns enriched topic results with metadata. Full-text search uses multi-strategy fallback. Both clearly labeled as EAPI workarounds.</done>
</task>

</tasks>

<verification>
- Docker builds clean: `docker build -f Dockerfile.test -t zlibrary-mcp-test .`
- `uv run pytest && npm test` both green
- `grep "opencv-python-headless" pyproject.toml` matches
- Booklist and full-text search responses include source/type markers
</verification>

<success_criteria>
Docker builds without compilation errors. Booklist returns enriched results beyond stub. Full-text search uses improved fallback. All clearly labeled as EAPI workarounds.
</success_criteria>

<output>
After completion, create `.planning/phases/08-infrastructure-modernization/08-03-SUMMARY.md`
</output>
