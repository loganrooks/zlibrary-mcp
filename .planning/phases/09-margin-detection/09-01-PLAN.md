---
phase: 09-margin-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/rag/detection/margins.py
  - lib/rag/detection/margin_patterns.py
  - lib/rag/detection/__init__.py
  - __tests__/python/test_margin_detection.py
autonomous: true

must_haves:
  truths:
    - "Body column boundaries are inferred statistically from text block positions, not hardcoded"
    - "Two-column layouts are detected and not misclassified as body+margin"
    - "Blocks in header/footer zones are excluded from margin classification"
    - "Margin blocks are classified by zone (left, right) with typed content (stephanus, bekker, line_number, margin)"
    - "Scan artifacts and single-character noise are filtered out"
  artifacts:
    - path: "lib/rag/detection/margins.py"
      provides: "detect_margin_content() — page-level margin zone detection and block classification"
      exports: ["detect_margin_content"]
    - path: "lib/rag/detection/margin_patterns.py"
      provides: "classify_margin_content() — Stephanus, Bekker, line number, generic margin regex classification"
      exports: ["classify_margin_content", "STEPHANUS_RE", "BEKKER_RE", "LINE_NUMBER_RE"]
    - path: "__tests__/python/test_margin_detection.py"
      provides: "Unit tests for margin detection and classification"
  key_links:
    - from: "lib/rag/detection/margins.py"
      to: "lib/rag/detection/margin_patterns.py"
      via: "classify_margin_content import"
      pattern: "from.*margin_patterns.*import.*classify_margin_content"
    - from: "lib/rag/detection/margins.py"
      to: "PyMuPDF page.get_text('dict')"
      via: "block bbox extraction"
      pattern: "get_text.*dict"
---

<objective>
Build the margin zone detection engine and typed classification patterns as standalone, tested modules.

Purpose: Create the core detection logic (MARG-01 through MARG-06) that identifies margin zones on PDF pages using statistical body-column inference, classifies blocks by zone, and applies typed content classification (Stephanus, Bekker, line numbers). This is the foundational engine that Plan 02 integrates into the pipeline.

Output: Two new detection modules (`margins.py`, `margin_patterns.py`) with comprehensive tests. No pipeline integration yet — that's Plan 03.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-margin-detection/09-RESEARCH.md

# Key codebase references for pattern matching:
@lib/rag/detection/footnote_core.py
@lib/rag/detection/headings.py
@lib/rag/detection/page_numbers.py
@lib/rag/detection/__init__.py
@lib/rag/utils/cache.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create margin_patterns.py with typed classification</name>
  <files>lib/rag/detection/margin_patterns.py, __tests__/python/test_margin_detection.py</files>
  <action>
**TDD: RED first, then GREEN.**

**Test file** (`__tests__/python/test_margin_detection.py`):

Write tests for `classify_margin_content(text: str) -> tuple[str, str]`:
- Stephanus: "231a" → ('stephanus', '231a'), "514b-c" → ('stephanus', '514b-c'), "45e" → ('stephanus', '45e')
- Bekker: "1094a1" → ('bekker', '1094a1'), "1140b5" → ('bekker', '1140b5')
- Line numbers: "25" → ('line_number', '25'), "1" → ('line_number', '1'), "9999" → ('line_number', '9999')
- Generic margin: "cf. Book III" → ('margin', 'cf. Book III'), "See also p. 45" → ('margin', 'See also p. 45')
- Edge cases: empty string → ('margin', ''), whitespace " 231a " → ('stephanus', '231a') (strips), "0" → ('line_number', '0') should NOT match (range 1-9999), "10000" → ('margin', '10000') (out of range)
- Ambiguity: "123" could be line_number — test that Stephanus is checked first but "123" without letter is line_number
- "123a" — 3 digits + letter a-e = Stephanus. "1234a1" — 4 digits + a/b + digit = Bekker. Ensure no overlap.

**Implementation** (`lib/rag/detection/margin_patterns.py`):

```python
import re
STEPHANUS_RE = re.compile(r'^(\d{2,3}[a-e](?:\s*[-–]\s*[a-e])?)$')
BEKKER_RE = re.compile(r'^(\d{3,4}[ab]\d{1,2})$')
LINE_NUMBER_RE = re.compile(r'^(\d{1,4})$')

def classify_margin_content(text: str) -> tuple:
    text = text.strip()
    if STEPHANUS_RE.match(text): return ('stephanus', text)
    if BEKKER_RE.match(text): return ('bekker', text)
    if LINE_NUMBER_RE.match(text):
        num = int(text)
        if 1 <= num <= 9999: return ('line_number', text)
    return ('margin', text)
```

Run tests: `uv run pytest __tests__/python/test_margin_detection.py -v -k "classify"`
  </action>
  <verify>All classify_margin_content tests pass. No test failures.</verify>
  <done>classify_margin_content correctly classifies Stephanus, Bekker, line numbers, and generic margin content with no ambiguity between types.</done>
</task>

<task type="auto">
  <name>Task 2: Create margins.py with body-column inference and zone classification</name>
  <files>lib/rag/detection/margins.py, lib/rag/detection/__init__.py, __tests__/python/test_margin_detection.py</files>
  <action>
**TDD: RED first, then GREEN.**

**Add tests** to `__tests__/python/test_margin_detection.py` for:

1. `_infer_body_column(text_blocks, page_rect, fallback_margin_pct=0.12)`:
   - Test with 5+ blocks clustered at x0=72, x1=540 → body_left≈72, body_right≈540
   - Test with <3 blocks → uses fallback (page_width * 0.12 from each edge)
   - Test two-column detection: blocks at x0=72 AND x0=310 with similar counts → is_two_column=True, body zone expanded

2. `_classify_block_zone(block_bbox, body_left, body_right, page_rect, header_zone_pct, footer_zone_pct)`:
   - Block inside body bounds → "body"
   - Block left of body_left → "margin-left"
   - Block right of body_right → "margin-right"
   - Block in top 8% → "header"
   - Block in bottom 8% → "footer"
   - Header/footer zone pcts configurable via params

3. `detect_margin_content(page, excluded_bboxes=None, header_zone_pct=None, footer_zone_pct=None)`:
   - Mock a PyMuPDF page with known block layout. Use `unittest.mock.MagicMock` for page object.
   - Page with margin blocks → returns dict with margin_blocks list, body_column tuple, is_two_column bool
   - Each margin_block has: bbox, text, type (from classify_margin_content), content
   - excluded_bboxes parameter: blocks with matching bboxes are skipped (footnote coordination)
   - Scan artifact filter: single-char blocks and blocks narrower than 10pt are excluded

**Implementation** (`lib/rag/detection/margins.py`):

Follow research Pattern 2 (body column inference) and Pattern 3 (zone classification). Key points:
- Use `collections.Counter` with 5pt bin size for edge clustering (match headings.py pattern)
- Two-column check: `Counter.most_common(2)` — if second peak >30% of first count AND >100pt gap, it's two-column
- CropBox vs MediaBox: `if page.cropbox != page.mediabox: use page.mediabox` for zone calculations
- Header/footer zones: read from params, fallback to `os.getenv('RAG_HEADER_ZONE_PCT', '0.08')` and `os.getenv('RAG_FOOTER_ZONE_PCT', '0.08')`
- Fallback margin pct: `os.getenv('RAG_MARGIN_FALLBACK_PCT', '0.12')`
- Import `classify_margin_content` from `margin_patterns`
- Extract text from blocks by joining all span texts in all lines
- Filter: skip blocks with text length ≤1 or block width <10pt
- Return structure: `{'margin_blocks': [...], 'body_column': (left, right), 'is_two_column': bool}`

**Update `__init__.py`**: Add `detect_margin_content` and `classify_margin_content` to the detection package re-exports.

Run: `uv run pytest __tests__/python/test_margin_detection.py -v`
  </action>
  <verify>All margin detection tests pass. `uv run pytest __tests__/python/test_margin_detection.py -v` shows all green.</verify>
  <done>detect_margin_content correctly infers body columns statistically, handles two-column layouts, respects configurable header/footer zones via env vars, filters scan artifacts, coordinates with other detectors via excluded_bboxes, and classifies margin content with typed annotations.</done>
</task>

</tasks>

<verification>
```bash
# All margin detection tests pass
uv run pytest __tests__/python/test_margin_detection.py -v

# No import errors
uv run python -c "from lib.rag.detection.margins import detect_margin_content; from lib.rag.detection.margin_patterns import classify_margin_content; print('OK')"

# Existing tests still pass (no regressions)
uv run pytest __tests__/python/ -v --timeout=60
```
</verification>

<success_criteria>
- margins.py and margin_patterns.py exist with full implementation
- All tests pass including edge cases (two-column, scan artifacts, configurable zones)
- No regressions in existing test suite
- Header/footer zone percentages are configurable via env vars (RAG_HEADER_ZONE_PCT, RAG_FOOTER_ZONE_PCT)
- Margin fallback percentage configurable via RAG_MARGIN_FALLBACK_PCT
- CropBox vs MediaBox handled for scanned documents
</success_criteria>

<output>
After completion, create `.planning/phases/09-margin-detection/09-01-SUMMARY.md`
</output>
