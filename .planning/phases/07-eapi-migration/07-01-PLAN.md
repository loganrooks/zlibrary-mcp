---
phase: 07-eapi-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - zlibrary/src/zlibrary/eapi.py
  - zlibrary/src/zlibrary/util.py
  - zlibrary/src/zlibrary/__init__.py
autonomous: true

must_haves:
  truths:
    - "EAPIClient can authenticate and make search requests returning JSON"
    - "EAPI responses are normalized to match existing MCP tool output format"
    - "Domain discovery via /eapi/info/domains works after login"
  artifacts:
    - path: "zlibrary/src/zlibrary/eapi.py"
      provides: "EAPIClient class with all EAPI endpoint methods + normalize_eapi_book()"
      min_lines: 150
    - path: "zlibrary/src/zlibrary/util.py"
      provides: "Updated with EAPI POST/GET helpers"
    - path: "zlibrary/src/zlibrary/__init__.py"
      provides: "Exports EAPIClient"
  key_links:
    - from: "zlibrary/src/zlibrary/eapi.py"
      to: "httpx.AsyncClient"
      via: "async HTTP calls with cookie auth"
      pattern: "httpx\\.AsyncClient"
    - from: "zlibrary/src/zlibrary/eapi.py"
      to: "/eapi/book/search"
      via: "POST with form-encoded body"
      pattern: "/eapi/book/search"
---

<objective>
Create the EAPI client foundation — a new `EAPIClient` class that encapsulates all Z-Library EAPI HTTP calls with cookie-based auth, response normalization, and domain discovery.

Purpose: This is the foundation layer that all subsequent plans depend on. It replaces the HTML scraping transport with JSON API calls.
Output: `zlibrary/src/zlibrary/eapi.py` with full EAPI client + normalization utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-eapi-migration/07-RESEARCH.md
@zlibrary/src/zlibrary/util.py
@zlibrary/src/zlibrary/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EAPIClient class with all endpoints</name>
  <files>zlibrary/src/zlibrary/eapi.py</files>
  <action>
Create a new file `zlibrary/src/zlibrary/eapi.py` containing:

1. **`EAPIClient` class** with constructor accepting `domain`, `remix_userid`, `remix_userkey`. Use `httpx.AsyncClient` with connection pooling (create client once, reuse). Store auth as cookies dict: `{'siteLanguageV2': 'en', 'remix_userid': remix_userid, 'remix_userkey': remix_userkey}`.

2. **Endpoint methods** (all async):
   - `login(email, password)` → POST `/eapi/user/login` — returns userid + userkey
   - `search(message, **filters)` → POST `/eapi/book/search` — supports: limit, page, yearFrom, yearTo, languages (as `languages[]`), extensions (as `extensions[]`), exact (as `e=1`), order
   - `get_book_info(book_id, book_hash)` → GET `/eapi/book/{id}/{hash}`
   - `get_download_link(book_id, book_hash)` → GET `/eapi/book/{id}/{hash}/file`
   - `get_recently()` → GET `/eapi/book/recently`
   - `get_most_popular()` → GET `/eapi/book/most-popular`
   - `get_downloaded(order, page, limit)` → GET `/eapi/user/book/downloaded`
   - `get_profile()` → GET `/eapi/user/profile`
   - `get_similar(book_id, book_hash)` → GET `/eapi/book/{id}/{hash}/similar`
   - `get_domains()` → GET `/eapi/info/domains`

3. **Internal helpers**:
   - `_post(path, data)` — form-encoded POST with cookies+headers
   - `_get(path, params)` — GET with cookies+headers
   - Both raise on non-200 and return parsed JSON
   - Handle `languages[]` and `extensions[]` array encoding properly for httpx (use list values in data dict)

4. **Headers**: `Content-Type: application/x-www-form-urlencoded`, `User-Agent` mimicking browser, `Accept` header.

5. **`normalize_eapi_book(eapi_book: dict) -> dict`** standalone function:
   Maps EAPI fields to existing MCP format: `id` → str, `title` → `name` AND `title`, `author` → `author` AND `authors` list, `year`, `language`, `extension`, `filesize` → `size`, `rating`, `qualityScore` → `quality`, `cover`, `href` → `url`, `isbn`, `publisher`, `hash` → `hash` AND `book_hash`, `pages`.

6. **`normalize_eapi_search_response(eapi_response: dict) -> list[dict]`** — takes full EAPI search response, extracts `books` array, normalizes each book.

Use the research document (07-RESEARCH.md) patterns exactly. Do NOT use `requests` — use `httpx` only.
  </action>
  <verify>
`python -c "from zlibrary.eapi import EAPIClient, normalize_eapi_book; print('import OK')"` succeeds (run from project root with PYTHONPATH including zlibrary/src).
  </verify>
  <done>EAPIClient class exists with all 10 endpoint methods, normalize functions exist, imports work.</done>
</task>

<task type="auto">
  <name>Task 2: Update util.py and __init__.py exports</name>
  <files>zlibrary/src/zlibrary/util.py, zlibrary/src/zlibrary/__init__.py</files>
  <action>
1. **`util.py`**: Add an `eapi_login` convenience function that:
   - Creates a temporary EAPIClient with the given domain
   - Calls `login(email, password)`
   - Returns `(remix_userid, remix_userkey, eapi_client)` tuple
   - Also add `discover_eapi_domain(eapi_client)` that calls `get_domains()` and returns the primary domain for EAPI use
   - Keep existing `POST_request` and `GET_request` functions (they're still used for the initial `/rpc.php` login)

2. **`__init__.py`**: Add exports for `EAPIClient` and `normalize_eapi_book` so downstream code can do `from zlibrary import EAPIClient`.

Do NOT remove any existing exports or functions — only add new ones.
  </action>
  <verify>
`python -c "from zlibrary import EAPIClient; print('export OK')"` succeeds.
`uv run pytest __tests__/python/ -x -q 2>&1 | tail -5` shows no regressions in existing tests.
  </verify>
  <done>EAPIClient is importable from zlibrary package. All existing tests still pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from zlibrary.eapi import EAPIClient, normalize_eapi_book, normalize_eapi_search_response"` — imports work
2. `python -c "from zlibrary import EAPIClient"` — package-level export works
3. `uv run pytest __tests__/python/ -x -q` — no test regressions
4. `npm run build` — TypeScript still compiles (no TS changes but verify build isn't broken)
</verification>

<success_criteria>
- EAPIClient class with 10+ endpoint methods exists in eapi.py
- normalize_eapi_book correctly maps all fields from EAPI format to existing MCP format
- Package exports updated
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-eapi-migration/07-01-SUMMARY.md`
</output>
