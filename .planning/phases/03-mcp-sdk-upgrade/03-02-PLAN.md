---
phase: 03-mcp-sdk-upgrade
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - __tests__/index.test.js
  - __tests__/integration/mcp-protocol.test.js
  - __tests__/e2e/docker-mcp-e2e.test.js
autonomous: false

must_haves:
  truths:
    - "All Jest tests pass with updated mocks targeting McpServer"
    - "Integration tests verify MCP protocol behavior with new SDK"
    - "Docker E2E test passes with new SDK"
    - "User confirms server works in Claude Desktop or Claude Code"
  artifacts:
    - path: "__tests__/index.test.js"
      provides: "Unit tests mocking McpServer instead of Server"
      contains: "McpServer"
    - path: "__tests__/integration/mcp-protocol.test.js"
      provides: "Integration tests using McpServer import path"
      contains: "McpServer"
  key_links:
    - from: "__tests__/index.test.js"
      to: "@modelcontextprotocol/sdk/server/mcp.js"
      via: "mock import path"
      pattern: "server/mcp"
---

<objective>
Update all test files to work with the McpServer API from plan 03-01, then run full test suite and verify manually with a real MCP client.

Purpose: Ensures zero regressions from the SDK migration. Tests that mocked the old Server class must be updated to mock McpServer. Manual verification confirms real-world compatibility.

Output: All tests green. User has verified the server works with their MCP client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-sdk-upgrade/03-RESEARCH.md
@.planning/phases/03-mcp-sdk-upgrade/03-01-SUMMARY.md
@__tests__/index.test.js
@__tests__/integration/mcp-protocol.test.js
@__tests__/e2e/docker-mcp-e2e.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update test mocks for McpServer API</name>
  <files>__tests__/index.test.js, __tests__/integration/mcp-protocol.test.js, __tests__/e2e/docker-mcp-e2e.test.js</files>
  <action>
Update all test files that mock or reference the MCP SDK to use the new McpServer import path and API.

**For __tests__/index.test.js (~527 lines):**
- Change mock target from `@modelcontextprotocol/sdk/server/index.js` to `@modelcontextprotocol/sdk/server/mcp.js`
- Replace `Server` constructor mock with `McpServer` constructor mock
- McpServer API: constructor takes `{name, version}` (single arg, no capabilities object)
- McpServer exposes `registerTool()` instead of `setRequestHandler()`
- McpServer exposes `connect(transport)` same as Server
- If tests verify tool registration, update assertions to check `registerTool` calls instead of `setRequestHandler` calls
- If tests verify tool listing/calling behavior via request handlers, adapt to McpServer's internal routing (or test at a higher level)

**For __tests__/integration/mcp-protocol.test.js (~555 lines):**
- Same import path changes as above
- If this test creates a real Server instance for protocol testing, switch to McpServer
- If it uses `Client` from `@modelcontextprotocol/sdk/client/index.js`, that import is unchanged
- Update any assertions about handler registration

**For __tests__/e2e/docker-mcp-e2e.test.js (~109 lines):**
- Check if it references Server or SDK imports directly — if not, likely no changes needed
- If the Dockerfile.test uses node:20, no Node version change needed (already >=18)
- Verify the test still passes with the rebuilt Docker image

**General guidance:**
- Use `jest.unstable_mockModule` for ESM mocking (established pattern from Phase 1, decision [01-01])
- Preserve test coverage — don't delete tests, adapt them
- If a test concept no longer applies (e.g., testing manual ListTools handler), replace with equivalent McpServer test (e.g., verify registerTool was called with correct args)

**After updating:**
- Run `node --experimental-vm-modules node_modules/jest/bin/jest.js` for all Jest tests
- Run `uv run pytest` for Python tests (should be unaffected but confirm)
  </action>
  <verify>
- `node --experimental-vm-modules node_modules/jest/bin/jest.js` — all tests pass
- `uv run pytest` — all Python tests pass
- `grep "Server\b" __tests__/index.test.js __tests__/integration/mcp-protocol.test.js` — only McpServer references (no bare Server)
  </verify>
  <done>All test files updated for McpServer. Full Jest + Pytest suite passes with zero failures.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete MCP SDK migration: SDK upgraded to 1.25.x+, src/index.ts rewritten with McpServer, all tests passing.</what-built>
  <how-to-verify>
1. **Claude Code verification** (primary): The zlibrary-mcp server should already be configured in your Claude Code MCP settings. Restart Claude Code and invoke any tool (e.g., search_books with a query). Verify it returns results.

2. **Claude Desktop verification** (optional): Add this to your Claude Desktop MCP config if not already present:
```json
{
  "mcpServers": {
    "zlibrary": {
      "command": "node",
      "args": ["/absolute/path/to/zlibrary-mcp/dist/index.js"],
      "env": {
        "ZLIBRARY_EMAIL": "your-email",
        "ZLIBRARY_PASSWORD": "your-password"
      }
    }
  }
}
```
Restart Claude Desktop and invoke a tool.

3. **Quick smoke test**: Confirm all tools appear in the MCP tool list and at least one tool invocation succeeds with real data.
  </how-to-verify>
  <resume-signal>Type "approved" if tools work in your MCP client, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `node --experimental-vm-modules node_modules/jest/bin/jest.js` → all pass
2. `uv run pytest` → all pass
3. `npm run build` → still succeeds (no regressions from test changes)
4. User confirms MCP client connectivity and tool invocation
</verification>

<success_criteria>
- All Jest tests pass with McpServer mocks
- All Python tests pass (no regressions)
- User has verified server works with at least one real MCP client
- TypeScript build still succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-sdk-upgrade/03-02-SUMMARY.md`
</output>
