# Requirements Archive: v1.1 Quality & Expansion

**Archived:** 2026-02-04
**Status:** SHIPPED

This is the archived requirements specification for v1.1.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Z-Library MCP v1.1 Quality & Expansion

**Defined:** 2026-02-01
**Core Value:** Reliable, maintainable MCP server for Z-Library book access

## v1.1 Requirements

### Infrastructure

- [x] **INFRA-01**: Upgrade to Node 22 LTS (update engines field, CI matrix, Dockerfile) — VALIDATED
- [x] **INFRA-02**: Update env-paths to v4.0 (unlocked by Node 22) — VALIDATED
- [x] **INFRA-03**: Remove AsyncZlib legacy download client (route all downloads through EAPIClient) — VALIDATED
- [x] **INFRA-04**: Fix Docker numpy/Alpine compilation issue in production Dockerfile — VALIDATED
- [x] **INFRA-05**: Improve EAPI booklist browsing (beyond current graceful degradation) — VALIDATED
- [x] **INFRA-06**: Improve EAPI full-text search (beyond current regular-search fallback) — VALIDATED

### Margin Detection

- [x] **MARG-01**: Detect margin zones in PDFs using PyMuPDF bbox coordinates — VALIDATED
- [x] **MARG-02**: Recognize Stephanus numbering patterns (e.g., 231a, 245b-c) — VALIDATED
- [x] **MARG-03**: Recognize Bekker numbering patterns (e.g., 1094a1, 1140b5) — VALIDATED
- [x] **MARG-04**: Detect line numbers in poetry, legal texts, and critical editions — VALIDATED
- [x] **MARG-05**: Detect and extract marginal notes, glosses, and cross-references — VALIDATED
- [x] **MARG-06**: Adapt margin zone widths across different publisher layouts — VALIDATED
- [x] **MARG-07**: Preserve margin content as structured annotations in markdown output — VALIDATED

### Adaptive Resolution

- [x] **DPI-01**: Page-level DPI selection based on content density (150/300 DPI) — VALIDATED
- [x] **DPI-02**: Region-level DPI targeting (higher resolution for footnotes, margin text, small fonts) — VALIDATED
- [x] **DPI-03**: Optimal DPI determined by text pixel height analysis (Tesseract 30-33px target) — VALIDATED

### Body Text Purity

- [x] **BODY-01**: Unified detection pipeline composing all detectors (footnotes, margins, headings, page numbers, TOC) — VALIDATED
- [x] **BODY-02**: Non-body content clearly separated in markdown output — VALIDATED
- [x] **BODY-03**: Confidence scoring for detection decisions — VALIDATED

### Anna's Archive

- [x] **ANNA-01**: Research spike determining API feasibility, endpoints, auth, rate limits, legal considerations — VALIDATED (documented in 12-RESEARCH.md)
- [x] **ANNA-02**: Configurable base URL for Anna's Archive (domain instability mitigation) — VALIDATED (ANNAS_BASE_URL env var)
- [x] **ANNA-03**: Fallback search when Z-Library is rate-limited or unavailable — VALIDATED (LibGen fallback via SourceRouter)
- [x] **ANNA-04**: Source indicator in search results (which source returned each result) — VALIDATED (source field in UnifiedBookResult)

## v2 Requirements

Deferred to future milestone.

- **FEAT-01**: Download queue management (DL-001)
- **FEAT-02**: Search result caching layer
- **FEAT-03**: Semantic chunking for RAG pipeline
- **FEAT-04**: OS keychain for credentials
- **FEAT-05**: Unified search across both sources (merged result set)
- **FEAT-06**: PyMuPDF4LLM evaluation and potential integration

## Out of Scope

| Feature | Reason |
|---------|--------|
| Full Anna's Archive feature parity | Too large — v1.1 is fallback only |
| Automatic source selection without user control | Users need transparency on which source |
| Rewrite Python bridge in TypeScript | Python has better doc-processing libs |
| ML-based text recovery | Research task, not product scope |
| Full Zod 4 migration | Deferred from v1.0 — Zod 3.25.x bridge works |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| INFRA-01 | Phase 8 | Complete |
| INFRA-02 | Phase 8 | Complete |
| INFRA-03 | Phase 8 | Complete |
| INFRA-04 | Phase 8 | Complete |
| INFRA-05 | Phase 8 | Complete |
| INFRA-06 | Phase 8 | Complete |
| MARG-01 | Phase 9 | Complete |
| MARG-02 | Phase 9 | Complete |
| MARG-03 | Phase 9 | Complete |
| MARG-04 | Phase 9 | Complete |
| MARG-05 | Phase 9 | Complete |
| MARG-06 | Phase 9 | Complete |
| MARG-07 | Phase 9 | Complete |
| DPI-01 | Phase 10 | Complete |
| DPI-02 | Phase 10 | Complete |
| DPI-03 | Phase 10 | Complete |
| BODY-01 | Phase 11 | Complete |
| BODY-02 | Phase 11 | Complete |
| BODY-03 | Phase 11 | Complete |
| ANNA-01 | Phase 12 | Complete |
| ANNA-02 | Phase 12 | Complete |
| ANNA-03 | Phase 12 | Complete |
| ANNA-04 | Phase 12 | Complete |

**Coverage:**
- v1.1 requirements: 23 total
- Shipped: 23
- Dropped: 0

---

## Milestone Summary

**Shipped:** 23 of 23 v1.1 requirements
**Adjusted:**
- ANNA-01 through ANNA-04 requirements were refined during research — original scope was broader "fallback only", actual delivery includes dedicated Anna's Archive adapter with search and fast download
**Dropped:** None

---
*Archived: 2026-02-04 as part of v1.1 milestone completion*
