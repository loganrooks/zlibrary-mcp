---
phase: 04-python-monolith-decomposition
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - lib/rag/detection/footnotes.py
  - lib/rag/quality/pipeline.py
  - lib/rag/orchestrator.py
  - lib/rag/processors/pdf.py
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "grep -rn 'BUG-.*FIX' lib/rag/ returns zero matches"
    - "grep -rn '# DEBUG' lib/rag/ returns zero matches (converted to logger.debug)"
    - "uv run pytest and npm test both pass"
    - "Docker build succeeds with lib/rag/ included"
  artifacts:
    - path: "lib/rag/detection/footnotes.py"
      provides: "Footnote detection with BUG-X comments removed and DEBUG converted to logging"
      contains: "logger.debug"
    - path: "Dockerfile"
      provides: "Docker config that copies lib/rag/ directory"
      contains: "lib/rag"
  key_links:
    - from: "Dockerfile"
      to: "lib/rag/"
      via: "COPY directive"
      pattern: "COPY.*lib/rag"
---

<objective>
Clean up resolved BUG-X FIX comments, convert DEBUG comments to proper logging, and update Dockerfile to include the new lib/rag/ package.

Purpose: Satisfies QUAL-04 (no resolved BUG-X FIX comments) and QUAL-05 (DEBUG→logging). Ensures Docker deployments work with the new package structure.

Output: Clean codebase with proper logging, no legacy debug comments, working Docker build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-python-monolith-decomposition/04-02-SUMMARY.md
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean BUG-X FIX comments and convert DEBUG to logging</name>
  <files>
    lib/rag/detection/footnotes.py
    lib/rag/quality/pipeline.py
    lib/rag/orchestrator.py
    lib/rag/processors/pdf.py
  </files>
  <action>
Two cleanup operations across all lib/rag/ modules:

**1. Remove resolved BUG-X FIX comments:**
Run `grep -rn 'BUG-.*FIX' lib/rag/` to find all instances. These are inline comments like `# BUG-3 FIX: Skip if pattern not in dict`. The code they annotate is correct and should stay — only remove the comment text. Examples:

Before: `if pattern not in marker_patterns:  # BUG-3 FIX: Skip if pattern not in dict`
After:  `if pattern not in marker_patterns:`

Do NOT remove the code itself — only the `# BUG-X FIX: ...` comment suffix. If a BUG-X FIX comment is on its own line (not attached to code), remove the entire comment line.

**2. Convert DEBUG comments to logger.debug:**
Run `grep -rn '# DEBUG' lib/rag/` to find all instances. Convert each to a proper logger.debug() call. Examples:

Before: `# DEBUG: Check if formatting is being preserved`
After:  `logger.debug("Checking if formatting is being preserved")`

Before: `# DEBUG: Log page extraction for BUG-4 investigation`
After:  `logger.debug("Page extraction for footnote deduplication: page=%s", page_num)`

Use appropriate log message formatting (lazy % formatting, not f-strings in logger calls).

Run `uv run pytest` after cleanup to verify no behavioral changes.
  </action>
  <verify>
    grep -rn 'BUG-.*FIX' lib/rag/ — returns zero matches
    grep -rn '# DEBUG' lib/rag/ — returns zero matches
    uv run pytest — all tests pass
    npm test — all tests pass
  </verify>
  <done>
    Zero BUG-X FIX comments remain in lib/rag/.
    Zero DEBUG comments remain — all converted to logger.debug() calls.
    All tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Dockerfile and run integration smoke test</name>
  <files>
    Dockerfile
  </files>
  <action>
Update Dockerfile to ensure lib/rag/ is included in the Docker image.

Check current Dockerfile for how lib/ is copied. If it uses `COPY lib/ ./lib/` or similar, the nested lib/rag/ directory will be included automatically. If it copies specific files, add `COPY lib/rag/ ./lib/rag/`.

Verify:
1. `docker build -t zlibrary-mcp-test .` succeeds
2. The integration smoke test from Phase 1 passes (if available): `npm run test:integration`
3. Verify lib/rag/ exists inside container: `docker run --rm zlibrary-mcp-test ls -la lib/rag/`

If Dockerfile already copies the entire lib/ directory recursively, just verify no changes needed and document that in the summary.
  </action>
  <verify>
    docker build -t zlibrary-mcp-test . — builds successfully (or verify Dockerfile already handles lib/rag/)
    npm run test:integration — integration tests pass (if available)
  </verify>
  <done>
    Dockerfile correctly includes lib/rag/ in the Docker image.
    Integration smoke test passes, confirming Node.js-to-Python bridge works with decomposed modules.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `grep -rn 'BUG-.*FIX' lib/rag/` — zero matches
2. `grep -rn '# DEBUG' lib/rag/` — zero matches
3. `uv run pytest` — all tests pass
4. `npm test` — all tests pass
5. Docker build succeeds with lib/rag/ included
6. Integration smoke test passes
</verification>

<success_criteria>
- No resolved BUG-X FIX comments in codebase (QUAL-04)
- All DEBUG comments converted to proper logging (QUAL-05)
- Dockerfile handles lib/rag/ directory
- Full test suite + integration test passes
- Phase 4 success criteria fully met
</success_criteria>

<output>
After completion, create `.planning/phases/04-python-monolith-decomposition/04-03-SUMMARY.md`
</output>
