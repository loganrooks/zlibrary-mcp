{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RAG Pipeline Ground Truth Schema v3 (Classification-Enhanced)",
  "description": "ML-optimized schema with note classification, source attribution, and confidence scoring",
  "version": "3.0.0",
  "type": "object",
  "required": ["test_name", "pdf_file", "metadata", "features", "expected_quality"],

  "changelog": {
    "v3.0.0": {
      "date": "2025-10-27",
      "changes": [
        "Added note_source field for classification (author/translator/editor)",
        "Added classification_confidence field for ML training",
        "Added classification_method field to track inference approach",
        "Enhanced ml_features section with classification_features",
        "Added classification_accurate to validation_criteria"
      ]
    },
    "v2.0.0": {
      "date": "2025-10-22",
      "changes": [
        "Added bbox coordinates for all features",
        "Added corruption_model section",
        "Converted to ML-optimized enums",
        "Added schema_info for footnotes"
      ]
    }
  },

  "properties": {
    "test_name": {
      "type": "string",
      "description": "Unique identifier for this test"
    },
    "pdf_file": {
      "type": "string",
      "description": "Path to test PDF relative to project root"
    },
    "metadata": {
      "type": "object",
      "required": ["pages", "created_date", "verified_by"],
      "properties": {
        "pages": {"type": "integer"},
        "physical_page_start": {"type": "integer", "description": "First printed page number"},
        "created_date": {"type": "string", "format": "date"},
        "verified_by": {
          "type": "string",
          "enum": ["human", "visual_inspection_claude", "agent_verification", "automated"]
        },
        "description": {"type": "string"}
      }
    },
    "features": {
      "type": "object",
      "properties": {
        "footnotes": {
          "type": "array",
          "items": {"$ref": "#/definitions/footnote_v3"}
        },
        "endnotes": {
          "type": "array",
          "items": {"$ref": "#/definitions/endnote_v3"}
        },
        "citations": {
          "type": "array",
          "items": {"$ref": "#/definitions/citation"}
        },
        "formatting": {
          "type": "array",
          "items": {"$ref": "#/definitions/formatting"}
        },
        "xmarks": {
          "type": "array",
          "items": {"$ref": "#/definitions/xmark"}
        }
      }
    },
    "corruption_model": {
      "type": "object",
      "description": "Document-specific symbol corruption patterns",
      "properties": {
        "symbol_mappings": {
          "type": "object",
          "description": "Maps corrupted text to actual symbols",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "actual_symbol": {"type": "string"},
              "unicode": {"type": "string"},
              "probability": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        },
        "font_issues": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "font_name": {"type": "string"},
              "affected_symbols": {"type": "array", "items": {"type": "string"}},
              "corruption_pattern": {"type": "string"}
            }
          }
        }
      }
    },
    "expected_quality": {
      "type": "object",
      "required": ["quality_score_min", "processing_time_max_ms"],
      "properties": {
        "quality_score_min": {"type": "number", "minimum": 0, "maximum": 1},
        "quality_flags": {"type": "array", "items": {"type": "string"}},
        "processing_time_max_ms": {"type": "integer"},
        "footnote_detection_required": {"type": "boolean"},
        "corruption_recovery_required": {"type": "boolean"},
        "classification_required": {"type": "boolean", "description": "Whether note classification is needed"}
      }
    },
    "validation_criteria": {
      "type": "object",
      "properties": {
        "all_footnotes_detected": {"type": "boolean"},
        "symbols_correctly_inferred": {"type": "boolean"},
        "pairing_complete": {"type": "boolean"},
        "no_false_positives": {"type": "boolean"},
        "confidence_calibrated": {"type": "boolean"},
        "classification_accurate": {"type": "boolean", "description": "All note sources correctly classified"}
      }
    },
    "ml_features": {
      "type": "object",
      "description": "Pre-computed features for ML training and validation",
      "properties": {
        "spatial_features": {
          "type": "object",
          "properties": {
            "page_height": {"type": "number"},
            "footnote_zone_y_start": {"type": "number"},
            "average_marker_distance_from_bottom": {"type": "number"}
          }
        },
        "font_features": {
          "type": "object",
          "properties": {
            "body_font_size_median": {"type": "number"},
            "footnote_font_size": {"type": "number"},
            "size_ratio": {"type": "number"}
          }
        },
        "schema_features": {
          "type": "object",
          "description": "NEW in v3: Schema distribution for classification",
          "properties": {
            "primary_schema": {
              "type": "string",
              "enum": ["numeric", "symbolic", "alphabetic", "roman", "mixed"]
            },
            "alphabetic_count": {"type": "integer"},
            "numeric_count": {"type": "integer"},
            "symbolic_count": {"type": "integer"},
            "schema_transition_points": {"type": "integer"}
          }
        },
        "language_features": {
          "type": "object",
          "description": "NEW in v3: Language patterns for classification",
          "properties": {
            "primary_language": {"type": "string"},
            "footnote_languages": {"type": "array", "items": {"type": "string"}},
            "multilingual": {"type": "boolean"}
          }
        },
        "classification_features": {
          "type": "object",
          "description": "NEW in v3: Indicators for note source classification",
          "properties": {
            "author_indicators": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Patterns indicating author notes (e.g., numeric_schema, philosophical_content)"
            },
            "translator_indicators": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Patterns indicating translator notes (e.g., alphabetic_schema, glosses, foreign_words)"
            },
            "editor_indicators": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Patterns indicating editor notes (e.g., citation_format, contextual_information)"
            }
          }
        }
      }
    }
  },

  "definitions": {
    "footnote_v3": {
      "type": "object",
      "required": ["marker", "definition", "note_source", "classification_confidence", "classification_method"],
      "properties": {
        "page_index": {
          "type": "integer",
          "description": "0-indexed page number"
        },
        "physical_page": {
          "type": "integer",
          "description": "Printed page number on document"
        },
        "marker": {
          "type": "object",
          "required": ["symbol", "location_type"],
          "properties": {
            "symbol": {
              "type": "string",
              "description": "Actual symbol: *, †, ‡, §, ¶, numeric (1,2,3...), or alphabetic (a,b,c...)"
            },
            "unicode": {
              "type": "string",
              "pattern": "^0x[0-9a-fA-F]+$",
              "description": "Unicode code point (e.g., '0x2020' for †, '0x32' for '2')"
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4,
              "description": "[x0, y0, x1, y1] coordinates"
            },
            "location_type": {
              "type": "string",
              "enum": [
                "inline_body",
                "section_heading_suffix",
                "paragraph_end",
                "page_reference_bracket",
                "superscript_inline",
                "margin"
              ]
            },
            "context_before": {
              "type": "string",
              "description": "20-50 chars before marker"
            },
            "context_after": {
              "type": "string",
              "description": "20-50 chars after marker"
            },
            "font": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "size": {"type": "number"},
                "is_superscript": {"type": "boolean"}
              }
            },
            "corruption": {
              "type": "object",
              "description": "How this marker appears in corrupted text layer",
              "properties": {
                "extracted_as": {
                  "type": "string",
                  "description": "What PyMuPDF extracts (e.g., 't' for †)"
                },
                "extraction_reliable": {
                  "type": "boolean",
                  "description": "Whether extraction is trustworthy"
                },
                "corruption_probability": {
                  "type": "number",
                  "description": "P(extracted | actual) learned from corpus"
                }
              }
            }
          }
        },
        "definition": {
          "type": "object",
          "required": ["content"],
          "properties": {
            "content": {
              "type": "string",
              "description": "Full footnote text"
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4,
              "description": "Bounding box of definition region"
            },
            "starts_with_corrupted": {
              "type": "string",
              "description": "How definition starts in corrupted text (e.g., 'iii' or 't')"
            },
            "location_type": {
              "type": "string",
              "enum": ["page_bottom", "chapter_end", "document_end", "margin"]
            },
            "page_index": {"type": "integer"},
            "font": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "size": {"type": "number"},
                "size_ratio_to_body": {"type": "number", "description": "Typically 0.8-0.9 for footnotes"}
              }
            }
          }
        },
        "pairing": {
          "type": "object",
          "description": "Information for validating marker-definition pairing",
          "properties": {
            "spatial_distance": {
              "type": "number",
              "description": "Euclidean distance between marker and definition (pixels)"
            },
            "sequence_position": {
              "type": "integer",
              "description": "Position in footnote sequence (0-indexed)"
            },
            "confidence_min": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Minimum acceptable confidence for correct pairing"
            }
          }
        },
        "schema_info": {
          "type": "object",
          "properties": {
            "schema_type": {
              "type": "string",
              "enum": ["numeric", "symbolic", "alphabetic", "roman", "mixed"]
            },
            "sequence_index": {
              "type": "integer",
              "description": "Position in schema sequence (0 for first *, 1 for †, etc.)"
            },
            "expected_next": {
              "type": "string",
              "description": "Expected next symbol in sequence (for validation)"
            },
            "expected_prev": {
              "type": "string",
              "description": "Expected previous symbol in sequence (for validation)"
            }
          }
        },
        "note_type": {
          "type": "string",
          "enum": ["translator_note", "author_note", "editor_note", "citation", "cross_reference", "explanation"],
          "description": "DEPRECATED in v3: Use note_source instead. Kept for backward compatibility."
        },
        "note_source": {
          "type": "string",
          "enum": ["author", "translator", "editor"],
          "description": "NEW in v3: Who wrote this note (author, translator, or editor)"
        },
        "classification_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "NEW in v3: Confidence in classification (0.0-1.0)"
        },
        "classification_method": {
          "type": "string",
          "enum": [
            "schema_based",
            "content_analysis",
            "linguistic_pattern",
            "position_based",
            "hybrid",
            "manual_verification"
          ],
          "description": "NEW in v3: How classification was determined"
        }
      }
    },

    "endnote_v3": {
      "type": "object",
      "description": "Similar to footnote_v3 but with chapter/section scope",
      "allOf": [{"$ref": "#/definitions/footnote_v3"}],
      "properties": {
        "chapter_number": {"type": "integer"},
        "section_title": {"type": "string"}
      }
    },

    "citation": {
      "type": "object",
      "properties": {
        "page_index": {"type": "integer"},
        "text": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "citation_type": {
          "type": "string",
          "enum": ["author_year", "numeric", "footnote_reference", "stephanus", "bekker", "custom"]
        },
        "author_hint": {"type": "string"},
        "year_hint": {"type": "integer"},
        "work_hint": {"type": "string"}
      }
    },

    "formatting": {
      "type": "object",
      "properties": {
        "page_index": {"type": "integer"},
        "text": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["bold", "italic", "underline", "strikethrough", "sous_erasure", "small_caps"]
          }
        },
        "expected_output": {"type": "string"}
      }
    },

    "xmark": {
      "type": "object",
      "required": ["page_index", "word_under_erasure"],
      "properties": {
        "page_index": {"type": "integer"},
        "word_under_erasure": {"type": "string"},
        "bbox": {"type": "array", "items": {"type": "number"}, "minItems": 4, "maxItems": 4},
        "context_before": {"type": "string"},
        "context_after": {"type": "string"},
        "corrupted_extraction": {"type": "string"},
        "expected_recovery": {"type": "string"},
        "confidence_min": {"type": "number"}
      }
    }
  },

  "classification_guidelines": {
    "author": {
      "description": "Notes written by the original author of the work",
      "typical_markers": ["numeric (1,2,3...)", "sometimes symbolic (*, †)"],
      "typical_content": [
        "Philosophical arguments",
        "Supporting evidence",
        "Cross-references to author's other works",
        "Clarifications of main text"
      ],
      "confidence_indicators": {
        "high": ["Numeric schema in philosophical work", "Content matches author's style"],
        "medium": ["Mixed schema", "Content could be author or editor"],
        "low": ["Symbolic schema only", "Content is purely bibliographic"]
      }
    },
    "translator": {
      "description": "Notes added by translator(s) to aid reader understanding",
      "typical_markers": ["alphabetic (a,b,c...)", "symbolic (*, †, ‡)"],
      "typical_content": [
        "Foreign word translations/glosses",
        "Cultural context",
        "Translation choices explanation",
        "Alternative readings"
      ],
      "confidence_indicators": {
        "high": ["Alphabetic schema + foreign word", "Explicit 'Translator's note'"],
        "medium": ["Symbolic schema in modern edition", "Contextual information"],
        "low": ["Numeric schema", "Philosophical content"]
      }
    },
    "editor": {
      "description": "Notes added by scholarly editors",
      "typical_markers": ["alphabetic (a,b,c...)", "symbolic (*, †, ‡)", "bracketed numbers"],
      "typical_content": [
        "Citations to other works",
        "Historical context",
        "Textual variants",
        "Editorial corrections"
      ],
      "confidence_indicators": {
        "high": ["Citation format", "Textual apparatus", "Historical dating"],
        "medium": ["Long explanatory notes", "References to other scholars"],
        "low": ["Short glosses", "Simple translations"]
      }
    }
  },

  "classification_method_definitions": {
    "schema_based": {
      "description": "Classification based on footnote marker schema (numeric=author, alphabetic=translator)",
      "confidence_range": "0.85-0.95",
      "examples": ["Kant numeric → author", "Derrida symbolic → translator"]
    },
    "content_analysis": {
      "description": "Classification based on footnote content analysis (language, style, references)",
      "confidence_range": "0.75-0.92",
      "examples": ["German gloss → translator", "Ovid citation → editor"]
    },
    "linguistic_pattern": {
      "description": "Classification based on linguistic patterns (single foreign words, grammatical glosses)",
      "confidence_range": "0.90-0.95",
      "examples": ["Single German word → translator", "Latin grammatical form → translator"]
    },
    "position_based": {
      "description": "Classification based on position in document (endnotes=author, footnotes=translator)",
      "confidence_range": "0.70-0.85",
      "examples": ["Page-bottom gloss → translator", "Chapter-end discussion → author"]
    },
    "hybrid": {
      "description": "Multiple classification methods combined",
      "confidence_range": "0.85-0.98",
      "examples": ["Alphabetic schema + German word + page-bottom → translator (0.95)"]
    },
    "manual_verification": {
      "description": "Human verification of classification",
      "confidence_range": "0.95-1.00",
      "examples": ["Visual inspection confirmed translator note"]
    }
  }
}
