# Codebase Structure

**Analysis Date:** 2026-01-28

## Directory Layout

```
zlibrary-mcp/
├── src/                        # TypeScript source (Node.js/MCP layer)
│   ├── index.ts               # MCP server entry point, tool definitions, handlers
│   └── lib/                   # TypeScript utility modules
│       ├── zlibrary-api.ts    # API bridge to Python
│       ├── retry-manager.ts   # Exponential backoff retry logic
│       ├── circuit-breaker.ts # Circuit breaker pattern
│       ├── errors.ts          # Custom error types
│       ├── venv-manager.ts    # Python virtual environment management
│       ├── paths.ts           # Path resolution helpers
│       └── python-bridge.ts   # PythonShell wrapper (minimal use)
├── lib/                       # Python source (Z-Library/RAG layer)
│   ├── python_bridge.py       # Python entry point, main search/download logic
│   ├── rag_processing.py      # Document extraction (PDF/EPUB/TXT)
│   ├── enhanced_metadata.py   # Rich metadata extraction from book pages
│   ├── advanced_search.py     # Multi-parameter search implementation
│   ├── author_tools.py        # Author-specific search
│   ├── booklist_tools.py      # Booklist fetching and parsing
│   ├── metadata_generator.py  # Metadata sidecar creation
│   ├── metadata_verification.py # Output validation
│   ├── footnote_continuation.py # Multi-page footnote tracking
│   ├── footnote_corruption_model.py # Bayesian symbol recovery
│   ├── note_classification.py # Note type attribution
│   ├── garbled_text_detection.py # Quality validation
│   ├── marginalia_extraction.py # Annotation extraction
│   ├── formatting_group_merger.py # Markdown generation
│   ├── filename_utils.py      # Filename sanitization
│   ├── client_manager.py      # Z-Library client lifecycle
│   ├── quality_verification.py # Output QA
│   ├── rag_data_models.py     # Data structures for RAG output
│   └── __init__.py            # Package marker
├── zlibrary/                  # Vendored Z-Library fork (custom modifications)
│   └── src/zlibrary/          # Modified zlibrary package
├── dist/                      # Compiled JavaScript (generated by npm run build)
│   ├── index.js              # Compiled MCP server
│   └── lib/                  # Compiled TypeScript utilities
├── __tests__/                 # Jest + Pytest test suites
│   ├── *.test.js             # Node.js unit tests
│   ├── python/               # Python unit tests
│   └── integration/          # End-to-end integration tests
├── test_files/               # Test fixtures and reference data
│   ├── ground_truth/         # Expected extraction outputs
│   ├── expected_outputs/     # Validation references
│   └── *.pdf, *.epub         # Test documents
├── downloads/                # Runtime: Downloaded books (gitignored)
├── processed_rag_output/     # Runtime: Extracted text files (gitignored)
├── logs/                     # Runtime: Debug logs (gitignored)
├── docs/                     # Documentation
│   ├── adr/                  # Architecture Decision Records
│   ├── specifications/       # Technical specifications
│   └── examples/             # Usage examples
├── .claude/                  # Claude project context
│   ├── PROJECT_CONTEXT.md    # Mission, architecture overview
│   ├── ROADMAP.md            # Development priorities
│   ├── PATTERNS.md           # Code patterns to follow
│   ├── TDD_WORKFLOW.md       # Testing methodology
│   └── ARCHITECTURE.md       # Detailed architecture reference
├── .planning/                # GSD planning documents
│   └── codebase/             # This analysis
├── docker/                   # Docker configuration
├── claudedocs/               # Session notes, research, reports
├── package.json              # Node.js dependencies
├── pyproject.toml            # Python dependencies (UV-managed)
├── tsconfig.json             # TypeScript configuration
├── jest.config.js            # Jest test runner config
├── pytest.ini                # Pytest configuration
└── CLAUDE.md                 # This file (quick start guide)
```

## Directory Purposes

**src/:**
- Purpose: TypeScript source code for MCP server and integration layer
- Contains: Server initialization, tool handlers, API bridge, resilience infrastructure
- Key files: `index.ts` (775 lines, tool registry), `zlibrary-api.ts` (API bridge with retry/circuit-breaker)
- Compiled to: `dist/` during `npm run build`

**lib/:**
- Purpose: Python implementation of Z-Library operations and document processing
- Contains: Search logic, downloads, RAG extraction, metadata, validation
- Key files:
  - `python_bridge.py` (775 lines): Entry point for all Python operations
  - `rag_processing.py`: PDF/EPUB/TXT extraction with footnote recovery
  - `advanced_search.py`: Multi-filter search orchestration
  - `enhanced_metadata.py`: Rich metadata extraction (60+ terms, booklists)
- Pattern: Each module = single concern (search, metadata, validation, recovery)

**dist/:**
- Purpose: Compiled JavaScript output from TypeScript build
- Generated by: `npm run build` (tsc)
- Contains: Exact same structure as `src/` but as JavaScript
- Runtime: Node.js executes from `dist/index.js`
- Note: NOT committed (generated artifact)

**zlibrary/:**
- Purpose: Vendored fork of sertraline/zlibrary with custom modifications
- Why vendored: Z-Library API changes frequently; custom fork ensures stability
- Used by: Python layer via `from zlibrary import AsyncZlib, Extension, Language`
- Installation: `pip install -e ./zlibrary` (editable mode in requirements.txt)

**__tests__/:**
- Purpose: Test suites for Node.js (Jest) and Python (Pytest)
- Structure:
  - `*.test.js`: Jest tests for TypeScript code (unit + integration)
  - `python/`: Pytest tests for Python code
  - `integration/`: End-to-end tests (mcp-protocol, python-bridge)
- Fixtures: `test_files/` contains real PDFs, EPUBs for testing
- Ground truth: `test_files/ground_truth/` has expected extraction outputs

**test_files/:**
- Purpose: Test data and reference materials
- Contents:
  - Real documents: Sample PDFs, EPUBs for extraction testing
  - ground_truth/: Expected extraction outputs (JSON/text)
  - expected_outputs/: Validation references
- Usage: Tests compare extraction output against ground truth
- Not committed: Large files, but crucial for TDD

**logs/:**
- Purpose: Runtime debug logging
- Files: `nodejs_debug.log` (handler args/responses)
- Created at: Runtime by `logs/` directory ensure calls
- Retention: Manual cleanup (not auto-cleared)

**downloads/:**
- Purpose: Downloaded books from Z-Library
- Created by: `download_book_to_file` tool
- Location: Configurable via tool parameter (default: `./downloads/`)
- Cleanup: Manual or via scripts

**processed_rag_output/:**
- Purpose: RAG-processed text files
- Created by: `process_document_for_rag` tool or download with process_for_rag=true
- Format: Text files + metadata sidecars (YAML frontmatter)
- Naming: `{book-id}_{title}_extracted.txt` with `{book-id}_{title}.metadata.json`

**docs/:**
- Purpose: Project documentation
- Contents:
  - `adr/`: Architecture Decision Records (ADR-001 through ADR-NNN)
  - `specifications/`: Technical specs (RAG pipeline, metadata, search)
  - `examples/`: Usage examples and tutorials
  - Various analysis documents (architecture, deployment, etc.)

**.claude/:**
- Purpose: Context documents for Claude development
- Key files:
  - `PROJECT_CONTEXT.md`: Mission, architecture principles
  - `ROADMAP.md`: Current development priorities (1-3 weeks)
  - `PATTERNS.md`: Code patterns for consistency
  - `TDD_WORKFLOW.md`: Testing methodology for RAG features
  - `VERSION_CONTROL.md`: Git workflow and conventions

.**.planning/codebase/:**
- Purpose: GSD-generated codebase analysis (THIS ANALYSIS)
- Contents: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md, INTEGRATIONS.md, STACK.md
- Used by: `/gsd:plan-phase` and `/gsd:execute-phase` commands

## Key File Locations

**Entry Points:**
- `src/index.ts` (775 lines): MCP server initialization, tool registry, handler implementations
- `lib/python_bridge.py` (775 lines): Python entry point for all operations
- `index.js`: ESM wrapper (minimal)

**Configuration:**
- `package.json`: Node.js dependencies (zod, python-shell, MCP SDK)
- `pyproject.toml`: Python dependencies (asynczlib, ebooklib, pymupdf, etc.)
- `tsconfig.json`: TypeScript compiler settings (ESM, target ES2022)
- `jest.config.js`: Jest configuration (ESM mode, module name mapper)
- `pytest.ini`: Pytest configuration (test discovery)

**Core Logic:**
- `src/lib/zlibrary-api.ts` (500+ lines): API bridge, search/download implementation
- `lib/python_bridge.py` (775 lines): Z-Library operations, search/download/metadata
- `lib/rag_processing.py` (2000+ lines): Document extraction with advanced recovery
- `lib/enhanced_metadata.py`: Metadata extraction (60+ terms, booklists)

**Resilience:**
- `src/lib/retry-manager.ts` (124 lines): Exponential backoff
- `src/lib/circuit-breaker.ts` (109 lines): Circuit breaker state machine
- `src/lib/errors.ts` (123 lines): Error type hierarchy

**Testing:**
- `__tests__/index.test.js`: MCP server tests
- `__tests__/zlibrary-api.test.js`: API bridge tests
- `__tests__/python/test_rag_processing.py`: RAG extraction tests
- `__tests__/integration/mcp-protocol.test.js`: MCP protocol compliance
- `__tests__/integration/python-bridge-integration.test.js`: Python bridge tests

## Naming Conventions

**Files:**
- TypeScript: `camelCase.ts` (e.g., `zlibrary-api.ts`, `retry-manager.ts`)
- Python: `snake_case.py` (e.g., `python_bridge.py`, `rag_processing.py`)
- Tests: `*.test.js` (Jest), `test_*.py` (Pytest)
- Config: `lowercase-with-extension` (e.g., `tsconfig.json`, `jest.config.js`)

**Functions:**
- TypeScript: `camelCase` (e.g., `searchBooks()`, `callPythonFunction()`, `withRetry()`)
- Python: `snake_case` (e.g., `search()`, `download_book()`, `process_document_for_rag()`)

**Variables:**
- TypeScript: `camelCase` (e.g., `searchBooksParamsSchema`, `toolRegistry`)
- Python: `snake_case` (e.g., `python_args`, `venv_python_path`)

**Types/Classes:**
- TypeScript: `PascalCase` (e.g., `SearchBooksArgs`, `ToolRegistryEntry`, `ZLibraryError`)
- Python: `PascalCase` (e.g., `CircuitBreaker`, `GarbledDetectionResult`)

**Constants:**
- SCREAMING_SNAKE_CASE (e.g., `DEFAULT_HEADERS`, `BRIDGE_SCRIPT_PATH`, `RETRY_MAX_RETRIES`)

**Zod Schemas:**
- Pattern: `[Feature]ParamsSchema` (input), `[Feature]OutputSchema` (output)
- Examples: `SearchBooksParamsSchema`, `DownloadBookToFileOutputSchema`

## Where to Add New Code

**New Feature (Search/Download variant):**
- Python implementation: `lib/[feature_name].py` (new module)
- TypeScript bridge: Add method to `src/lib/zlibrary-api.ts`
- Tool handler: Add to `handlers` object in `src/index.ts`
- Tool registry: Add entry to `toolRegistry` in `src/index.ts` with schemas
- Tests:
  - Node.js: `__tests__/[feature_name].test.js`
  - Python: `__tests__/python/test_[feature_name].py`
  - Integration: `__tests__/integration/[feature_name].test.js` if cross-layer

**New Component/Module (Processing utility):**
- Implementation: `lib/[component_name].py`
- Purpose: Keep concerns separated (search, metadata, RAG, validation, etc.)
- Import in: `lib/python_bridge.py` and dependent modules
- Tests: `__tests__/python/test_[component_name].py`
- Example: `lib/footnote_corruption_model.py` (new recovery algorithm)

**Utilities:**
- Shared TypeScript helpers: `src/lib/[utility_name].ts`
- Shared Python helpers: `lib/[utility_name].py`
- Examples: `paths.ts`, `filename_utils.py`

**Resilience Enhancement:**
- Retry logic changes: `src/lib/retry-manager.ts`
- Circuit breaker tuning: `src/lib/circuit-breaker.ts` + env vars
- Error classification: Add case to `isRetryableError()` in `retry-manager.ts`

**Error Handling:**
- New error types: `src/lib/errors.ts`
- Error wrapping patterns: Follow `PythonBridgeError` example
- Logging context: Attach {functionName, args, context} to errors

## Special Directories

**downloads/:**
- Purpose: Storage for downloaded books
- Generated: Yes (at runtime)
- Committed: No (.gitignore'd)
- Structure: `{book-id}_{title}.{extension}` (e.g., `12345_sapiens.pdf`)

**processed_rag_output/:**
- Purpose: Storage for RAG-extracted text and metadata
- Generated: Yes (at runtime)
- Committed: No (.gitignore'd)
- Structure:
  - `{book-id}_{title}_extracted.txt` (extracted text)
  - `{book-id}_{title}.metadata.json` (metadata sidecar)

**dist/:**
- Purpose: Compiled JavaScript from TypeScript
- Generated: Yes (npm run build)
- Committed: No (.gitignore'd)
- Structure: Mirrors src/ directory layout

**logs/:**
- Purpose: Debug and operational logs
- Generated: Yes (at runtime)
- Committed: No (.gitignore'd)
- Files: `nodejs_debug.log` (handler args/responses)

**.venv/:**
- Purpose: UV-managed Python virtual environment
- Generated: Yes (uv sync)
- Committed: No (.gitignore'd)
- Location: Project root (portable, moves with project)
- Python executable: `.venv/bin/python`

---

*Structure analysis: 2026-01-28*
