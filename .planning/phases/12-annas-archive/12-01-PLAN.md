---
phase: 12-annas-archive
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/sources/__init__.py
  - lib/sources/models.py
  - lib/sources/config.py
  - lib/sources/base.py
autonomous: true

must_haves:
  truths:
    - "UnifiedBookResult dataclass has fields: md5, title, author, year, extension, size, source, download_url, extra"
    - "SourceConfig loads ANNAS_SECRET_KEY, ANNAS_BASE_URL, LIBGEN_MIRROR, BOOK_SOURCE_DEFAULT from environment"
    - "SourceAdapter ABC defines search() and get_download_url() abstract methods"
  artifacts:
    - path: "lib/sources/__init__.py"
      provides: "Package exports for sources module"
      min_lines: 5
    - path: "lib/sources/models.py"
      provides: "UnifiedBookResult, DownloadResult, QuotaInfo dataclasses, SourceType enum"
      exports: ["UnifiedBookResult", "DownloadResult", "QuotaInfo", "SourceType"]
    - path: "lib/sources/config.py"
      provides: "SourceConfig with environment variable loading"
      exports: ["SourceConfig", "get_source_config"]
    - path: "lib/sources/base.py"
      provides: "SourceAdapter abstract base class"
      exports: ["SourceAdapter"]
  key_links:
    - from: "lib/sources/base.py"
      to: "lib/sources/models.py"
      via: "imports UnifiedBookResult, DownloadResult for type hints"
      pattern: "from .models import"
---

<objective>
Create foundation data models, configuration, and abstract base class for multi-source book search system.

Purpose: Establish typed interfaces that Anna's Archive and LibGen adapters will implement. Ensures consistent result format across sources.
Output: lib/sources/ package with models.py, config.py, base.py, and __init__.py
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-annas-archive/12-CONTEXT.md
@.planning/phases/12-annas-archive/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data models</name>
  <files>lib/sources/models.py</files>
  <action>
Create lib/sources/models.py with:

1. SourceType enum:
```python
class SourceType(str, Enum):
    ANNAS_ARCHIVE = "annas_archive"
    LIBGEN = "libgen"
```

2. UnifiedBookResult dataclass:
```python
@dataclass
class UnifiedBookResult:
    md5: str
    title: str
    source: SourceType
    author: str = ""
    year: str = ""
    extension: str = ""
    size: str = ""
    download_url: str = ""
    extra: dict = field(default_factory=dict)
```

3. QuotaInfo dataclass:
```python
@dataclass
class QuotaInfo:
    downloads_left: int
    downloads_per_day: int
    downloads_done_today: int
```

4. DownloadResult dataclass:
```python
@dataclass
class DownloadResult:
    url: str
    source: SourceType
    quota_info: Optional[QuotaInfo] = None
```

Use stdlib only: dataclasses, enum, typing. Follow PIPELINE-MODELS-STDLIB decision.
  </action>
  <verify>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run python -c "from lib.sources.models import UnifiedBookResult, DownloadResult, QuotaInfo, SourceType; print('Models imported successfully')"
```
  </verify>
  <done>All 4 model classes can be imported and instantiated without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create configuration loader</name>
  <files>lib/sources/config.py</files>
  <action>
Create lib/sources/config.py with:

1. SourceConfig dataclass:
```python
@dataclass
class SourceConfig:
    annas_secret_key: str = ""
    annas_base_url: str = "https://annas-archive.li"
    libgen_mirror: str = "li"
    default_source: str = "auto"  # 'auto' | 'annas' | 'libgen'
    fallback_enabled: bool = True

    @property
    def has_annas_key(self) -> bool:
        return bool(self.annas_secret_key)
```

2. get_source_config() function:
```python
def get_source_config() -> SourceConfig:
    """Load configuration from environment variables."""
    return SourceConfig(
        annas_secret_key=os.environ.get("ANNAS_SECRET_KEY", ""),
        annas_base_url=os.environ.get("ANNAS_BASE_URL", "https://annas-archive.li"),
        libgen_mirror=os.environ.get("LIBGEN_MIRROR", "li"),
        default_source=os.environ.get("BOOK_SOURCE_DEFAULT", "auto"),
        fallback_enabled=os.environ.get("BOOK_SOURCE_FALLBACK_ENABLED", "true").lower() == "true",
    )
```

Note: Config is loaded fresh each call (not cached) to support env var changes during testing.
  </action>
  <verify>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run python -c "from lib.sources.config import get_source_config, SourceConfig; cfg = get_source_config(); print(f'Config loaded: default_source={cfg.default_source}')"
```
  </verify>
  <done>Configuration loads from environment, defaults work when env vars not set</done>
</task>

<task type="auto">
  <name>Task 3: Create abstract base class and package init</name>
  <files>lib/sources/base.py, lib/sources/__init__.py</files>
  <action>
1. Create lib/sources/base.py with SourceAdapter ABC:
```python
from abc import ABC, abstractmethod
from typing import List
from .models import UnifiedBookResult, DownloadResult

class SourceAdapter(ABC):
    """Abstract base class for book source adapters."""

    @abstractmethod
    async def search(self, query: str, **kwargs) -> List[UnifiedBookResult]:
        """Search for books matching query."""
        pass

    @abstractmethod
    async def get_download_url(self, md5: str) -> DownloadResult:
        """Get download URL for a book by MD5 hash."""
        pass

    @abstractmethod
    async def close(self) -> None:
        """Clean up resources."""
        pass
```

2. Create lib/sources/__init__.py with exports:
```python
"""Multi-source book search adapters."""
from .models import UnifiedBookResult, DownloadResult, QuotaInfo, SourceType
from .config import SourceConfig, get_source_config
from .base import SourceAdapter

__all__ = [
    "UnifiedBookResult",
    "DownloadResult",
    "QuotaInfo",
    "SourceType",
    "SourceConfig",
    "get_source_config",
    "SourceAdapter",
]
```
  </action>
  <verify>
```bash
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run python -c "from lib.sources import UnifiedBookResult, SourceAdapter, get_source_config; print('Package exports working')"
```
  </verify>
  <done>SourceAdapter ABC can be imported and subclassed, package __init__ exports all public symbols</done>
</task>

</tasks>

<verification>
```bash
# Verify all models and config work together
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run python -c "
from lib.sources import UnifiedBookResult, DownloadResult, QuotaInfo, SourceType, get_source_config, SourceAdapter

# Test models
book = UnifiedBookResult(md5='abc123', title='Test', source=SourceType.ANNAS_ARCHIVE)
print(f'Book: {book.title} from {book.source.value}')

quota = QuotaInfo(downloads_left=24, downloads_per_day=25, downloads_done_today=1)
print(f'Quota: {quota.downloads_left}/{quota.downloads_per_day}')

result = DownloadResult(url='http://example.com', source=SourceType.LIBGEN)
print(f'Download: {result.source.value}')

# Test config
cfg = get_source_config()
print(f'Config: default={cfg.default_source}, fallback={cfg.fallback_enabled}')

print('All foundation models working!')
"
```
</verification>

<success_criteria>
1. lib/sources/ package exists with __init__.py, models.py, config.py, base.py
2. All dataclasses can be instantiated with required and optional fields
3. SourceType enum has ANNAS_ARCHIVE and LIBGEN values
4. get_source_config() returns SourceConfig with defaults
5. SourceAdapter ABC can be imported and defines search/get_download_url methods
</success_criteria>

<output>
After completion, create `.planning/phases/12-annas-archive/12-01-SUMMARY.md`
</output>
