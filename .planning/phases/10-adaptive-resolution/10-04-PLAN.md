---
phase: 10-adaptive-resolution
plan: 04
type: execute
wave: 2
depends_on: ["10-03"]
files_modified:
  - lib/rag/orchestrator_pdf.py
  - lib/rag/ocr/recovery.py
  - lib/rag/quality/ocr_stage.py
  - __tests__/python/test_adaptive_integration.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Footnote and margin regions within a page re-render at higher DPI than the page default"
    - "OCR output includes text from region re-renders (not just page-level render)"
    - "Pages without small-text regions behave identically to before (no regression)"
  artifacts:
    - path: "lib/rag/orchestrator_pdf.py"
      provides: "Passes full PageAnalysis dict (not just DPIDecision) to OCR functions"
      contains: "render_page_adaptive"
    - path: "lib/rag/ocr/recovery.py"
      provides: "Uses render_page_adaptive for rendering, OCRs region_images separately"
      contains: "AdaptiveRenderResult"
    - path: "lib/rag/quality/ocr_stage.py"
      provides: "Uses render_page_adaptive for rendering, OCRs region_images separately"
      contains: "AdaptiveRenderResult"
    - path: "__tests__/python/test_adaptive_integration.py"
      provides: "Integration test proving region re-rendering works end-to-end"
      contains: "region_images"
  key_links:
    - from: "orchestrator_pdf.py"
      to: "ocr/recovery.py"
      via: "page_analysis_map parameter (Dict[int, PageAnalysis])"
      pattern: "page_analysis_map"
    - from: "ocr/recovery.py"
      to: "resolution/renderer.py"
      via: "render_page_adaptive(page, analysis)"
      pattern: "render_page_adaptive"
    - from: "quality/ocr_stage.py"
      to: "resolution/renderer.py"
      via: "render_page_adaptive(page, analysis)"
      pattern: "render_page_adaptive"
---

<objective>
Wire the existing adaptive renderer into the production OCR pipeline so that footnote and margin regions are re-rendered at higher DPI independently of the page default.

Purpose: Close the single remaining gap from Phase 10 verification — DPI-02 (region-level DPI targeting). The renderer module is fully implemented and tested (19/19 tests pass) but never called in production.

Output: Modified orchestrator + OCR functions that call `render_page_adaptive` and process `region_images`, plus integration test proving region re-rendering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-adaptive-resolution/10-VERIFICATION.md
@.planning/phases/10-adaptive-resolution/10-03-SUMMARY.md
@lib/rag/resolution/renderer.py
@lib/rag/resolution/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire adaptive renderer into orchestrator and OCR functions</name>
  <files>
    lib/rag/orchestrator_pdf.py
    lib/rag/ocr/recovery.py
    lib/rag/quality/ocr_stage.py
  </files>
  <action>
    **Orchestrator (lib/rag/orchestrator_pdf.py):**
    1. Change `page_dpi_map` to `page_analysis_map` — preserve full `PageAnalysis` objects instead of extracting just `analysis.page_dpi`:
       - Line ~240-243: Change from `{page_num: analysis.page_dpi for ...}` to `{page_num: analysis for page_num, analysis in font_analysis.items()}`
       - Update logging to use `analysis.page_dpi.dpi` instead of `d.dpi`
       - Pass `page_analysis_map` (not `page_dpi_map`) to `_run_ocr_on_pdf` and quality stage calls
    2. Add import: `from lib.rag.resolution.renderer import render_page_adaptive, AdaptiveRenderResult`

    **OCR recovery (lib/rag/ocr/recovery.py):**
    1. Rename parameter `page_dpi_map` to `page_analysis_map` (type `Dict[int, PageAnalysis]` or None)
    2. Add imports: `from lib.rag.resolution.renderer import render_page_adaptive, AdaptiveRenderResult` and `from lib.rag.resolution.models import PageAnalysis`
    3. Replace the rendering block (lines ~280-286):
       - If `page_analysis_map` has entry for `page_num`, call `render_page_adaptive(page, page_analysis_map[page_num])` to get `AdaptiveRenderResult`
       - Use `result.page_image` for main page OCR (convert PIL Image to bytes for Tesseract)
       - For each `(region, region_img)` in `result.region_images`, OCR the region image and append text with a marker like `[Region: {region.region_type}]`
       - If no analysis entry, fall back to `page.get_pixmap(dpi=300)` as before
    4. Keep backward compatibility: if `page_analysis_map` is None or empty, behavior is identical to current

    **OCR quality stage (lib/rag/quality/ocr_stage.py):**
    1. Same pattern as recovery.py: rename param, add imports, use `render_page_adaptive` when analysis available
    2. For the quality stage, region OCR text should be appended to `recovered_text` so quality comparison includes it
    3. Fall back to `page.get_pixmap(dpi=300)` when no analysis available

    **IMPORTANT — backward compatibility:**
    - When `page_analysis_map` is None/empty, both functions must behave exactly as before (dpi=300 default)
    - The `page_dpi_map` parameter name changes to `page_analysis_map` — update ALL callers in orchestrator
    - PIL Image → Tesseract: use `pytesseract.image_to_string(pil_image)` directly (Tesseract accepts PIL)
  </action>
  <verify>
    Run: `uv run pytest __tests__/python/test_adaptive_integration.py -v`
    All 8 existing integration tests must still pass (backward compat).
    Run: `uv run pytest __tests__/python/ -v --timeout=120` — no regressions across test suite.
  </verify>
  <done>
    `render_page_adaptive` is called in production pipeline when page_analysis_map is available.
    `AdaptiveRenderResult.region_images` are OCR'd and text appended to output.
    Existing tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for region re-rendering in pipeline</name>
  <files>
    __tests__/python/test_adaptive_integration.py
  </files>
  <action>
    Add a new test (or tests) to `test_adaptive_integration.py` that proves region re-rendering works end-to-end:

    1. **test_region_rerendering_wired_in_pipeline**: Mock a PDF where `analyze_document_fonts` returns a `PageAnalysis` with `has_small_text=True` and at least one `RegionDPI` entry (e.g., a footnote region at bbox (50, 700, 500, 780) with dpi=400). Verify that:
       - `render_page_adaptive` is called (not `page.get_pixmap` directly)
       - The region image is OCR'd separately
       - The combined OCR output contains text from both page and region renders

    2. **test_no_regions_falls_back_to_page_only**: Mock a `PageAnalysis` with `regions=[]` and `has_small_text=False`. Verify `render_page_adaptive` still works but produces no region_images, and pipeline behaves identically to page-only rendering.

    3. **test_backward_compat_no_analysis_map**: Call OCR function with `page_analysis_map=None`. Verify it falls back to `page.get_pixmap(dpi=300)` exactly as before.

    Use `unittest.mock.patch` to mock `render_page_adaptive` return values and verify call arguments. The test should prove the WIRING, not re-test the renderer itself (that's already covered by 19 renderer tests).
  </action>
  <verify>
    Run: `uv run pytest __tests__/python/test_adaptive_integration.py -v`
    New tests pass. Total test count increases by 2-3.
    Run: `uv run pytest __tests__/python/ -v --timeout=120` — full suite green.
  </verify>
  <done>
    Integration tests prove: (1) region re-rendering is wired, (2) fallback works, (3) backward compat maintained.
    DPI-02 requirement is now testably satisfied.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest __tests__/python/ -v --timeout=120` — all tests pass, no regressions
2. `grep -n "render_page_adaptive" lib/rag/orchestrator_pdf.py lib/rag/ocr/recovery.py lib/rag/quality/ocr_stage.py` — renderer is imported and called in all three files
3. `grep -n "region_images" lib/rag/ocr/recovery.py lib/rag/quality/ocr_stage.py` — region images are processed in both OCR paths
4. `grep -n "page.get_pixmap" lib/rag/ocr/recovery.py lib/rag/quality/ocr_stage.py` — only appears in fallback path (when no analysis available)
</verification>

<success_criteria>
- DPI-02 (region-level DPI targeting) is SATISFIED: footnote/margin regions re-render at higher DPI than page default
- All existing tests pass (zero regressions)
- New integration tests prove region re-rendering is wired end-to-end
- Phase 10 verification score moves from 2/3 to 3/3
</success_criteria>

<output>
After completion, create `.planning/phases/10-adaptive-resolution/10-04-SUMMARY.md`
</output>
