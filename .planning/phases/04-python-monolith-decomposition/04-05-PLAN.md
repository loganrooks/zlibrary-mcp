---
phase: 04-python-monolith-decomposition
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rag/orchestrator.py
  - lib/rag/orchestrator_pdf.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "orchestrator.py is under 500 lines"
    - "All existing imports from orchestrator.py still work"
    - "All Python tests pass without test file modifications"
  artifacts:
    - path: "lib/rag/orchestrator_pdf.py"
      provides: "The process_pdf function and its helpers"
      contains: "def process_pdf"
  key_links:
    - from: "lib/rag/orchestrator.py"
      to: "orchestrator_pdf.py"
      via: "import and re-export"
      pattern: "from lib.rag.orchestrator_pdf import process_pdf"
---

<objective>
Extract the 481-line process_pdf function from orchestrator.py (814 lines) into orchestrator_pdf.py to meet the 500-line limit.

Purpose: Close gap from VERIFICATION.md — Success Criteria #1 requires orchestrator.py <= 500.
Output: orchestrator_pdf.py contains process_pdf (~500 lines with imports). orchestrator.py becomes ~340 lines (imports, _get_facade, process_document, save_processed_text + re-export of process_pdf).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-python-monolith-decomposition/04-VERIFICATION.md
@lib/rag/orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract process_pdf to orchestrator_pdf.py</name>
  <files>
    lib/rag/orchestrator_pdf.py
    lib/rag/orchestrator.py
  </files>
  <action>
**orchestrator_pdf.py** (~500 lines) — the PDF processing pipeline:
- Move: `process_pdf` function (L108-588, 481 lines)
- Add all imports that process_pdf needs. Looking at orchestrator.py imports (L1-94), process_pdf uses:
  - asyncio, logging, os, subprocess, Path
  - fitz (PyMuPDF), pytesseract, convert_from_path, Image, cv2, np (all optional with try/except)
  - All the `from lib.rag.*` imports that process_pdf calls (utils, detection, ocr, quality, xmark, processors)
  - CrossPageFootnoteParser from lib.footnote_continuation
  - OCR_AVAILABLE, PYMUPDF_AVAILABLE, XMARK_AVAILABLE flags (define locally with same try/except blocks)
  - `_get_facade` helper (copy the 4-line function)
- Add `__all__ = ['process_pdf']`, logger, docstring

**orchestrator.py** (~340 lines) — keep remaining entry points:
- Keep: all current imports, `_get_facade`, `process_document` (L591-662), `save_processed_text` (L664-814)
- Remove: `process_pdf` function body
- Add: `from lib.rag.orchestrator_pdf import process_pdf`
- Update `__all__` (if present) or the module-level exports to include `process_pdf` via re-export
- Note: `process_document` calls `process_pdf` internally — the imported version will be used automatically

**rag_processing.py facade** — no changes needed. It imports `process_pdf` from `lib.rag.orchestrator`, which will re-export it.

CRITICAL: `from lib.rag.orchestrator import process_pdf` must still work. The re-export in orchestrator.py handles this.
  </action>
  <verify>
    Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && python3 -c "from lib.rag.orchestrator import process_pdf, process_document, save_processed_text; print('OK')"` returns OK.
    Run: `cd /home/rookslog/workspace/projects/zlibrary-mcp && python3 -c "from lib.rag_processing import process_pdf, process_document_for_rag, save_processed_text; print('OK')"` returns OK.
    Run: `wc -l lib/rag/orchestrator.py lib/rag/orchestrator_pdf.py` — orchestrator.py <= 500.
  </verify>
  <done>orchestrator.py is under 500 lines. process_pdf importable from both orchestrator and facade.</done>
</task>

</tasks>

<verification>
1. `wc -l lib/rag/orchestrator.py` <= 500
2. `cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run pytest` — all 695 Python tests pass
3. `cd /home/rookslog/workspace/projects/zlibrary-mcp && node --experimental-vm-modules node_modules/jest/bin/jest.js` — all 138 Node.js tests pass
4. No test files modified (git diff should show zero changes in __tests__/)
</verification>

<success_criteria>
- orchestrator.py <= 500 lines with all original exports intact
- All Python and Node.js tests pass without test file modifications
</success_criteria>

<output>
After completion, create `.planning/phases/04-python-monolith-decomposition/04-05-SUMMARY.md`
</output>
