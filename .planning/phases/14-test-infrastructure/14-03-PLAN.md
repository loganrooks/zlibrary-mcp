---
phase: 14-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - .github/workflows/ci.yml
  - debug_asterisk_full_search.py
  - debug_find_asterisk_anywhere.py
  - debug_kant_page2_asterisk.py
  - debug_kant_page3_content.py
  - debug_page2_block10_11.py
  - debug_page3_block8_full.py
  - debug_page3_continuation.py
  - multi_corpus_validation.py
  - test_footnote_validation.py
  - test_kant_page2_debug.py
autonomous: true

must_haves:
  truths:
    - "No .py test or debug files exist at the repo root"
    - "CI runs fast tests (`-m 'not slow and not integration'`) on every PR"
    - "CI provides a way to run the full test suite (push to master or manual trigger)"
    - "All relocated scripts are reachable at their new locations"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Fast/full CI split with workflow_dispatch"
      contains: "not slow and not integration"
    - path: "scripts/debugging/debug_asterisk_full_search.py"
      provides: "Relocated debug script"
    - path: "scripts/archive/test_footnote_validation.py"
      provides: "Relocated test script"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pytest.ini markers"
      via: "-m flag in pytest invocation"
      pattern: 'pytest -m "not slow and not integration"'
---

<objective>
Move scattered root Python files to proper locations and split CI into fast/full test paths.

Purpose: Clean repo root of debug/test scripts (prerequisite for Phase 15 cleanup) and enable CI to give fast PR feedback by running only unit tests, with the full suite available on push-to-master and manual trigger.

Output: 10 Python files relocated from repo root to scripts/. CI workflow split into test-fast (every PR) and test-full (push + manual trigger) jobs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-test-infrastructure/14-RESEARCH.md
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Relocate Python files from repo root to scripts/</name>
  <files>
    debug_asterisk_full_search.py
    debug_find_asterisk_anywhere.py
    debug_kant_page2_asterisk.py
    debug_kant_page3_content.py
    debug_page2_block10_11.py
    debug_page3_block8_full.py
    debug_page3_continuation.py
    multi_corpus_validation.py
    test_footnote_validation.py
    test_kant_page2_debug.py
  </files>
  <action>
Move 10 Python files from the repo root to subdirectories under `scripts/`. Use `git mv` to preserve history.

**Debug scripts → scripts/debugging/**
```bash
git mv debug_asterisk_full_search.py scripts/debugging/
git mv debug_find_asterisk_anywhere.py scripts/debugging/
git mv debug_kant_page2_asterisk.py scripts/debugging/
git mv debug_kant_page3_content.py scripts/debugging/
git mv debug_page2_block10_11.py scripts/debugging/
git mv debug_page3_block8_full.py scripts/debugging/
git mv debug_page3_continuation.py scripts/debugging/
```

**Validation script → scripts/validation/**
```bash
git mv multi_corpus_validation.py scripts/validation/
```

**Test-like scripts → scripts/archive/**
```bash
git mv test_footnote_validation.py scripts/archive/
git mv test_kant_page2_debug.py scripts/archive/
```

The `scripts/debugging/`, `scripts/validation/`, and `scripts/archive/` directories already exist.

After moving, verify no Python files remain at repo root:
```bash
ls *.py 2>/dev/null  # should return nothing
```

**Do NOT** update any internal imports or file path references within these scripts — they are standalone debug/validation scripts not imported by production or test code. If any script has hardcoded relative paths to test_files/, those paths will still work when scripts are run from the project root (`python scripts/debugging/debug_foo.py`).
  </action>
  <verify>
1. `ls *.py 2>/dev/null` from repo root — no output (all .py files moved)
2. `ls scripts/debugging/debug_*.py | wc -l` — should be at least 7 (the ones we moved + any pre-existing)
3. `ls scripts/archive/test_*.py | wc -l` — should show at least 2
4. `ls scripts/validation/multi_corpus_validation.py` — file exists
5. `git status` — shows renames, no deletions without corresponding additions
  </verify>
  <done>No Python files at repo root. All 10 files relocated to scripts/ subdirectories with git history preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Split CI into fast and full test jobs</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Replace the current single `test` job with two jobs: `test-fast` (every PR) and `test-full` (push to master + manual trigger).

Update `.github/workflows/ci.yml` to:

```yaml
name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      full_suite:
        description: 'Run full test suite including slow tests'
        type: boolean
        default: false

jobs:
  test-fast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: astral-sh/setup-uv@v4
      - run: npm ci
      - run: uv sync
      - run: npm run build
      - run: node --experimental-vm-modules node_modules/jest/bin/jest.js
      - run: uv run pytest -m "not slow and not integration" --benchmark-disable

  test-full:
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.full_suite == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: astral-sh/setup-uv@v4
      - run: npm ci
      - run: uv sync
      - run: npm run build
      - run: node --experimental-vm-modules node_modules/jest/bin/jest.js
      - run: uv run pytest

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: astral-sh/setup-uv@v4
      - run: npm ci
      - run: uv sync
      - run: npm audit --omit=dev --audit-level=high
      - run: uv run pip-audit || true
```

Key design decisions:
1. **test-fast** runs on BOTH push and PR — always gives fast feedback.
2. **test-full** runs only on push to master OR manual workflow_dispatch with full_suite=true. This means PRs get fast feedback, but merges to master run the full suite as a safety net.
3. **`--benchmark-disable`** in fast job skips pytest-benchmark overhead without removing benchmark-decorated tests from collection.
4. **audit** job unchanged — runs independently on all triggers.
5. Jest runs in BOTH jobs — JS tests are always fast.
  </action>
  <verify>
1. Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('Valid YAML')"` (if pyyaml available) OR `node -e "const fs=require('fs'); console.log('File exists:', fs.existsSync('.github/workflows/ci.yml'))"`
2. `grep -c 'test-fast\|test-full' .github/workflows/ci.yml` — should be 2+ (both job names present)
3. `grep 'not slow and not integration' .github/workflows/ci.yml` — should match (fast path uses marker filter)
4. `grep 'workflow_dispatch' .github/workflows/ci.yml` — should match (manual trigger available)
5. Local fast test timing: `time uv run pytest -m "not slow and not integration" --benchmark-disable --tb=short -q` — under 30 seconds
  </verify>
  <done>CI has test-fast (every PR, fast markers only) and test-full (push to master + manual trigger, all tests) jobs. workflow_dispatch input allows manual full suite runs.</done>
</task>

</tasks>

<verification>
1. `ls *.py 2>/dev/null` — empty (no Python files at repo root)
2. `grep "test-fast" .github/workflows/ci.yml` — present
3. `grep "test-full" .github/workflows/ci.yml` — present
4. `grep 'not slow and not integration' .github/workflows/ci.yml` — present
5. `time uv run pytest -m "not slow and not integration" --benchmark-disable --tb=short -q` — under 30 seconds
6. `uv run pytest` — full suite still passes
</verification>

<success_criteria>
- Zero Python files at repo root
- CI YAML has test-fast and test-full jobs
- test-fast uses `-m "not slow and not integration"` marker filter
- test-full runs on push-to-master and manual dispatch
- Fast test timing confirmed under 30 seconds locally
</success_criteria>

<output>
After completion, create `.planning/phases/14-test-infrastructure/14-03-SUMMARY.md`
</output>
