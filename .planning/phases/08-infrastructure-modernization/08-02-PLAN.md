---
phase: 08-infrastructure-modernization
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - lib/python_bridge.py
  - lib/client_manager.py
  - lib/advanced_search.py
  - lib/eapi_client.py
autonomous: true

must_haves:
  truths:
    - "Downloads work through EAPIClient without AsyncZlib"
    - "No AsyncZlib references remain in production code"
    - "Integration test proves download works before legacy removal"
  artifacts:
    - path: "lib/eapi_client.py"
      provides: "download_file method on EAPIClient"
      contains: "download_file"
    - path: "lib/python_bridge.py"
      provides: "download_book uses EAPIClient directly"
      contains: "get_eapi_client"
  key_links:
    - from: "lib/python_bridge.py"
      to: "lib/eapi_client.py"
      via: "download_book calls eapi.download_file"
      pattern: "eapi.*download"
    - from: "lib/python_bridge.py"
      to: "lib/client_manager.py"
      via: "no longer imports (removed dependency)"
      pattern: "client_manager"
---

<objective>
Remove AsyncZlib legacy download client by extracting download logic into EAPIClient, then removing all AsyncZlib references.

Purpose: AsyncZlib is a thin wrapper that already delegates to EAPIClient internally. Removing it simplifies the download path, eliminates technical debt, and makes the codebase EAPI-only.
Output: EAPIClient handles downloads directly, client_manager.py gutted or removed, no AsyncZlib imports in production code.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-infrastructure-modernization/08-RESEARCH.md
@lib/python_bridge.py
@lib/client_manager.py
@lib/eapi_client.py
@lib/advanced_search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download_file to EAPIClient + integration test</name>
  <files>lib/eapi_client.py, __tests__/python/test_eapi_download.py</files>
  <action>
CRITICAL: The integration test MUST pass BEFORE removing AsyncZlib (pitfall P-01 from research).

1. Read `lib/python_bridge.py` function `download_book()` (around line 455) and `zlibrary/src/zlibrary/libasync.py` method `download_book()` to understand the current download flow:
   - `AsyncZlib.download_book()` calls `self._eapi.get_download_link(id, hash)` to get URL
   - Then uses httpx to download the file with cookies from `self._eapi`
   - Returns the saved file path

2. Add a `download_file(self, book_id, book_hash, output_dir, filename=None)` method to `EAPIClient` in `lib/eapi_client.py`:
   - Call `self.get_download_link(book_id, book_hash)` to get the download URL
   - Use httpx async client with `self._cookies` or session cookies to download the file
   - Save to `output_dir/filename` (derive filename from Content-Disposition header or URL if not provided)
   - Return the absolute path to the saved file
   - Handle: network errors, empty responses, cookie auth failures

3. Write a test in `__tests__/python/test_eapi_download.py` that mocks the EAPI HTTP responses and verifies:
   - `download_file` calls `get_download_link` then downloads the URL
   - File is saved to the correct path
   - Errors are handled gracefully

4. Run `uv run pytest __tests__/python/test_eapi_download.py -v` to verify.
  </action>
  <verify>
- `uv run pytest __tests__/python/test_eapi_download.py -v` passes
- `grep "download_file" lib/eapi_client.py` shows the new method
  </verify>
  <done>EAPIClient has a tested download_file method that can replace AsyncZlib.download_book.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire python_bridge + remove AsyncZlib references</name>
  <files>lib/python_bridge.py, lib/client_manager.py, lib/advanced_search.py</files>
  <action>
1. In `lib/python_bridge.py`, update `download_book()` function:
   - Replace `client_manager.get_default_client()` / `zlib.download_book()` with direct `get_eapi_client()` + `eapi.download_file()` call
   - The `get_eapi_client()` function already exists in python_bridge.py for search operations
   - Preserve the existing error handling, retry logic, and RAG processing flow
   - Keep the same return format (file path string)

2. In `lib/advanced_search.py`, check for AsyncZlib imports:
   - If it imports AsyncZlib for any purpose, replace with EAPIClient equivalent
   - If it uses `client_manager`, rewire to use `get_eapi_client()`

3. In `lib/client_manager.py`:
   - If no other module imports it (check with `grep -r "client_manager" lib/ --include="*.py"`), add a deprecation comment or remove entirely
   - If other modules still import it, keep a minimal version that wraps EAPIClient

4. Search for remaining AsyncZlib references: `grep -rn "AsyncZlib\|from zlibrary import\|import zlibrary" lib/ --include="*.py"`
   - Remove or replace each reference in production code
   - Test files can keep AsyncZlib references if needed for comparison testing

5. Run full test suite:
   - `uv run pytest` — all Python tests pass
   - `npm test` — all Jest tests pass
   - `npm run build` — TypeScript compiles

6. Verify no AsyncZlib in production: `grep -rn "AsyncZlib" lib/ --include="*.py"` should return nothing (or only deprecation comments in client_manager.py).
  </action>
  <verify>
- `uv run pytest` all pass
- `npm test` all pass
- `grep -rn "AsyncZlib" lib/ --include="*.py"` returns zero production references (allow comments about deprecation)
- `grep -rn "get_default_client\|from zlibrary" lib/python_bridge.py` returns nothing
  </verify>
  <done>All downloads route through EAPIClient.download_file. No AsyncZlib references in production code. All tests pass.</done>
</task>

</tasks>

<verification>
- `grep -rn "AsyncZlib" lib/ --include="*.py" | grep -v "#" | grep -v "test"` returns empty
- `uv run pytest && npm test` both green
- Download path: python_bridge.download_book → eapi_client.download_file (no AsyncZlib in chain)
</verification>

<success_criteria>
Downloads work through EAPIClient only. Zero AsyncZlib references in production lib/ code. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/08-infrastructure-modernization/08-02-SUMMARY.md`
</output>
