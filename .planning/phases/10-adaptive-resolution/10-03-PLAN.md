---
phase: 10-adaptive-resolution
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - lib/rag/ocr/recovery.py
  - lib/rag/quality/ocr_stage.py
  - lib/rag/orchestrator_pdf.py
  - lib/rag/resolution/__init__.py
  - __tests__/python/test_adaptive_integration.py
autonomous: true

must_haves:
  truths:
    - "PDF processing uses adaptive DPI by default (no opt-in flag)"
    - "Text-heavy pages with 10-12pt body text render at 150-200 DPI instead of 300"
    - "Footnote regions re-render at higher DPI independently of page default"
    - "Scanned PDFs fall back to fixed 300 DPI"
    - "Per-page DPI value appears in output metadata"
    - "Low-confidence DPI decisions logged as warnings"
    - "All existing tests still pass (no regressions)"
  artifacts:
    - path: "lib/rag/ocr/recovery.py"
      provides: "OCR recovery accepting adaptive DPI"
      contains: "dpi_decision"
    - path: "lib/rag/quality/ocr_stage.py"
      provides: "OCR quality stage accepting adaptive DPI"
      contains: "dpi_decision"
    - path: "lib/rag/orchestrator_pdf.py"
      provides: "PDF orchestrator with adaptive resolution pipeline"
      contains: "analyze_document_fonts"
    - path: "__tests__/python/test_adaptive_integration.py"
      provides: "Integration tests for adaptive DPI pipeline"
  key_links:
    - from: "lib/rag/orchestrator_pdf.py"
      to: "lib/rag/resolution/analyzer.py"
      via: "calls analyze_document_fonts before OCR"
      pattern: "analyze_document_fonts"
    - from: "lib/rag/ocr/recovery.py"
      to: "lib/rag/resolution/models.py"
      via: "accepts DPIDecision instead of hardcoded 300"
      pattern: "dpi_decision\\.dpi|page_dpi"
    - from: "lib/rag/quality/ocr_stage.py"
      to: "lib/rag/resolution/models.py"
      via: "accepts DPIDecision instead of hardcoded 300"
      pattern: "dpi_decision\\.dpi|page_dpi"
---

<objective>
Wire adaptive resolution into the PDF processing pipeline, replacing hardcoded `dpi=300`.

Purpose: This is the integration plan that makes adaptive DPI the default behavior. After this plan, every PDF processed through the pipeline gets per-page DPI optimization automatically.
Output: Modified orchestrator, recovery, and ocr_stage with adaptive DPI; integration tests proving end-to-end behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-adaptive-resolution/10-RESEARCH.md
@.planning/phases/10-adaptive-resolution/10-01-SUMMARY.md
@.planning/phases/10-adaptive-resolution/10-02-SUMMARY.md
@lib/rag/ocr/recovery.py
@lib/rag/quality/ocr_stage.py
@lib/rag/orchestrator_pdf.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire adaptive DPI into OCR recovery and quality stage</name>
  <files>
    lib/rag/ocr/recovery.py
    lib/rag/quality/ocr_stage.py
  </files>
  <action>
    Modify `run_ocr_on_pdf` in recovery.py (line ~279) and the OCR function in ocr_stage.py (line ~116):

    1. Add optional `page_dpi_map: dict[int, DPIDecision] = None` parameter to functions that currently hardcode `dpi=300`
    2. Replace `pix = page.get_pixmap(dpi=300)` with:
       ```python
       dpi = 300  # default fallback
       if page_dpi_map and page_num in page_dpi_map:
           dpi = page_dpi_map[page_num].dpi
       pix = page.get_pixmap(dpi=dpi)
       ```
    3. Add DPI used to any per-page metadata/logging
    4. Import DPIDecision from lib.rag.resolution.models
    5. Do NOT change function signatures in breaking ways â€” page_dpi_map is optional with None default

    Keep the change minimal. The existing logic stays the same; only the DPI source changes.
  </action>
  <verify>
    ```bash
    uv run pytest __tests__/python/ -k "test_ocr or test_recovery" -v
    ```
    Existing OCR tests pass (they won't provide page_dpi_map, so default 300 is used).
  </verify>
  <done>recovery.py and ocr_stage.py accept optional page_dpi_map; without it, behavior is identical to before (300 DPI)</done>
</task>

<task type="auto">
  <name>Task 2: Wire adaptive analysis into PDF orchestrator + integration tests</name>
  <files>
    lib/rag/orchestrator_pdf.py
    lib/rag/resolution/__init__.py
    __tests__/python/test_adaptive_integration.py
  </files>
  <action>
    Modify orchestrator_pdf.py to insert adaptive resolution analysis:

    1. After document quality detection (detect_pdf_quality) and before page processing loop:
       ```python
       from lib.rag.resolution.analyzer import analyze_document_fonts
       from lib.rag.resolution.models import DPIDecision, DPI_DEFAULT

       # Skip adaptive DPI for scanned PDFs
       if quality_result.is_scanned:
           page_dpi_map = {}  # empty = use default 300 everywhere
           logger.info("Scanned PDF detected, using fixed DPI 300")
       else:
           page_dpi_map = analyze_document_fonts(pdf_path)
           logger.info(f"Adaptive DPI: analyzed {len(page_dpi_map)} pages")
       ```
    2. Pass page_dpi_map to OCR functions (recovery.run_ocr_on_pdf, ocr_stage functions)
    3. Add per-page DPI to output metadata:
       ```python
       metadata["page_dpi"] = {
           page_num: {"dpi": analysis.page_dpi.dpi, "confidence": analysis.page_dpi.confidence}
           for page_num, analysis in page_dpi_map.items()
       }
       ```
    4. Log warnings for low-confidence pages (confidence < 0.5)
    5. Update lib/rag/resolution/__init__.py to export all public symbols

    Create integration test __tests__/python/test_adaptive_integration.py:
    - Test that a text-layer PDF gets adaptive DPI (not all 300)
    - Test that a mock scanned PDF falls back to 300
    - Test that page_dpi appears in output metadata
    - Test that existing PDF processing still works (regression)
    - Use test_files/ fixtures if available, or create minimal test PDFs with PyMuPDF
  </action>
  <verify>
    ```bash
    # Integration tests
    uv run pytest __tests__/python/test_adaptive_integration.py -v

    # Full regression
    uv run pytest __tests__/python/ -v

    # Verify no hardcoded dpi=300 remains in modified files
    grep -n "dpi=300" lib/rag/ocr/recovery.py lib/rag/quality/ocr_stage.py lib/rag/orchestrator_pdf.py
    # Should only appear in comments or fallback defaults, not as the primary rendering path
    ```
  </verify>
  <done>
    - orchestrator_pdf.py calls analyze_document_fonts before OCR
    - Scanned PDFs use fixed 300 DPI (detected via quality pipeline)
    - Text-layer PDFs get per-page adaptive DPI
    - Per-page DPI appears in output metadata
    - Low-confidence pages logged as warnings
    - All existing tests pass (no regressions)
  </done>
</task>

</tasks>

<verification>
```bash
# Full test suite
cd /home/rookslog/workspace/projects/zlibrary-mcp && uv run pytest __tests__/python/ -v

# Verify adaptive resolution module complete
uv run python -c "
from lib.rag.resolution import compute_optimal_dpi, analyze_page_fonts, analyze_document_fonts
from lib.rag.resolution.renderer import render_page_adaptive, render_region
from lib.rag.resolution.models import DPIDecision, PageAnalysis, RegionDPI
print('All adaptive resolution exports OK')
"

# Verify no regressions in existing pipeline
uv run pytest __tests__/python/ -v --tb=short
```
</verification>

<success_criteria>
- `grep "dpi=300" lib/rag/ocr/recovery.py` shows only fallback/comment usage
- PDF orchestrator calls analyze_document_fonts before page processing
- Output metadata contains page_dpi dict
- Scanned PDFs detected and use fixed 300 DPI
- All existing Python tests pass
- Integration tests verify adaptive DPI end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/10-adaptive-resolution/10-03-SUMMARY.md`
</output>
