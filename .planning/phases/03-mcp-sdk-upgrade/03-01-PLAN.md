---
phase: 03-mcp-sdk-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "npm list @modelcontextprotocol/sdk shows 1.25.x+"
    - "npm run build succeeds without errors or OOM"
    - "All 14 tools are registered via McpServer.registerTool()"
    - "npm audit shows zero high/critical vulnerabilities"
  artifacts:
    - path: "src/index.ts"
      provides: "MCP server using McpServer class with registerTool() for all tools"
      contains: "McpServer"
    - path: "package.json"
      provides: "SDK 1.25.x+ dependency and engines.node >=18"
      contains: "@modelcontextprotocol/sdk"
  key_links:
    - from: "src/index.ts"
      to: "@modelcontextprotocol/sdk/server/mcp.js"
      via: "import McpServer"
      pattern: "McpServer.*server/mcp"
    - from: "src/index.ts"
      to: "src/lib/zlibrary-api.ts"
      via: "tool handler calls"
      pattern: "zlibraryApi\\."
---

<objective>
Upgrade MCP SDK from 1.8.0 to latest stable (1.25.3+) and rewrite src/index.ts to use the McpServer high-level API with registerTool() for all tools.

Purpose: Resolves 2 high-severity npm audit vulnerabilities, modernizes the MCP server to use the recommended API, and eliminates ~250 lines of boilerplate (manual tool registry, zodToJsonSchema, request handler wiring).

Output: Working MCP server on latest SDK that builds cleanly. Tests updated separately in plan 03-02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-sdk-upgrade/03-RESEARCH.md
@src/index.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade SDK dependency and bump Node engine</name>
  <files>package.json, package-lock.json</files>
  <action>
1. Run `npm install @modelcontextprotocol/sdk@latest` to upgrade from 1.8.0 to latest stable (expected 1.25.3+).
2. In package.json, update `engines.node` from `">=14"` (or whatever current value) to `">=18"`.
3. Check if `zod-to-json-schema` is still needed after migration — if the src/index.ts rewrite (Task 2) removes all `zodToJsonSchema` usage, run `npm uninstall zod-to-json-schema`. Do NOT remove it yet if unsure — Task 2 will clarify.
4. Run `npm audit` to confirm the 2 high-severity vulnerabilities (GHSA-w48q-cv73-mx4w, GHSA-8r9q-7v3j-jr4g) are resolved.
  </action>
  <verify>
- `npm list @modelcontextprotocol/sdk` shows 1.25.x+
- `npm audit --audit-level=high` exits with code 0
- `node -e "require('./package.json').engines.node"` shows `>=18`
  </verify>
  <done>SDK upgraded to latest stable, Node engine requirement bumped to >=18, zero high/critical npm audit vulnerabilities.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite src/index.ts from Server to McpServer</name>
  <files>src/index.ts</files>
  <action>
Rewrite src/index.ts to use `McpServer` from `@modelcontextprotocol/sdk/server/mcp.js`. This is a major but mechanical rewrite. Follow the research patterns exactly.

**Import changes:**
- Replace `import { Server } from '@modelcontextprotocol/sdk/server/index.js'` with `import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'`
- Keep `import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js'`
- Remove imports: `ListToolsRequestSchema`, `CallToolRequestSchema`, `ListResourcesRequestSchema`, `ListPromptsRequestSchema` from `@modelcontextprotocol/sdk/types.js`
- Remove `zodToJsonSchema` import if present

**Server construction:**
- Replace `new Server({name, version}, {capabilities: {...}})` with `new McpServer({name: 'zlibrary-mcp', version: getPackageVersion()})`
- No manual capabilities object needed — McpServer auto-manages from registered tools

**Tool registration — convert ALL tools to registerTool():**
For each tool currently in the tool registry, call:
```typescript
server.registerTool(
    'tool_name',
    {
        description: '...',
        inputSchema: {
            // Plain object of Zod types, NOT z.object()
            // Use the existing Zod schema's .shape if schemas are defined as z.object()
            param1: z.string().describe('...'),
            // ...
        }
    },
    async (args) => {
        // Move the existing handler logic here
        // Return { content: [{ type: 'text', text: '...' }] }
        // For errors: return { content: [{ type: 'text', text: errorMsg }], isError: true }
    }
);
```

**Critical anti-patterns to avoid:**
- Do NOT pass `z.object({...})` to inputSchema — pass the plain inner object or use `.shape`
- Do NOT call `zodToJsonSchema()` — McpServer handles this internally
- Do NOT create a manual tool registry map — each registerTool() call is self-contained
- Do NOT mix Server and McpServer — use only McpServer

**Remove boilerplate:**
- Remove the `ToolDefinition` / `ToolRegistryEntry` custom interfaces
- Remove the `tools` capability object / `generateToolsCapability()` function
- Remove `setRequestHandler(ListToolsRequestSchema, ...)` handler
- Remove `setRequestHandler(CallToolRequestSchema, ...)` handler
- Remove `setRequestHandler(ListResourcesRequestSchema, ...)` handler
- Remove `setRequestHandler(ListPromptsRequestSchema, ...)` handler

**Preserve:**
- All tool handler logic (search, download, RAG processing etc.) — just move into registerTool callbacks
- Error handling patterns (try/catch → return isError content)
- The `getPackageVersion()` helper function
- The `ensureAuthenticated()` helper function
- The `zlibraryApi` instance and its initialization
- The StdioServerTransport connection at the end
- All Zod schema definitions (reuse them via .shape or inline)

**After rewrite:**
- Run `npm run build` to verify TypeScript compilation succeeds without errors
- Grep src/index.ts for `zodToJsonSchema` — if no references remain, go back to Task 1 and remove `zod-to-json-schema` dependency

**Tool count:** The CONTEXT.md says 14 tools. Verify all are registered by counting `registerTool(` calls. If current code has a different count, match what exists — do not add or remove tools.
  </action>
  <verify>
- `npm run build` succeeds (exit code 0, no TypeScript errors)
- `grep -c "registerTool" dist/index.js` shows the expected tool count (should match current tool count)
- `grep "zodToJsonSchema" src/index.ts` returns nothing (removed)
- `grep "ListToolsRequestSchema\|CallToolRequestSchema" src/index.ts` returns nothing (removed)
- `grep "McpServer" src/index.ts` returns at least one match
  </verify>
  <done>src/index.ts uses McpServer with registerTool() for all tools. TypeScript builds cleanly. Manual tool registry and zodToJsonSchema removed. All existing tool handler logic preserved.</done>
</task>

</tasks>

<verification>
1. `npm list @modelcontextprotocol/sdk` → 1.25.x+
2. `npm audit --audit-level=high` → exits 0
3. `npm run build` → succeeds (no errors, no OOM)
4. `grep -c "registerTool" src/index.ts` → matches expected tool count
5. `grep "Server\b" src/index.ts` → only McpServer, not bare Server
6. Python tests still pass: `uv run pytest` (shouldn't be affected but verify)
</verification>

<success_criteria>
- SDK is 1.25.x+ with zero high/critical vulnerabilities
- src/index.ts uses McpServer class exclusively
- All tools registered via registerTool()
- TypeScript builds without errors
- No zodToJsonSchema or manual request handler boilerplate remains
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-sdk-upgrade/03-01-SUMMARY.md`
</output>
